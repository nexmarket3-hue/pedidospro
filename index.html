<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="theme-color" content="#080b10"/>
<meta name="description" content="PedidosPro ‚Äì Sistema de pedidos, facturaci√≥n y rutas GPS para empresas"/>
<!-- PWA Manifest inline -->
<script>
const manifest = {
  name: "PedidosPro",
  short_name: "PedidosPro",
  description: "Sistema de pedidos, facturaci√≥n y rutas GPS",
  start_url: "./",
  display: "standalone",
  background_color: "#080b10",
  theme_color: "#00d4ff",
  orientation: "portrait",
  icons: [
    { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='32' fill='%23080b10'/><text y='130' x='30' font-size='120'>üöÄ</text></svg>", sizes: "192x192", type: "image/svg+xml" },
    { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='80' fill='%23080b10'/><text y='360' x='60' font-size='320'>üöÄ</text></svg>", sizes: "512x512", type: "image/svg+xml" }
  ]
};
const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
const murl = URL.createObjectURL(blob);
const ml = document.createElement('link');
ml.rel='manifest'; ml.href=murl;
document.head.appendChild(ml);
</script>
<title>PedidosPro v7 ¬∑ Firebase</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Chart.js for reports -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyAPQOAEKCECvXnLDBVaqLPDylor9Oii_L0",authDomain:"nex-market-9f644.firebaseapp.com",projectId:"nex-market-9f644",storageBucket:"nex-market-9f644.firebasestorage.app",messagingSenderId:"1006788939882",appId:"1:1006788939882:web:f14c72f1cc0358fc763a13"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
db.enablePersistence({synchronizeTabs:true}).catch(()=>{});
console.log("Firebase PedidosPro conectado");
</script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#080b10;--surface:#0f1319;--card:#161c26;--card2:#1c2335;--border:#232d42;
  --accent:#00d4ff;--accent2:#0099bb;--green:#00e676;--green2:#00c853;
  --orange:#ff9800;--red:#ff3d57;--purple:#7c4dff;--teal:#00bfa5;
  --text:#e8edf5;--muted:#5a6a80;--muted2:#8899aa;
}
body{background:var(--bg);color:var(--text);font-family:'Space Grotesk',sans-serif;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

#app{display:flex;flex-direction:column;min-height:100vh;max-width:480px;margin:0 auto;position:relative}
.page{display:none;flex:1;flex-direction:column;padding:1rem;gap:.875rem;overflow-y:auto;padding-bottom:90px}
.page.active{display:flex}

/* HEADER */
.header{background:rgba(15,19,25,.97);border-bottom:1px solid var(--border);padding:.8rem 1rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;backdrop-filter:blur(12px)}
.header-brand{display:flex;align-items:center;gap:.5rem}
.header-logo{width:30px;height:30px;background:linear-gradient(135deg,var(--accent),var(--purple));border-radius:.5rem;display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:700;color:#000;flex-shrink:0}
.header-title{font-size:.95rem;font-weight:700}
.header-sub{font-size:.6rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
.header-right{display:flex;align-items:center;gap:.5rem}
.gps-pill{background:var(--card);border:1px solid var(--border);border-radius:2rem;padding:.2rem .55rem;font-size:.6rem;display:flex;align-items:center;gap:.3rem;color:var(--muted)}
.gps-dot{width:6px;height:6px;border-radius:50%;background:var(--red);flex-shrink:0}
.gps-dot.on{background:var(--green);animation:pulse-g 2s infinite}
@keyframes pulse-g{0%,100%{opacity:1}50%{opacity:.5}}
.btn-logout{background:none;border:1px solid var(--border);border-radius:.4rem;padding:.25rem .6rem;color:var(--muted);cursor:pointer;font-size:.7rem;font-family:'Space Grotesk',sans-serif;transition:all .2s}
.btn-logout:hover{border-color:var(--red);color:var(--red)}

/* NAV */
.nav{display:flex;background:rgba(15,19,25,.98);border-top:1px solid var(--border);position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;z-index:50;backdrop-filter:blur(12px)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;padding:.55rem .2rem .45rem;background:none;border:none;cursor:pointer;color:var(--muted);gap:.12rem;transition:color .2s;position:relative}
.nav-btn.active{color:var(--accent)}
.nav-btn.active::after{content:'';position:absolute;bottom:-1px;left:50%;transform:translateX(-50%);width:18px;height:2px;background:var(--accent);border-radius:2px}
.nav-icon{font-size:1.1rem;line-height:1}
.nav-label{font-size:.52rem;text-transform:uppercase;letter-spacing:.07em;font-weight:600}

/* LOGIN */
#login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:1.5rem;background:var(--bg);position:relative;overflow:hidden}
#login-screen::before{content:'';position:absolute;width:500px;height:500px;background:radial-gradient(circle,rgba(0,212,255,.05),transparent 70%);top:50%;left:50%;transform:translate(-50%,-60%);pointer-events:none}
.login-glow{width:72px;height:72px;background:linear-gradient(135deg,var(--accent),var(--purple));border-radius:1.25rem;display:flex;align-items:center;justify-content:center;font-size:2rem;margin-bottom:1rem;box-shadow:0 0 50px rgba(0,212,255,.25)}
.login-title{font-size:2rem;font-weight:700;margin-bottom:.1rem}
.login-badge{background:linear-gradient(90deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.login-sub{color:var(--muted);margin-bottom:2rem;font-size:.82rem;text-align:center}
.login-card{background:var(--surface);border:1px solid var(--border);border-radius:1.5rem;padding:1.5rem;width:100%;max-width:340px;box-shadow:0 0 80px rgba(0,0,0,.6)}
.user-list{display:flex;flex-direction:column;gap:.55rem;margin-bottom:1.25rem}
.user-btn{background:var(--card);border:2px solid var(--border);border-radius:.875rem;padding:.8rem;cursor:pointer;text-align:left;color:var(--text);width:100%;transition:all .2s;display:flex;align-items:center;gap:.7rem}
.user-btn:active,.user-btn.sel{border-color:var(--accent);background:rgba(0,212,255,.06)}
.u-avatar{width:38px;height:38px;border-radius:.6rem;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.95rem;flex-shrink:0}
.u-av-admin{background:linear-gradient(135deg,var(--accent),var(--purple));color:#000}
.u-av-vendor{background:linear-gradient(135deg,var(--green),#009688);color:#000}
.u-av-super{background:linear-gradient(135deg,var(--orange),var(--red));color:#000}
.user-name{font-weight:600;font-size:.875rem}
.user-rol{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:.1rem}
.login-err{color:var(--red);text-align:center;font-size:.8rem;animation:shake .3s;margin-top:.35rem}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.login-input-wrap{position:relative}
.login-show-pw{position:absolute;right:.75rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:.9rem;padding:.2rem}

/* TRIAL BANNER */
.trial-banner{background:linear-gradient(90deg,rgba(255,152,0,.12),rgba(255,61,87,.08));border:1px solid rgba(255,152,0,.3);border-radius:.875rem;padding:.75rem;display:flex;align-items:center;gap:.6rem;font-size:.8rem}
.trial-icon{font-size:1.2rem;flex-shrink:0}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:1.125rem;padding:1.125rem}
.card2{background:var(--card);border:1px solid var(--border);border-radius:.875rem;padding:.875rem}
.card-title{font-weight:700;font-size:.875rem;margin-bottom:.875rem;display:flex;align-items:center;gap:.4rem}
.card-title-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:.875rem}

/* STATS */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.stats-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.55rem}
.stat{background:var(--card);border:1px solid var(--border);border-radius:.875rem;padding:.875rem;overflow:hidden;position:relative}
.stat::before{content:'';position:absolute;inset:0;opacity:.04;pointer-events:none}
.stat-val{font-size:1.25rem;font-weight:700;margin-bottom:.12rem;font-family:'JetBrains Mono',monospace}
.stat-lbl{font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;font-weight:600}
.stat-delta{font-size:.6rem;margin-top:.2rem}
.c-accent{color:var(--accent)}.c-green{color:var(--green)}.c-orange{color:var(--orange)}.c-purple{color:var(--purple)}.c-red{color:var(--red)}.c-teal{color:var(--teal)}

/* BUTTONS */
.btn{border:none;border-radius:.7rem;padding:.65rem 1rem;font-family:'Space Grotesk',sans-serif;font-weight:600;cursor:pointer;font-size:.85rem;display:inline-flex;align-items:center;justify-content:center;gap:.4rem;transition:all .18s;text-decoration:none}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:active{background:var(--accent2);transform:scale(.97)}
.btn-secondary{background:var(--card);color:var(--text);border:1px solid var(--border)}
.btn-secondary:active{border-color:var(--accent)}
.btn-danger{background:rgba(255,61,87,.12);color:var(--red);border:1px solid rgba(255,61,87,.25)}
.btn-success{background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.25)}
.btn-wa{background:#25D366;color:#fff}
.btn-purple{background:rgba(124,77,255,.12);color:var(--purple);border:1px solid rgba(124,77,255,.25)}
.btn-orange{background:rgba(255,152,0,.12);color:var(--orange);border:1px solid rgba(255,152,0,.25)}
.btn-teal{background:rgba(0,191,165,.12);color:var(--teal);border:1px solid rgba(0,191,165,.25)}
.btn-sm{padding:.32rem .65rem;font-size:.7rem;border-radius:.45rem}
.btn-xs{padding:.18rem .45rem;font-size:.62rem;border-radius:.35rem}
.btn-full{width:100%}
.btn-row{display:flex;gap:.55rem}

/* INPUTS */
.input{background:var(--card);border:1px solid var(--border);border-radius:.7rem;padding:.65rem .875rem;color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:.875rem;width:100%;outline:none;transition:border .2s}
.input:focus{border-color:var(--accent)}
.input::placeholder{color:var(--muted)}
select.input{appearance:none;cursor:pointer}
textarea.input{resize:vertical;min-height:65px}
.label{font-size:.62rem;color:var(--muted2);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.28rem;display:block;font-weight:600}
.field{display:flex;flex-direction:column;gap:.22rem}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.form-stack{display:flex;flex-direction:column;gap:.7rem}

/* TABS */
.tabs{display:flex;background:var(--card);border-radius:.875rem;padding:.18rem;gap:.12rem;border:1px solid var(--border)}
.tab{flex:1;padding:.45rem .25rem;border:none;border-radius:.625rem;background:none;color:var(--muted);font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:.67rem;cursor:pointer;transition:all .2s;white-space:nowrap}
.tab.active{background:var(--surface);color:var(--accent);border:1px solid var(--border)}

/* PRODUCT GRID */
.prod-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.prod-card{background:var(--card);border:2px solid var(--border);border-radius:.875rem;padding:.8rem;cursor:pointer;transition:all .2s;position:relative}
.prod-card.sel{border-color:var(--accent);background:rgba(0,212,255,.06)}
.prod-card.low-stock{border-color:rgba(255,152,0,.4)}
.prod-emoji{font-size:1.6rem;margin-bottom:.3rem}
.prod-name{font-weight:700;font-size:.8rem;margin-bottom:.15rem}
.prod-price{color:var(--accent);font-weight:600;font-size:.78rem;font-family:'JetBrains Mono',monospace}
.prod-stock{font-size:.6rem;color:var(--muted);margin-bottom:.45rem}
.prod-badge{position:absolute;top:.35rem;right:.35rem;background:var(--accent);color:#000;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:800}
.qty-ctrl{display:flex;align-items:center;gap:.35rem}
.qty-btn{background:var(--surface);border:1px solid var(--border);border-radius:.35rem;width:26px;height:26px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.95rem;color:var(--text);transition:all .15s}
.qty-btn:active{border-color:var(--accent);color:var(--accent)}
.qty-val{font-weight:700;font-size:.875rem;min-width:20px;text-align:center;font-family:'JetBrains Mono',monospace}

/* ORDER ITEMS */
.order-item{display:flex;align-items:center;justify-content:space-between;padding:.55rem 0;border-bottom:1px solid var(--border)}
.order-item:last-child{border-bottom:none}
.oi-name{font-weight:500;font-size:.85rem}
.oi-detail{font-size:.65rem;color:var(--muted);margin-top:.08rem}
.order-total{background:var(--card);border-radius:.875rem;padding:.875rem;display:flex;justify-content:space-between;align-items:center;margin-top:.5rem;border:1px solid var(--border)}
.ot-lbl{color:var(--muted);font-size:.8rem}
.ot-val{font-weight:800;font-size:1.2rem;color:var(--accent);font-family:'JetBrains Mono',monospace}

/* PED CARDS */
.ped-card{background:var(--card);border:1px solid var(--border);border-radius:.875rem;padding:.875rem;cursor:pointer;transition:border .18s}
.ped-card:active{border-color:var(--accent)}
.badge{padding:.18rem .5rem;border-radius:2rem;font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.b-pend{background:rgba(255,152,0,.12);color:var(--orange)}
.b-done{background:rgba(0,230,118,.12);color:var(--green)}
.b-cancel{background:rgba(255,61,87,.12);color:var(--red)}
.b-fact{background:rgba(0,212,255,.12);color:var(--accent)}
.b-route{background:rgba(124,77,255,.12);color:var(--purple)}

/* SEARCH */
.search-wrap{position:relative}
.search-ico{position:absolute;left:.75rem;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.85rem}
.search-wrap .input{padding-left:2.1rem}

/* CHIPS */
.chips{display:flex;flex-wrap:wrap;gap:.35rem}
.chip{background:var(--card);border:1px solid var(--border);border-radius:2rem;padding:.22rem .65rem;font-size:.68rem;font-weight:600;cursor:pointer;color:var(--muted);transition:all .2s}
.chip.active{background:rgba(0,212,255,.1);border-color:var(--accent);color:var(--accent)}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-top-left-radius:1.5rem;border-top-right-radius:1.5rem;padding:1.25rem;width:100%;max-width:480px;max-height:92vh;overflow-y:auto}
.modal-handle{width:32px;height:3px;background:var(--border);border-radius:3px;margin:0 auto 1.1rem}
.modal-title{font-weight:700;font-size:1.05rem;margin-bottom:1rem}

/* ALERT */
.alert{border-radius:.75rem;padding:.7rem .875rem;font-size:.8rem;margin-bottom:.55rem}
.a-success{background:rgba(0,230,118,.07);border:1px solid rgba(0,230,118,.2);color:var(--green)}
.a-info{background:rgba(0,212,255,.05);border:1px solid rgba(0,212,255,.15);color:var(--muted2)}
.a-warn{background:rgba(255,152,0,.07);border:1px solid rgba(255,152,0,.2);color:var(--orange)}
.a-err{background:rgba(255,61,87,.07);border:1px solid rgba(255,61,87,.2);color:var(--red)}

/* MISC */
.divider{height:1px;background:var(--border);margin:.55rem 0}
.empty{text-align:center;padding:2.5rem 1rem;color:var(--muted)}
.empty-ico{font-size:2.5rem;margin-bottom:.55rem}
.text-muted{color:var(--muted)}.text-sm{font-size:.8rem}.text-xs{font-size:.65rem}
.text-accent{color:var(--accent)}.text-green{color:var(--green)}.text-orange{color:var(--orange)}.text-purple{color:var(--purple)}.text-red{color:var(--red)}.text-teal{color:var(--teal)}
.fw7{font-weight:700}.mono{font-family:'JetBrains Mono',monospace}
.mt-1{margin-top:.7rem}.mt-sm{margin-top:.4rem}
.row{display:flex;align-items:center;gap:.5rem}
.row-between{display:flex;justify-content:space-between;align-items:center}
.scroll-x{display:flex;gap:.55rem;overflow-x:auto;padding-bottom:.2rem;scrollbar-width:none}
.scroll-x::-webkit-scrollbar{display:none}
.sticky-bottom{position:sticky;bottom:0;padding:.5rem 0;background:linear-gradient(transparent,var(--bg) 35%)}

/* EMOJI PICKER */
.emoji-grid{display:flex;flex-wrap:wrap;gap:.3rem}
.emoji-opt{font-size:1.3rem;background:var(--card);border:1px solid var(--border);border-radius:.4rem;padding:.28rem .42rem;cursor:pointer;transition:all .15s}
.emoji-opt.sel{background:rgba(0,212,255,.15);border-color:var(--accent)}

/* SUCCESS */
.success-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:1.75rem 1rem;flex:1}
.success-ico{font-size:3.75rem;margin-bottom:.875rem;animation:pop .4s cubic-bezier(.17,.67,.35,1.3)}
@keyframes pop{0%{transform:scale(0)}100%{transform:scale(1)}}
.success-title{font-size:1.25rem;font-weight:700;color:var(--green);margin-bottom:.35rem}
.success-actions{display:flex;flex-direction:column;gap:.6rem;width:100%;max-width:280px}

/* GPS/ROUTE */
.route-card{background:var(--card);border:1px solid var(--border);border-radius:.875rem;padding:.875rem;margin-bottom:.55rem}
.route-stop{display:flex;gap:.7rem;margin-bottom:.7rem;align-items:flex-start}
.route-stop:last-child{margin-bottom:0}
.route-num{width:26px;height:26px;border-radius:50%;background:var(--accent);color:#000;font-weight:800;font-size:.72rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:.05rem}
.route-num.visited{background:var(--green)}
.route-num.skip{background:var(--muted);color:var(--bg)}
.route-progress{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin:.45rem 0}
.route-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:2px;transition:width .5s}

/* STOCK ALERT */
.stock-alert{background:rgba(255,152,0,.08);border:1px solid rgba(255,152,0,.25);border-radius:.7rem;padding:.6rem .75rem;display:flex;align-items:center;gap:.5rem;font-size:.78rem;color:var(--orange)}

/* CHART CONTAINER */
.chart-wrap{position:relative;height:200px;margin-top:.5rem}

/* IMPORT ZONE */
.import-zone{border:2px dashed var(--border);border-radius:1rem;padding:1.5rem;text-align:center;cursor:pointer;transition:all .25s;background:var(--card)}
.import-zone:hover,.import-zone.drag{border-color:var(--accent);background:rgba(0,212,255,.04)}
.import-zone-ico{font-size:2.2rem;margin-bottom:.5rem}
.import-zone-txt{font-size:.82rem;color:var(--muted2)}
.import-zone-sub{font-size:.7rem;color:var(--muted);margin-top:.25rem}
.import-progress{background:var(--card);border:1px solid var(--border);border-radius:.75rem;padding:.875rem;margin-top:.6rem}
.prog-bar-wrap{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin:.4rem 0}
.prog-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:3px;transition:width .3s}

/* FACTURA */
.fact-line{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.8rem}
.fact-line:last-child{border-bottom:none}
.fact-total-row{display:flex;justify-content:space-between;padding:.45rem 0;font-weight:700}

/* PWA install prompt */
.pwa-banner{background:linear-gradient(90deg,rgba(0,212,255,.1),rgba(124,77,255,.08));border:1px solid rgba(0,212,255,.2);border-radius:.875rem;padding:.75rem;display:flex;align-items:center;gap:.6rem;font-size:.78rem}

/* SUCURSALES */
.suc-card{background:var(--card);border:1px solid var(--border);border-radius:.875rem;padding:.875rem;margin-bottom:.55rem}
.suc-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

/* SWITCH */
.switch{position:relative;display:inline-block;width:38px;height:20px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:20px;transition:.3s}
.slider:before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:var(--muted);border-radius:50%;transition:.3s}
input:checked+.slider{background:rgba(0,212,255,.25);border:1px solid var(--accent)}
input:checked+.slider:before{transform:translateX(18px);background:var(--accent)}

/* CLIENTE CARD */
.cliente-card{background:var(--card);border:1px solid var(--border);border-radius:.875rem;padding:.875rem;margin-bottom:.55rem;cursor:pointer;transition:border .18s}
.cliente-card:active{border-color:var(--accent)}
.c-avatar{width:38px;height:38px;border-radius:.6rem;background:linear-gradient(135deg,var(--purple),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.95rem;color:#000;flex-shrink:0}


/* IA ASSISTANT */
.ia-fab{position:fixed;bottom:75px;right:12px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));border:none;cursor:pointer;font-size:1.4rem;box-shadow:0 4px 24px rgba(0,212,255,.45);z-index:100;display:flex;align-items:center;justify-content:center;transition:all .2s;animation:fabPulse 3s ease-in-out infinite}
@keyframes fabPulse{0%,100%{box-shadow:0 4px 24px rgba(0,212,255,.45)}50%{box-shadow:0 4px 32px rgba(0,212,255,.8),0 0 0 6px rgba(0,212,255,.12)}}
.ia-fab:active{transform:scale(.93)}
.ia-fab .ia-badge{position:absolute;top:-2px;right:-2px;background:var(--red);color:#fff;border-radius:50%;width:16px;height:16px;font-size:.55rem;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg)}
.ia-panel{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;height:88vh;background:var(--surface);border-top:1.5px solid rgba(0,212,255,.25);border-top-left-radius:1.5rem;border-top-right-radius:1.5rem;z-index:300;display:none;flex-direction:column;box-shadow:0 -12px 60px rgba(0,0,0,.7)}
.ia-panel.open{display:flex}
.ia-header{padding:.7rem 1rem .55rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem;flex-shrink:0;background:linear-gradient(135deg,rgba(0,212,255,.06),rgba(124,77,255,.04))}
.ia-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--purple));border-radius:.6rem;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;box-shadow:0 2px 8px rgba(0,212,255,.3)}
.ia-mode-toggle{display:flex;background:var(--card);border:1px solid var(--border);border-radius:.5rem;overflow:hidden;flex-shrink:0}
.ia-mode-btn{padding:.22rem .55rem;font-size:.64rem;font-weight:700;border:none;cursor:pointer;background:transparent;color:var(--muted);transition:all .15s;font-family:inherit}
.ia-mode-btn.active{background:var(--accent);color:#000}
.ia-messages{flex:1;overflow-y:auto;padding:.75rem;display:flex;flex-direction:column;gap:.5rem}
.ia-msg{max-width:88%;padding:.55rem .75rem;border-radius:.875rem;font-size:.81rem;line-height:1.48}
.ia-msg.user{background:linear-gradient(135deg,var(--accent),#00b8d4);color:#000;align-self:flex-end;border-bottom-right-radius:.2rem;font-weight:500}
.ia-msg.bot{background:var(--card);border:1px solid var(--border);align-self:flex-start;border-bottom-left-radius:.2rem}
.ia-msg.bot strong{color:var(--accent)}
.ia-msg.dev-msg{background:rgba(124,77,255,.08);border:1px solid rgba(124,77,255,.2);align-self:flex-start;border-bottom-left-radius:.2rem;max-width:100%}
.ia-msg.dev-msg strong{color:var(--purple)}
.ia-msg.alert-msg{background:rgba(255,61,87,.08);border:1px solid rgba(255,61,87,.25);color:var(--red);align-self:stretch;max-width:100%}
.ia-msg.alert-ok{background:rgba(0,230,118,.07);border:1px solid rgba(0,230,118,.2);color:var(--green);align-self:stretch;max-width:100%}
.ia-code-block{background:rgba(0,0,0,.35);border:1px solid rgba(0,212,255,.15);border-radius:.5rem;padding:.5rem .7rem;font-family:'Courier New',monospace;font-size:.72rem;overflow-x:auto;margin:.3rem 0;color:#e0e0e0;white-space:pre-wrap;word-break:break-word}
.ia-apply-btn{display:inline-block;margin-top:.4rem;padding:.22rem .7rem;background:var(--accent);color:#000;border:none;border-radius:.4rem;font-size:.68rem;font-weight:700;cursor:pointer;font-family:inherit}
.ia-apply-btn:active{opacity:.8}
.ia-quick{display:flex;flex-wrap:wrap;gap:.3rem;padding:.4rem .75rem;border-top:1px solid var(--border);flex-shrink:0;overflow-x:auto;scrollbar-width:none}
.ia-quick::-webkit-scrollbar{display:none}
.ia-quick-btn{background:var(--card);border:1px solid var(--border);border-radius:2rem;padding:.25rem .6rem;font-size:.66rem;font-weight:600;cursor:pointer;color:var(--muted2);white-space:nowrap;font-family:inherit;transition:all .15s;flex-shrink:0}
.ia-quick-btn:active{border-color:var(--accent);color:var(--accent)}
.ia-input-row{display:flex;gap:.4rem;padding:.5rem .75rem .8rem;flex-shrink:0;align-items:flex-end}
.ia-input{flex:1;background:var(--card);border:1px solid var(--border);border-radius:.7rem;padding:.45rem .7rem;font-size:.82rem;color:var(--text);font-family:inherit;resize:none;min-height:36px;max-height:100px;line-height:1.4;outline:none;transition:border-color .15s}
.ia-input:focus{border-color:rgba(0,212,255,.4)}
.ia-send{background:linear-gradient(135deg,var(--accent),#00b8d4);border:none;border-radius:.6rem;width:38px;height:36px;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.ia-send:active{transform:scale(.92)}
.ia-thinking{display:flex;gap:4px;align-items:center;padding:.4rem .6rem}
.ia-thinking span{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:dotBounce .9s ease-in-out infinite}
.ia-thinking span:nth-child(2){animation-delay:.15s}
.ia-thinking span:nth-child(3){animation-delay:.3s}
@keyframes dotBounce{0%,80%,100%{transform:scale(0.6);opacity:.4}40%{transform:scale(1);opacity:1}}

/* EVIDENCIA / FOTO */
.ev-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.35rem}
.ev-thumb{width:100%;aspect-ratio:1;object-fit:cover;border-radius:.5rem;border:1px solid var(--border)}
.ev-upload{width:100%;aspect-ratio:1;background:var(--card);border:2px dashed var(--border);border-radius:.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;font-size:1.5rem;gap:.2rem;transition:border .2s}
.ev-upload:active{border-color:var(--accent)}

/* RESPONSIVE: wider screen panel */
@media(min-width:960px){
  body{display:flex;justify-content:center;align-items:flex-start}
  #app{max-width:480px;min-height:100vh;box-shadow:0 0 80px rgba(0,0,0,.8)}
}

/* MAPA DE RUTA */
.mapa-modal{position:fixed;inset:0;z-index:500;background:var(--bg);display:none;flex-direction:column;overflow:hidden}
.mapa-modal.open{display:flex}
.mapa-header{padding:.75rem 1rem;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem;flex-shrink:0}
.mapa-header-info{flex:1}
.mapa-header-title{font-weight:700;font-size:.9rem}
.mapa-header-sub{font-size:.7rem;color:var(--muted);margin-top:.1rem}
#mapa-container{flex:1;min-height:0}
.mapa-footer{background:var(--surface);border-top:1px solid var(--border);padding:.6rem;flex-shrink:0}
.mapa-paradas-list{display:flex;flex-direction:column;gap:.35rem;max-height:38vh;overflow-y:auto;padding:.5rem .875rem}
.mapa-parada-item{display:flex;align-items:center;gap:.55rem;padding:.45rem .6rem;background:var(--card);border-radius:.65rem;border:1px solid var(--border);cursor:pointer;transition:border .15s}
.mapa-parada-item.activa{border-color:var(--accent);background:rgba(0,212,255,.06)}
.mapa-parada-item.visitada{border-color:var(--green);opacity:.7}
.mapa-parada-num{width:24px;height:24px;border-radius:50%;background:var(--accent);color:#000;font-weight:800;font-size:.68rem;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.mapa-parada-num.v{background:var(--green)}
.mapa-parada-num.o{background:var(--muted);color:var(--bg)}
.mapa-parada-info{flex:1;min-width:0}
.mapa-parada-nombre{font-size:.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mapa-parada-dir{font-size:.65rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-btn{background:var(--accent);color:#000;border:none;border-radius:.55rem;padding:.5rem 1rem;font-weight:700;font-size:.8rem;cursor:pointer;white-space:nowrap}
.nav-btn.sec{background:var(--card);border:1px solid var(--border);color:var(--text)}

/* Vendedor tag en clientes */
.vendedor-tag{display:inline-block;font-size:.6rem;font-weight:700;padding:.1rem .4rem;border-radius:.3rem;margin-left:.3rem;background:rgba(0,212,255,.12);color:var(--accent)}

/* SYNC BUTTON */
.sync-btn{background:var(--card);border:1px solid var(--border);border-radius:.45rem;padding:.25rem .55rem;cursor:pointer;font-size:.68rem;color:var(--muted);display:flex;align-items:center;gap:.28rem;font-family:'Space Grotesk',sans-serif;font-weight:600;transition:all .2s;white-space:nowrap}
.sync-btn:active{border-color:var(--accent);color:var(--accent)}
.sync-btn.syncing .sync-icon{animation:spinSync .7s linear infinite}
.sync-btn.has-update{border-color:rgba(0,230,118,.5);color:var(--green);background:rgba(0,230,118,.07);animation:syncPulse 2s ease-in-out infinite}
@keyframes spinSync{from{display:inline-block;transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes syncPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 10px rgba(0,230,118,.35)}}
.sync-icon{display:inline-block;font-size:.8rem;line-height:1}
.sync-toast{position:fixed;top:62px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--green);color:var(--green);border-radius:.65rem;padding:.45rem .9rem;font-size:.75rem;font-weight:600;z-index:400;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.4);display:none;animation:slideDown .25s ease}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
</style>
<!-- Leaflet Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-glow">üöÄ</div>
  <div class="login-title"><span class="login-badge">PedidosPro</span></div>
  <div class="login-sub">Sistema de ventas ¬∑ Multimarcas</div>
  <div class="login-card">
    <div class="form-stack">
      <div class="field">
        <label class="label">Usuario</label>
        <input class="input" id="login-user" type="text" placeholder="Ej: admin, diana, cindy, wilson"
          autocomplete="username" autocapitalize="none" spellcheck="false"
          onkeydown="if(event.key==='Enter'){document.getElementById('login-pass').focus();}"
          oninput="document.getElementById('login-err').style.display='none'"/>
      </div>
      <div class="field">
        <label class="label">Contrase√±a</label>
        <div class="login-input-wrap">
          <input class="input" id="login-pass" type="password" placeholder="Contrase√±a"
            autocomplete="current-password"
            onkeydown="if(event.key==='Enter')intentarLogin()"
            oninput="document.getElementById('login-err').style.display='none'"
            style="padding-right:2.8rem"/>
          <button class="login-show-pw" type="button" id="btn-toggle-pw" onclick="togglePw()">üëÅÔ∏è</button>
        </div>
      </div>
      <div id="login-err" class="login-err" style="display:none">‚ö†Ô∏è Usuario o contrase√±a incorrectos</div>
      <button class="btn btn-primary btn-full" onclick="intentarLogin()" style="margin-top:.25rem">
        Ingresar ‚Üí
      </button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="main-app" style="display:none;flex-direction:column;min-height:100vh">
  <div class="header">
    <div class="header-brand">
      <button id="btn-back" onclick="goBack()" style="display:none;background:var(--card);border:1px solid var(--border);border-radius:.45rem;padding:.28rem .55rem;color:var(--text);cursor:pointer;font-size:.9rem;margin-right:.3rem">‚Üê</button>
      <div class="header-logo">P</div>
      <div>
        <div class="header-title" id="app-title">PedidosPro</div>
        <div class="header-sub" id="app-user">usuario</div>
      </div>
    </div>
    <div class="header-right">
      <div class="gps-pill"><span class="gps-dot" id="gps-dot"></span><span id="gps-txt">GPS</span></div>
      <button class="sync-btn" id="sync-btn" onclick="sincronizarManual()" title="Sincronizar datos">
        <span class="sync-icon" id="sync-icon">üîÑ</span>
        <span id="sync-label">Sync</span>
      </button>
      <button id="ia-btn-hdr" onclick="toggleIA()" style="background:linear-gradient(135deg,var(--accent),var(--purple));border:none;border-radius:.45rem;padding:.25rem .55rem;cursor:pointer;font-size:.85rem;position:relative;display:none" title="Asistente Dev">‚öôÔ∏è<span id="ia-badge-hdr" style="position:absolute;top:-3px;right:-3px;background:var(--red);color:#fff;border-radius:50%;width:10px;height:10px;font-size:.45rem;display:none"></span></button>
      <button class="btn-logout" onclick="logout()">‚úï</button>
    </div>
  </div>

  <!-- PAGES -->
  <div class="page active" id="page-inicio"><div id="inicio-content"></div></div>

  <div class="page" id="page-nuevo">
    <div class="tabs" id="pedido-tabs">
      <button class="tab active" id="tab1" onclick="pedidoStep(1)">1. Cliente</button>
      <button class="tab" id="tab2" onclick="pedidoStep(2)">2. Productos</button>
      <button class="tab" id="tab3" onclick="pedidoStep(3)">3. Confirmar</button>
    </div>
    <div id="pedido-content"></div>
  </div>

  <div class="page" id="page-pedidos">
    <div class="search-wrap">
      <span class="search-ico">üîç</span>
      <input class="input" placeholder="Buscar cliente, #pedido..." id="ped-search" oninput="renderPedidos()"/>
    </div>
    <div class="scroll-x" style="padding:.2rem 0">
      <button class="chip active" id="fchip-todos" onclick="setFiltro('todos')">Todos</button>
      <button class="chip" id="fchip-pendiente" onclick="setFiltro('pendiente')">Pendientes</button>
      <button class="chip" id="fchip-completado" onclick="setFiltro('completado')">Completados</button>
      <button class="chip" id="fchip-cancelado" onclick="setFiltro('cancelado')">Cancelados</button>
      <button class="chip" id="fchip-facturado" onclick="setFiltro('facturado')">Facturados</button>
    </div>
    <div id="pedidos-lista"></div>
  </div>

  <div class="page" id="page-clientes">
    <div class="btn-row">
      <button class="btn btn-primary" style="flex:1" onclick="abrirModalCliente(null)">+ Cliente</button>
      <button class="btn btn-teal" style="flex:1" onclick="goTab('importar')">üìä Importar Excel</button>
    </div>
    <div class="search-wrap">
      <span class="search-ico">üîç</span>
      <input class="input" placeholder="Buscar cliente..." id="cli-search" oninput="renderClientes()"/>
    </div>
    <div id="clientes-lista"></div>
  </div>

  <div class="page" id="page-rutas"><div id="rutas-content"></div></div>

  <div class="page" id="page-reportes"><div id="reportes-content"></div></div>

  <div class="page" id="page-exhibiciones"><div id="exhibiciones-content"></div></div>

  <div class="page" id="page-importar"><div id="importar-content"></div></div>

  <div class="page" id="page-productos">
    <div class="btn-row">
      <button class="btn btn-primary" style="flex:1" onclick="abrirModalProducto(null)">+ Producto</button>
      <button class="btn btn-teal" style="flex:1" onclick="goTab('importar')">üìä Importar Excel</button>
    </div>
    <div class="search-wrap">
      <span class="search-ico">üîç</span>
      <input class="input" placeholder="Buscar producto..." id="prod-search" oninput="renderProductos()"/>
    </div>
    <div id="stock-alerts"></div>
    <div id="productos-lista"></div>
  </div>

  <div class="page" id="page-ajustes">
    <div class="tabs" id="ajuste-tabs">
      <button class="tab active" id="atab-neg" onclick="ajusteTab('negocio')">üè™ Empresa</button>
      <button class="tab" id="atab-fact" onclick="ajusteTab('factura')">üìÑ Factura</button>
      <button class="tab" id="atab-suc" onclick="ajusteTab('sucursal')">üè¢ Sucursales</button>
      <button class="tab" id="atab-usr" onclick="ajusteTab('usuarios')">üë• Usuarios</button>
      <button class="tab" id="atab-app" onclick="ajusteTab('app')">üì± App</button>
    </div>
    <div id="ajuste-content"></div>
  </div>

  <nav class="nav" id="main-nav"></nav>
</div>

<!-- MAPA MODAL -->
<div class="mapa-modal" id="mapa-modal">
  <div class="mapa-header">
    <button onclick="cerrarMapa()" style="background:var(--card);border:1px solid var(--border);border-radius:.5rem;padding:.35rem .65rem;color:var(--text);cursor:pointer;font-size:.85rem">‚úï</button>
    <div class="mapa-header-info">
      <div class="mapa-header-title" id="mapa-titulo">Ruta</div>
      <div class="mapa-header-sub" id="mapa-subtitulo"></div>
    </div>
    <button class="nav-btn" id="btn-navegar" onclick="navegarActual()">üß≠ Navegar</button>
  </div>
  <div id="mapa-container" style="height:100%;min-height:200px"></div>
  <div style="background:var(--surface);border-top:1px solid var(--border);padding:.5rem .875rem .35rem;flex-shrink:0">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.35rem">
      <div style="font-size:.7rem;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.07em">üìç Paradas</div>
      <button onclick="enrutarZonaCompleta()" style="background:linear-gradient(135deg,#ff9800,#ff3d57);border:none;border-radius:.5rem;padding:.28rem .7rem;color:#fff;cursor:pointer;font-size:.68rem;font-weight:700;display:flex;align-items:center;gap:.3rem">üó∫Ô∏è Enrutar zona</button>
    </div>
  </div>
  <div class="mapa-paradas-list" id="mapa-paradas-list"></div>
  <div class="mapa-footer">
    <div class="btn-row">
      <button class="nav-btn sec" style="flex:1" onclick="paradaAnterior()">‚Üê Anterior</button>
      <button class="nav-btn" style="flex:2" id="btn-marcar-visita" onclick="marcarVisitaDesdeMapaActual()">‚úì Marcar visitado</button>
      <button class="nav-btn sec" style="flex:1" onclick="paradaSiguiente()">Siguiente ‚Üí</button>
    </div>
    <div class="btn-row" style="margin-top:.35rem">
      <button class="nav-btn sec" style="flex:1;background:rgba(0,212,255,.1);color:var(--accent);border:1px solid rgba(0,212,255,.2)" id="btn-tomar-pedido" onclick="tomarPedidoDesdeMapaActual()">üõí Tomar pedido</button>
      <button class="nav-btn sec" style="flex:1" onclick="toggleEvidenciaMapa()">üì∏ Evidencia</button>
    </div>
  </div>
</div>

<!-- MAPA DETALLE PARADA -->
<div id="mapa-detalle-panel" style="display:none;position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--surface);border-top:2px solid var(--accent);border-top-left-radius:1.25rem;border-top-right-radius:1.25rem;padding:1.1rem;z-index:600;box-shadow:0 -8px 40px rgba(0,0,0,.7)">
  <div id="mapa-detalle-content"></div>
</div>
<div id="mapa-detalle-overlay" onclick="cerrarDetalleParada()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:599"></div>

<!-- SYNC TOAST -->
<div class="sync-toast" id="sync-toast"></div>

<!-- IA ASSISTANT PANEL -->
<button class="ia-fab" id="ia-fab" onclick="toggleIA()" title="Asistente IA" style="display:none">ü§ñ<span class="ia-badge" id="ia-badge" style="display:none">!</span></button>

<div class="ia-panel" id="ia-panel">
  <div class="ia-header">
    <div class="ia-avatar" style="font-size:.85rem">ü§ñ</div>
    <div style="flex:1">
      <div class="fw7" style="font-size:.88rem">Asistente IA ¬∑ PedidosPro</div>
      <div class="text-xs text-muted" id="ia-panel-sub">Tu asistente inteligente</div>
    </div>
    <button class="btn-logout" onclick="toggleIA()" style="margin-left:.4rem">‚úï</button>
  </div>
  <div class="ia-messages" id="ia-messages"></div>
  <div class="ia-quick" id="ia-quick"></div>
  <div class="ia-input-row">
    <textarea class="ia-input" id="ia-input" placeholder="Pregunta lo que necesites..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();iaSend()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
    <button class="ia-send" onclick="iaSend()">‚û§</button>
  </div>
</div>

<!-- ALERTAS MODAL -->
<div class="modal-overlay" id="modal-alerta" onclick="closeAlertaModal(event)">
  <div class="modal" id="modal-alerta-content"></div>
</div>


<!-- MODALS -->
<div class="modal-overlay" id="modal-ped" onclick="closePedModal(event)"><div class="modal" id="modal-ped-content"></div></div>
<div class="modal-overlay" id="modal-fact" onclick="closeFactModal(event)"><div class="modal" id="modal-fact-content"></div></div>
<div class="modal-overlay" id="modal-prod" onclick="closeProdModal(event)"><div class="modal" id="modal-prod-content"></div></div>
<div class="modal-overlay" id="modal-user" onclick="closeUserModal(event)"><div class="modal" id="modal-user-content"></div></div>
<div class="modal-overlay" id="modal-cliente" onclick="closeClienteModal(event)"><div class="modal" id="modal-cliente-content"></div></div>
<div class="modal-overlay" id="modal-ruta" onclick="closeRutaModal(event)"><div class="modal" id="modal-ruta-content"></div></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DATA_VERSION='v7-firebase';
const K={p:'pp3_prods',o:'pp3_orders',u:'pp3_users',c:'pp3_config',cl:'pp3_clientes',rt:'pp3_rutas',f:'pp3_facturas',s:'pp3_sucursales',tr:'pp3_trial'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE FIRESTORE ‚Äî Sincronizaci√≥n real entre dispositivos
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _hasLS=(()=>{try{localStorage.setItem('_t','1');localStorage.removeItem('_t');return true;}catch{return false;}})();

// Cache local para lecturas r√°pidas (evita awaits en render)
const _cache={};

// ‚îÄ‚îÄ‚îÄ SISTEMA FIREBASE ‚Äî load/save/sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// load sincr√≥nico: usa cache local (Firebase carga async al inicio)
const load=(k,fb)=>{
  if(_cache[k]!==undefined)return _cache[k];
  if(_hasLS){try{const v=localStorage.getItem(k);if(v){const d=JSON.parse(v);_cache[k]=d;return d;}}catch{}}
  return fb;
};

// save: guarda en cache local + localStorage + Firebase
const save=(k,d)=>{
  _cache[k]=d;
  if(_hasLS){try{localStorage.setItem(k,JSON.stringify(d));}catch{}}
  // Guardar en Firebase Firestore (async, no bloquea)
  if(typeof db!=='undefined'){
    db.collection('pedidospro').doc(k).set({data:JSON.stringify(d),ts:Date.now()})
      .catch(e=>console.warn('Firebase save error:',e));
  }
};

let _syncInterval=null;
let _syncBusy=false;
let _lastKnownWrite=0;
let _firestoreListeners=[];

// Cargar TODOS los datos desde Firebase al iniciar sesi√≥n
async function syncAll(){
  if(typeof db==='undefined')return false;
  const keys=[K.p,K.o,K.u,K.c,K.cl,K.rt,K.f,K.s,'pp3_alerts'];
  let hayDatos=false;
  for(const k of keys){
    try{
      const doc=await db.collection('pedidospro').doc(k).get();
      if(doc.exists&&doc.data().data){
        const d=JSON.parse(doc.data().data);
        _cache[k]=d;
        hayDatos=true;
        if(_hasLS){try{localStorage.setItem(k,JSON.stringify(d));}catch{}}
      }
    }catch(e){console.warn('syncAll error',k,e);}
  }
  _aplicarCacheAVariables();
  return hayDatos;
}

// Aplicar cache a variables globales
function _aplicarCacheAVariables(){
  if(_cache[K.p])productos=_cache[K.p];
  if(_cache[K.o])pedidos=_cache[K.o];
  if(_cache[K.c])config=_cache[K.c];
  if(_cache[K.cl])clientes=_cache[K.cl];
  if(_cache[K.rt])rutas=_cache[K.rt];
  if(_cache[K.f])facturas=_cache[K.f];
  if(_cache[K.s])sucursales=_cache[K.s];
  if(_cache['pp3_alerts'])alertas=_cache['pp3_alerts'];
  // Usuarios: siempre fusionar con USUARIOS_BASE
  if(_cache[K.u]){
    usuarios=typeof cargarUsuarios==='function'?cargarUsuarios(_cache[K.u]):_cache[K.u];
    if(typeof USUARIOS_BASE!=='undefined'){
      USUARIOS_BASE.forEach(base=>{
        const idx=usuarios.findIndex(u=>u.id===base.id||u.username===base.username);
        if(idx>=0){usuarios[idx].username=base.username;usuarios[idx].pass=base.pass;}
        else usuarios.push({...base});
      });
    }
  }
}

// Sincronizaci√≥n manual (bot√≥n)
async function sincronizarManual(){
  if(_syncBusy)return;
  _syncBusy=true;
  const btn=document.getElementById('sync-btn');
  const icon=document.getElementById('sync-icon');
  const label=document.getElementById('sync-label');
  if(btn){btn.classList.add('syncing');btn.classList.remove('has-update');if(icon)icon.textContent='üîÑ';if(label)label.textContent='...';}
  const ok=await syncAll();
  refrescarPantallaActual();
  if(btn){btn.classList.remove('syncing');if(icon)icon.textContent='‚úì';if(label)label.textContent='OK';}
  mostrarSyncToast(ok?'‚úÖ Datos actualizados':'‚úì Ya est√°s al d√≠a');
  setTimeout(()=>{if(icon)icon.textContent='üîÑ';if(label)label.textContent='Sync';_syncBusy=false;},2500);
}

// Toast de notificaci√≥n
function mostrarSyncToast(msg){
  const t=document.getElementById('sync-toast');
  if(!t)return;
  t.textContent=msg;
  t.style.display='block';
  clearTimeout(t._to);
  t._to=setTimeout(()=>{t.style.display='none';},2800);
}

// Re-renderizar pantalla activa
function refrescarPantallaActual(){
  try{
    const activa=document.querySelector('.page.active');
    if(!activa)return;
    const id=activa.id;
    if(id==='page-inicio')renderInicio();
    else if(id==='page-pedidos')renderPedidos();
    else if(id==='page-rutas')renderRutas();
    else if(id==='page-clientes')renderClientes();
    else if(id==='page-productos')renderProductos();
    else if(id==='page-reportes')renderReportes();
  }catch(e){}
}

// Escucha en tiempo real de Firestore ‚Äî actualiza autom√°ticamente cuando el admin cambia datos
function iniciarListenerFirebase(){
  // Detener listeners anteriores
  _firestoreListeners.forEach(u=>u());
  _firestoreListeners=[];
  if(typeof db==='undefined')return;
  // Escuchar cambios en la colecci√≥n completa
  const unsub=db.collection('pedidospro').onSnapshot(snapshot=>{
    let cambio=false;
    snapshot.docChanges().forEach(change=>{
      if(change.type==='modified'||change.type==='added'){
        const k=change.doc.id;
        const docData=change.doc.data();
        if(docData&&docData.data){
          try{
            const d=JSON.parse(docData.data);
            const prev=JSON.stringify(_cache[k]||null);
            if(JSON.stringify(d)!==prev){
              _cache[k]=d;
              if(_hasLS){try{localStorage.setItem(k,JSON.stringify(d));}catch{}}
              cambio=true;
            }
          }catch(e){}
        }
      }
    });
    if(cambio&&session){
      _aplicarCacheAVariables();
      refrescarPantallaActual();
      // Indicar en el bot√≥n que hay datos nuevos
      const btn=document.getElementById('sync-btn');
      const icon=document.getElementById('sync-icon');
      const lbl=document.getElementById('sync-label');
      if(btn&&!btn.classList.contains('syncing')){
        if(icon)icon.textContent='‚úì';
        if(lbl)lbl.textContent='Nuevo';
        mostrarSyncToast('üîÑ Datos actualizados en tiempo real');
        setTimeout(()=>{if(icon)icon.textContent='üîÑ';if(lbl)lbl.textContent='Sync';},2500);
      }
    }
  },err=>console.warn('Firestore listener error:',err));
  _firestoreListeners.push(unsub);
}

const sp=()=>{
  save(K.p,productos);save(K.o,pedidos);save(K.u,usuarios);save(K.c,config);
  save(K.cl,clientes);save(K.rt,rutas);save(K.f,facturas);save(K.s,sucursales);
  save('pp3_alerts',alertas);
  try{if(typeof bcAlertas!=='undefined')bcAlertas.postMessage({tipo:'datos_actualizados'});}catch(e){}
};

let productos=load(K.p,[
  {id:1,nombre:'Producto A',precio:25000,categoria:'General',stock:50,stockMin:5,emoji:'üì¶'},
  {id:2,nombre:'Producto B',precio:45000,categoria:'Bebidas',stock:3,stockMin:5,emoji:'ü•§'},
  {id:3,nombre:'Producto C',precio:15000,categoria:'Alimentos',stock:100,stockMin:10,emoji:'üçï'},
]);
let pedidos=load(K.o,[]);
let facturas=load(K.f,[]);
let clientes=load(K.cl,[{"id": 100, "nombre": "VERDUGO VELANDIA LUIS ENRIQUE", "telefono": "", "email": "", "direccion": "CR 1B  #  41-56 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 101, "nombre": "BECERRA JARAMILLO WILSON", "telefono": "", "email": "", "direccion": "CR 12B 52 SUR 80", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 102, "nombre": "TORRES PABON CARLOS JULIO", "telefono": "", "email": "", "direccion": "CL 49 G NO. 5 X - 16 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 103, "nombre": "VELA ARRIGUI DIONISIDEL", "telefono": "", "email": "", "direccion": "CL 49 H 10 04 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 104, "nombre": "SUPERMERCADEO S.A.S", "telefono": "", "email": "", "direccion": "CL 48J SUR 5F-56", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 105, "nombre": "RUIZ RAMIREZ AUDALI", "telefono": "", "email": "", "direccion": "CR 10 # 50-10 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 106, "nombre": "GOMEZ BELTRAN WALDO ALFONSO", "telefono": "", "email": "", "direccion": "CL 46G SUR 15ESTE 34", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 107, "nombre": "MARIN GIRALDO FRANCISCO JAVIER", "telefono": "", "email": "", "direccion": "CR 18Q BIS 67C SUR 10", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 108, "nombre": "CUBILLOS DELGADO FIDOLO", "telefono": "", "email": "", "direccion": "CL 106 SUR 2 ESTE 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 109, "nombre": "VARGAS RINCON JOSE", "telefono": "", "email": "", "direccion": "TV 14 ESTE 57 SUR 3", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 110, "nombre": "ROMERO QUEVEDO LILIA NELCY", "telefono": "", "email": "", "direccion": "DG 77A SUR 18D 74", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 111, "nombre": "RESTREPO QUIROGA JOSE URIEL", "telefono": "", "email": "", "direccion": "DG 71B SUR 18I 51", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 112, "nombre": "RODRIGUEZ RODRIGUEZ HEYDI JOHANA", "telefono": "", "email": "", "direccion": "CR 12D 27SUR 28", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 113, "nombre": "HERNANDEZ ULLOA MIGUEL", "telefono": "", "email": "", "direccion": "CL 61SUR 14 H ESTE 09", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 114, "nombre": "ADRIANA MARCELA ESCAMILLA BAZURTO", "telefono": "", "email": "", "direccion": "Cl 77 Sur # 8 D 25", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 115, "nombre": "LOPEZ SOBA NANCY ROCIO", "telefono": "", "email": "", "direccion": "CR 39A 34 SUR 6", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 116, "nombre": "GRUPO EMPRESARIAL AHORRAMAS S A S", "telefono": "", "email": "", "direccion": "CR 25 48 SUR 27", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 117, "nombre": "COMERCIALIZADORA MERCA2 SAS", "telefono": "", "email": "", "direccion": "CRA 14 74b 34 sur santa librada", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 118, "nombre": "SANCHEZ RIOS JULY ANDREA", "telefono": "", "email": "", "direccion": "DG 45F SUR 13C 21", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 119, "nombre": "CHAPARRO DELGADO OSCAR ALEXANDER", "telefono": "", "email": "", "direccion": "DG 44B SUR 22A 59", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 120, "nombre": "TORRES REYES YECSON", "telefono": "", "email": "", "direccion": "CR 6 82-96 SUR VIA AL LLANO", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 121, "nombre": "CASTRO RODRIGUEZ JEISSON ALEXANDER", "telefono": "", "email": "", "direccion": "CL 81SUR 10 78", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 122, "nombre": "GRUPO VADEL SAS", "telefono": "", "email": "", "direccion": "CL 19 19 02 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 123, "nombre": "PAEZ CASTELLANOS PEDRO JULIO", "telefono": "", "email": "", "direccion": "CR 4 ESTE 37C SUR 42", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 124, "nombre": "JIMENEZ AMAYA JORGE IGNACIO", "telefono": "", "email": "", "direccion": "DG 43 A BIS SUR 7 23 ESTE", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 125, "nombre": "MARIN GIRALDO CARLOS ARIEL", "telefono": "", "email": "", "direccion": "CR 4B 51B SUR 29", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 126, "nombre": "CASTELLANOS MORENO ROOSEBETT", "telefono": "", "email": "", "direccion": "CR 19 D 66 61 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 127, "nombre": "REYES AMADO PEDRO ELIAS", "telefono": "", "email": "", "direccion": "CL 46 SUR 11A ESTE 33", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 128, "nombre": "SUPERMERCADOS DIA DIA S.A.S.", "telefono": "", "email": "", "direccion": "CL 28 SUR 19B 16", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 129, "nombre": "CADENA GALINDO MAYLUZ", "telefono": "", "email": "", "direccion": "CLL 49D 2 B 31 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 130, "nombre": "CAGUE√ëAS CAGUE√ëAS JUAN DE DIOS", "telefono": "", "email": "", "direccion": "CR 6F ESTE 97F SUR 52", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 131, "nombre": "ORTIZ CUBILLOS OSCAR FERNEY", "telefono": "", "email": "", "direccion": "CR 1F 91 SUR 79", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 132, "nombre": "MERCADOS MERKA HOGAR LA 91 SAS", "telefono": "", "email": "", "direccion": "CL 91 SUR 5-05 ESTE", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 133, "nombre": "GONZALEZ CALDERON ALEJANDRO", "telefono": "", "email": "", "direccion": "CRA 14 SUR  92 B 17 USME", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Diana"}, {"id": 134, "nombre": "ARIZA BOHORQUEZ LUIS RAUL", "telefono": "", "email": "", "direccion": "CR 86 F 34 A 23 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 135, "nombre": "LOPEZ PULIDO ELIZABETH", "telefono": "", "email": "", "direccion": "CR 80 72A 37", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 136, "nombre": "HERRERA GUTIERREZ CARLOS ADELMO", "telefono": "", "email": "", "direccion": "CL 17 SUR 29C 07", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 137, "nombre": "ALONSO CASTILLO VICTOR JULIO", "telefono": "", "email": "", "direccion": "CLL 51 A SUR 78 H 20", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 138, "nombre": "HERNANDEZ PEREZ JOSE ANTONIO", "telefono": "", "email": "", "direccion": "TV 15F BIS 31G SUR 28", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 139, "nombre": "CABRERA GARCIA MARTHA ISABEL", "telefono": "", "email": "", "direccion": "TV 7 4B 16", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 140, "nombre": "MERKATELL S A S", "telefono": "", "email": "", "direccion": "DG 37 18 78 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 141, "nombre": "NIETO PRIETO HECTOR AUGUSTO", "telefono": "", "email": "", "direccion": "CL 45 SUR 72J 14", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 142, "nombre": "M&M PETUNIA S.A.S", "telefono": "", "email": "", "direccion": "DIAGONAL 46 A SUR 51-94", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 143, "nombre": "FINO MENDIETA GABRIEL", "telefono": "", "email": "", "direccion": "CL 42 SUR 53 26", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 144, "nombre": "ALVARADO MORALES PABLO ANTONIO", "telefono": "", "email": "", "direccion": "CL 76A 73B 01 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 145, "nombre": "M C CONSTRUCTORES Y CONSULTORES SAS", "telefono": "", "email": "", "direccion": "CR 36 17 293", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 146, "nombre": "MERCADOS CUNDINAMARCA JR SAS", "telefono": "", "email": "", "direccion": "CR 26A ESTE 59-13", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 147, "nombre": "INVERSIONES SHOP RITE S.A.S.", "telefono": "", "email": "", "direccion": "CR 66 58 SUR 2", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 148, "nombre": "INVERSIONES NARANJO RODRIGUEZ S.A.S", "telefono": "", "email": "", "direccion": "CL 59 32A ESTE 05", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 149, "nombre": "CAGUE√ëAS BETANCOURT JUAN DAVID", "telefono": "", "email": "", "direccion": "CL 59 29 ESTE 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 150, "nombre": "ALMACENES MEXIMER SAS", "telefono": "", "email": "", "direccion": "CR 72D 56A SUR 21", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 151, "nombre": "GRUPO COMERCIAL MERCADOS LA SABANA", "telefono": "", "email": "", "direccion": "CL 51A 80 SUR 76", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 152, "nombre": "INVERSIONES GRUPO ROAL SAS", "telefono": "", "email": "", "direccion": "CR 52 21 25 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 153, "nombre": "CELIS NOVOA JOSE ARMANDO", "telefono": "", "email": "", "direccion": "CR 7 7-95", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 154, "nombre": "CASTELLANOS Y SEGURA E HIJOS SAS", "telefono": "", "email": "", "direccion": "CR 7 9A 110", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 155, "nombre": "FRANCO OSORIO RAFAEL ANGEL", "telefono": "", "email": "", "direccion": "CR 88C SUR 59C 98", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 156, "nombre": "CELIS MARTINEZ JOSE ALEXANDER", "telefono": "", "email": "", "direccion": "CR 88C 59 04 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 157, "nombre": "FINO SALAMANCA JUAN GABRIEL", "telefono": "", "email": "", "direccion": "CL 57B SUR 63 47", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 158, "nombre": "CUBILLOS & CAG√úE√ëAS SAS", "telefono": "", "email": "", "direccion": "CL 52A SUR 83 3", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 159, "nombre": "YULY ANDREA CUJAR CASTA√ëEDA", "telefono": "", "email": "", "direccion": "CALLE 10 A 18 61 SOACHA", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 160, "nombre": "ORTIZ CAGUE√ëAS ALEXANDER", "telefono": "", "email": "", "direccion": "CL 59C SUR 46A 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 161, "nombre": "REINA BEJARANO EDWIN FERNANDO", "telefono": "", "email": "", "direccion": "TV 12A 41C 7", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 162, "nombre": "ORTIZ QUEVEDO GLADYS ODILIA", "telefono": "", "email": "", "direccion": "CL 38 SUR 86C 85", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 163, "nombre": "ROJAS PABON JUAN BATUEL", "telefono": "", "email": "", "direccion": "CL 6B 78C 28", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 164, "nombre": "TRIANA LOPEZ HUGO ALFONSO", "telefono": "", "email": "", "direccion": "CR 87C 66A 03 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 165, "nombre": "MORA MORA EDISSON LEONARDO", "telefono": "", "email": "", "direccion": "DG 50 SUR 53 89", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 166, "nombre": "ROMERO CASTRO NELSON JOANY", "telefono": "", "email": "", "direccion": "CR 18 Q 10 62", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 167, "nombre": "PUNTO MARKET EXPRESS LA UNION SAS", "telefono": "", "email": "", "direccion": "CL 11 5A 49", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 168, "nombre": "PARRA BOHORQUEZ JOSE IGNACIO", "telefono": "", "email": "", "direccion": "CLL 37 SUR 72J 89", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 169, "nombre": "SURKAFAN SA", "telefono": "", "email": "", "direccion": "CL 46 2B 21", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 170, "nombre": "VELASQUEZ PEDRO ADRIANO", "telefono": "", "email": "", "direccion": "Carrera 81 # 68a-51 sur", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 171, "nombre": "NOVOA ORTIZ MARTIN EMILIO", "telefono": "", "email": "", "direccion": "CR 68D SUR 37A 23", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 172, "nombre": "MERCADOS JP SAS", "telefono": "", "email": "", "direccion": "CL 63  98A 30 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 173, "nombre": "JIMENEZ ECHAVARRIA JOHAN MATEO", "telefono": "", "email": "", "direccion": "CLL 83 SUR 91 48", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 174, "nombre": "EL MANJAR VALE√ëO E U", "telefono": "", "email": "", "direccion": "CL 6  79 29 BRR PIO XII", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 175, "nombre": "PLAZAS WILCHES LUIS CARLOS", "telefono": "", "email": "", "direccion": "CALLE 2 91 10", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 176, "nombre": "BURITICA GOMEZ LAURA LILI", "telefono": "", "email": "", "direccion": "CL 54C SUR 88I 94", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 177, "nombre": "LA MARCA COMER DE VIVERES Y LICORES", "telefono": "", "email": "", "direccion": "CR 18 Q 7A 12", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 178, "nombre": "TOVAR HUERTAS BLANCA NELLY", "telefono": "", "email": "", "direccion": "CLL 72 B SUR 87 C 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 179, "nombre": "ALMACEN LOS ANDES L.R", "telefono": "", "email": "", "direccion": "clle 35 sur 15b 11", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 180, "nombre": "MORA TORRES BLANCA DORIS", "telefono": "", "email": "", "direccion": "DG 49A SUR 53B 90", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 181, "nombre": "VARON RAQUEJO CARLOS SNEIDER", "telefono": "", "email": "", "direccion": "CR 51D 30 07 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 182, "nombre": "MORE CHAPARRO DIEGO FERNANDO", "telefono": "", "email": "", "direccion": "CR 35 25 09", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 183, "nombre": "TIENDAS MEGA BOSA SAS", "telefono": "", "email": "", "direccion": "CL 65 SUR 78 51", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 184, "nombre": "CORATIENDAS 165 E.U", "telefono": "", "email": "", "direccion": "CALLE 46 SUR N 81 H 32", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 185, "nombre": "MERKAEXITO HNOS SAS", "telefono": "", "email": "", "direccion": "Carrera 7 8 28", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 186, "nombre": "BAUTISTA BOCACHICA YENNI ALEXANDRA", "telefono": "", "email": "", "direccion": "CR 72A 54A 7 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Wilson"}, {"id": 187, "nombre": "PARRA AMAYA GLORIA EDILSA", "telefono": "", "email": "", "direccion": "CR 59 130 17", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 188, "nombre": "CARLOS ALCIDES VERDUGO VELANDIA", "telefono": "", "email": "", "direccion": "CL 76 80A 83", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 189, "nombre": "GARZON OLIVARES MAURICIO", "telefono": "", "email": "", "direccion": "CR 112 23 C 04", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 190, "nombre": "ERIKA NATALIA ECHEVARRIA RUA", "telefono": "", "email": "", "direccion": "DG 81 I 74 B 11", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 191, "nombre": "LEON MATALLANA GLORIA XIMENA", "telefono": "", "email": "", "direccion": "CL 22H 114A 30", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 192, "nombre": "HERRERA ALVIRA MARY LUZ", "telefono": "", "email": "", "direccion": "CR 49 137 22", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 193, "nombre": "RODRIGUEZ DIAZ LUIS ANTONIO", "telefono": "", "email": "", "direccion": "CR 81A 81 31", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 194, "nombre": "AUTOSERVICIOS SABANA RODRIGUEZ SAS", "telefono": "", "email": "", "direccion": "CR 59 131 47", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 195, "nombre": "DISTRIMAX.01 SAS", "telefono": "", "email": "", "direccion": "CR 120 17D 4", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 196, "nombre": "GALEANO PAIBA CARMEN EBELCY", "telefono": "", "email": "", "direccion": "TV 85 64G 06", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 197, "nombre": "ESPITIA RAMIREZ SANDRA MILENA", "telefono": "", "email": "", "direccion": "CR 8C 188 26", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 198, "nombre": "SOLER SALAMANCA PABLO RAMIRO", "telefono": "", "email": "", "direccion": "CR 4B 191A 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 199, "nombre": "GUASCA PARRA WILSON HUMBERTO", "telefono": "", "email": "", "direccion": "CR 7 173 A 40", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 200, "nombre": "JOYA DE MOGOYON MARIELA", "telefono": "", "email": "", "direccion": "CR 4 188A 30", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 201, "nombre": "PORRAS ALDANA PEDRO ALFONSO", "telefono": "", "email": "", "direccion": "CALLE 132 D # 156 - 25", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 202, "nombre": "MORA BUITRAGO ARACELY", "telefono": "", "email": "", "direccion": "CR 106 130D 84", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 203, "nombre": "GARCES BOCACHICA ARACELY", "telefono": "", "email": "", "direccion": "CL 191 7A 25", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 204, "nombre": "BONILLA MARISOL", "telefono": "", "email": "", "direccion": "CR 4 188 47", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 205, "nombre": "MORENO SOLER CIRO ANTONIO", "telefono": "", "email": "", "direccion": "CR 4 186C 18", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 206, "nombre": "MERCADOS EL CESAR Y CIA SAS", "telefono": "", "email": "", "direccion": "CR 7 180 75 MD 4 LC 22", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 207, "nombre": "SUPERTIENDAS 1A SAS", "telefono": "", "email": "", "direccion": "CR 139 142 D 22", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 208, "nombre": "MORENO TENJO JONATTAN RAUL", "telefono": "", "email": "", "direccion": "CRA 7 161-70", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 209, "nombre": "MORENO TENJO CARMEN HELENA", "telefono": "", "email": "", "direccion": "CR 8 182-69", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 210, "nombre": "SUPERMERCADOS LATINOS DE COLOMBIA S", "telefono": "", "email": "", "direccion": "CL 128C 94 8", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 211, "nombre": "COMPRAS LYM EXPRESS S.A.S.", "telefono": "", "email": "", "direccion": "CR 126 F NO. 137 - 79", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 212, "nombre": "MERCAPRECIOS SAS", "telefono": "", "email": "", "direccion": "CL 70 A BIS NO. 116 B 10", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 213, "nombre": "SUPERMERCADO LA ESQUINA DE LA 87 RR", "telefono": "", "email": "", "direccion": "CR 87 NO.5 B - 08 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 214, "nombre": "CASALLAS RICAURTE ELIZABETH", "telefono": "", "email": "", "direccion": "CR 106 130C 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 215, "nombre": "PRIETO TORRES SANDRA CECILIA", "telefono": "", "email": "", "direccion": "CR 110 68C 64", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 216, "nombre": "RODRIGUEZ CHACON ROSENDO", "telefono": "", "email": "", "direccion": "CL 129 89B 35", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 217, "nombre": "FAJARDO PARRA SEGUNDO NICASIO", "telefono": "", "email": "", "direccion": "CL 73A 70 02", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 218, "nombre": "GARZON ORDO√ëEZ NELSON DAVID", "telefono": "", "email": "", "direccion": "AC 72 104 16", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 219, "nombre": "QUINTERO CASTELLANOS ANA ORFILIA", "telefono": "", "email": "", "direccion": "TV 79D 74 44 SUR", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 220, "nombre": "PAMPLONA VILLEGAS HUBERTO FORNET", "telefono": "", "email": "", "direccion": "CL 9D 69 91", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 221, "nombre": "PABON MORA GUSTAVO", "telefono": "", "email": "", "direccion": "CL 11A 73B 39", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 222, "nombre": "POVEDA CORTES LUIS ALFONSO", "telefono": "", "email": "", "direccion": "CR 83 1 11", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 223, "nombre": "RICO RUEDA JOHN FREDY", "telefono": "", "email": "", "direccion": "CL 64 118B 58", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 224, "nombre": "SUPERMERCADOS PINARI CI LTDA", "telefono": "", "email": "", "direccion": "CL 139 140C 10", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 225, "nombre": "AUTOSERVICIO EL PEDREGAL MG SAS", "telefono": "", "email": "", "direccion": "CL 71B 100A 34", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 226, "nombre": "FAMILY MARK S.A.S.", "telefono": "", "email": "", "direccion": "CL 9 78C 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 227, "nombre": "SUMINISTROS Y ABARROTES BLANCO SAS", "telefono": "", "email": "", "direccion": "CR 110 69B 67", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 228, "nombre": "AUTOSERVICIO EL TREBOL 14 SAS", "telefono": "", "email": "", "direccion": "CL 70 107A 03", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 229, "nombre": "D ALEMAN DE ANTONIO JACKSON DANIEL", "telefono": "", "email": "", "direccion": "Cra 111 # 64B-04", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 230, "nombre": "RODRIGUEZ FORERO FRANCISCO", "telefono": "", "email": "", "direccion": "CLL 13 D 82 05", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 231, "nombre": "GRUPO LEFRADE SAS", "telefono": "", "email": "", "direccion": "CL 8 SUR NO. 35 36", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 232, "nombre": "SALAS CASTILLO S.A.S", "telefono": "", "email": "", "direccion": "CRA 141 A BIS A # 143B - 11", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 233, "nombre": "RAIGOZA GONZALEZ MARTHA LUCIA", "telefono": "", "email": "", "direccion": "CL 132 93A 24", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 234, "nombre": "HERNANDEZ BLANCO DARIO", "telefono": "", "email": "", "direccion": "CL 163A 8G 89", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 235, "nombre": "MATEUS ESPITIA CLAUDIA PATRICIA", "telefono": "", "email": "", "direccion": "CL 25 35 24", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 236, "nombre": "ALDERETE RENGIFO MARTHA LUCIA", "telefono": "", "email": "", "direccion": "CL 86 87-06", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 237, "nombre": "MORALES DE HERNANDEZ MARIA ELISA", "telefono": "", "email": "", "direccion": "CL 186B 16 14", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 238, "nombre": "RIOS VALENCIA ALFREDO", "telefono": "", "email": "", "direccion": "CL 70B 57B 84", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 239, "nombre": "LA PERLA E HIJOS Y CIA LIMITADA", "telefono": "", "email": "", "direccion": "CL 162A 6 10", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 240, "nombre": "SURTI TODO DEL NORTE SAS", "telefono": "", "email": "", "direccion": "CR 19 164 10", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 241, "nombre": "GRUPO COMERCIAL CRUZ SAS", "telefono": "", "email": "", "direccion": "CL 66 23 19", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 242, "nombre": "COMERCIALIZADORA MERCA SOCIAL SAS", "telefono": "", "email": "", "direccion": "CL 156 7D 31", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 243, "nombre": "INVERSIONES MARTINEZ FRUTIMAX SAS", "telefono": "", "email": "", "direccion": "CL 161 8G 68", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 244, "nombre": "GRUPO VELASQUEZ VILLALOBOS SAS", "telefono": "", "email": "", "direccion": "CR 47 22 35 LC 3", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 245, "nombre": "DISTRIBUCIONES GRUPO GREEN SAS", "telefono": "", "email": "", "direccion": "Cra 48 # 168A-21", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 246, "nombre": "HERNANDEZ SANTAMARIA LEIDY JHOANA", "telefono": "", "email": "", "direccion": "CR 55 174 81", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 247, "nombre": "INV SANTAMARIA & ASOCIADOS SAS", "telefono": "", "email": "", "direccion": "CRA 91 # 132 - 49", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 248, "nombre": "K.D. INVESTMENTS S.A.S", "telefono": "", "email": "", "direccion": "CR 8D 161A 17", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 249, "nombre": "RAMIREZ AREVALO HENRY ORLANDO", "telefono": "", "email": "", "direccion": "CL 4 SUR 11A 14", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 250, "nombre": "GUZMAN MOGOLLON EDILBERTO", "telefono": "", "email": "", "direccion": "CL 157A 98A 54", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 251, "nombre": "PUENTES CESPEDES CARLOS JULIO", "telefono": "", "email": "", "direccion": "CL 2BIS 16 34", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 252, "nombre": "GUTIERREZ VARGAS LUIS EDUARDO", "telefono": "", "email": "", "direccion": "CALLE 72 # 52- 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 253, "nombre": "ARIZA ALARCON ANGELA RUTH", "telefono": "", "email": "", "direccion": "CLL 148 95-19", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 254, "nombre": "AREVALO BOHORQUEZ CARLOS JULIO", "telefono": "", "email": "", "direccion": "CR 102A 133A 26", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 255, "nombre": "REYES MORA PEDRO ALEJANDRO", "telefono": "", "email": "", "direccion": "CL 152B 114 D 15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 256, "nombre": "SUPER COMPRAS S.A.S.", "telefono": "", "email": "", "direccion": "CL 136 99A 67", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 257, "nombre": "ARIAS RAMIREZ ALEXANDER", "telefono": "", "email": "", "direccion": "CL 139 # 112-15", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 258, "nombre": "MAYLIN CARCAMO MARTINEZ", "telefono": "", "email": "", "direccion": "CL 12 4 40", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 259, "nombre": "JUAN DAVID OVALLE RAMIREZ", "telefono": "", "email": "", "direccion": "CR 90 69 A 20", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 260, "nombre": "AREVALO BOHORQUEZ BERENICE", "telefono": "", "email": "", "direccion": "CR 124 130B 03", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 261, "nombre": "DURAN PAEZ CLAUDIA PATRICIA", "telefono": "", "email": "", "direccion": "CL 75 100 A 06", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}, {"id": 262, "nombre": "SAAVEDRA MALDONADO LIBARDO", "telefono": "", "email": "", "direccion": "CR 110 BIS 64 97", "ciudad": "Bogot√°", "nit": "", "notas": "SEMANAL", "activo": true, "sucursalId": null, "vendedor": "Cindy"}]);;
// ‚îÄ‚îÄ USUARIOS BASE (siempre disponibles, no dependen de localStorage) ‚îÄ‚îÄ
const USUARIOS_BASE=[
  {id:1,nombre:'Admin',username:'admin',rol:'admin',pass:'admin1234',activo:true,sucursalId:null},
  {id:2,nombre:'Diana',username:'diana',rol:'vendedor',pass:'diana111',activo:true,sucursalId:null},
  {id:3,nombre:'Cindy',username:'cindy',rol:'vendedor',pass:'cindy222',activo:true,sucursalId:null},
  {id:4,nombre:'Wilson',username:'wilson',rol:'vendedor',pass:'wilson333',activo:true,sucursalId:null},
];
// Fusionar usuarios guardados con la base (actualiza pass/username si cambiaron)
function cargarUsuarios(fallback){
  const guardados=load(K.u, fallback);
  // Para cada usuario base, asegurarse que est√© en el array con los datos correctos
  USUARIOS_BASE.forEach(base=>{
    const idx=guardados.findIndex(u=>u.id===base.id||u.username===base.username||(u.nombre&&u.nombre===base.nombre));
    if(idx>=0){
      // Actualizar pass y username pero respetar otros cambios
      guardados[idx].username=base.username;
      guardados[idx].pass=base.pass;
      guardados[idx].activo=guardados[idx].activo!==false;
    } else {
      guardados.push({...base});
    }
  });
  return guardados;
}
let usuarios=cargarUsuarios([{"id":1,"nombre":"Admin","username":"admin","rol":"admin","pin":"admin1234","pass":"admin1234","activo":true,"sucursalId":null},{"id":2,"nombre":"Diana","username":"diana","rol":"vendedor","pin":"diana111","pass":"diana111","activo":true,"sucursalId":null},{"id":3,"nombre":"Cindy","username":"cindy","rol":"vendedor","pin":"cindy222","pass":"cindy222","activo":true,"sucursalId":null},{"id":4,"nombre":"Wilson","username":"wilson","rol":"vendedor","pin":"wilson333","pass":"wilson333","activo":true,"sucursalId":null}]);
let sucursales=load(K.s,[
  {id:1,nombre:'Sede Principal',ciudad:'Bogot√°',color:'00d4ff',activo:true},
]);
let rutas=load(K.rt,(function(){
  const raw=[{"id":2000,"nombre":"JUE ‚Äì Cindy","vendedor":"Cindy","dia":"JUE","paradas":[{"clienteId":null,"clienteNombre":"PARRA AMAYA GLORIA EDILSA","direccion":"CR 59 130 17","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CARLOS ALCIDES VERDUGO VELANDIA","direccion":"CL 76 80A 83","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GARZON OLIVARES MAURICIO","direccion":"CR 112 23 C 04","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ERIKA NATALIA ECHEVARRIA RUA","direccion":"DG 81 I 74 B 11","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"LEON MATALLANA GLORIA XIMENA","direccion":"CL 22H 114A 30","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"HERRERA ALVIRA MARY LUZ","direccion":"CR 49 137 22","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RODRIGUEZ DIAZ LUIS ANTONIO","direccion":"CR 81A 81 31","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"AUTOSERVICIOS SABANA RODRIGUEZ SAS","direccion":"CR 59 131 47","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"AUTOSERVICIOS SABANA RODRIGUEZ SAS","direccion":"CR 59 132 22","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"DISTRIMAX.01 SAS","direccion":"CR 120 17D 4","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GALEANO PAIBA CARMEN EBELCY","direccion":"TV 85 64G 06","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":11,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2001,"nombre":"LUN ‚Äì Cindy","vendedor":"Cindy","dia":"LUN","paradas":[{"clienteId":null,"clienteNombre":"ESPITIA RAMIREZ SANDRA MILENA","direccion":"CR 8C 188 26","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SOLER SALAMANCA PABLO RAMIRO","direccion":"CR 4B 191A 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GUASCA PARRA WILSON HUMBERTO","direccion":"CR 7 173 A 40","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"JOYA DE MOGOYON MARIELA","direccion":"CR 4 188A 30","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PORRAS ALDANA PEDRO ALFONSO","direccion":"CALLE 132 D # 156 - 25","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORA BUITRAGO ARACELY","direccion":"CR 106 130D 84","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GARCES BOCACHICA ARACELY","direccion":"CL 191 7A 25","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"BONILLA MARISOL","direccion":"CR 4 188 47","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORENO SOLER CIRO ANTONIO","direccion":"CR 4 186C 18","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MERCADOS EL CESAR Y CIA SAS","direccion":"CR 7 180 75 MD 4 LC 22","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SUPERTIENDAS 1A SAS","direccion":"CR 139 142 D 22","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":11,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORENO TENJO JONATTAN RAUL","direccion":"CRA 7 161-70","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":12,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORENO TENJO CARMEN HELENA","direccion":"CR 8 182-69","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":13,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PORRAS ALDANA PEDRO ALFONSO","direccion":"CR 2 B 37 B 06 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":14,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2002,"nombre":"MAR ‚Äì Cindy","vendedor":"Cindy","dia":"MAR","paradas":[{"clienteId":null,"clienteNombre":"SUPERMERCADOS LATINOS DE COLOMBIA S","direccion":"CL 128C 94 8","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"COMPRAS LYM EXPRESS S.A.S.","direccion":"CR 126 F NO. 137 - 79","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MERCAPRECIOS SAS","direccion":"CL 70 A BIS NO. 116 B 10","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SUPERMERCADO LA ESQUINA DE LA 87 RR","direccion":"CR 87 NO.5 B - 08 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CASALLAS RICAURTE ELIZABETH","direccion":"CR 106 130C 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PRIETO TORRES SANDRA CECILIA","direccion":"CR 110 68C 64","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RODRIGUEZ CHACON ROSENDO","direccion":"CL 129 89B 35","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"FAJARDO PARRA SEGUNDO NICASIO","direccion":"CL 73A 70 02","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GARZON ORDO√ëEZ NELSON DAVID","direccion":"AC 72 104 16","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"QUINTERO CASTELLANOS ANA ORFILIA","direccion":"TV 79D 74 44 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PAMPLONA VILLEGAS HUBERTO FORNET","direccion":"CL 9D 69 91","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":11,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PABON MORA GUSTAVO","direccion":"CL 11A 73B 39","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":12,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"POVEDA CORTES LUIS ALFONSO","direccion":"CR 83 1 11","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":13,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RICO RUEDA JOHN FREDY","direccion":"CL 64 118B 58","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":14,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"AUTOSERVICIOS SABANA RODRIGUEZ SAS","direccion":"CR 136A 143 5","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":15,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SUPERMERCADOS PINARI CI LTDA","direccion":"CL 139 140C 10","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":16,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"AUTOSERVICIO EL PEDREGAL MG SAS","direccion":"CL 71B 100A 34","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":17,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"FAMILY MARK S.A.S.","direccion":"CL 9 78C 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":18,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SUMINISTROS Y ABARROTES BLANCO SAS","direccion":"CR 110 69B 67","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":19,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"AUTOSERVICIO EL TREBOL 14 SAS","direccion":"CL 70 107A 03","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":20,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"D ALEMAN DE ANTONIO JACKSON DANIEL","direccion":"Cra 111 # 64B-04","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":21,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"D ALEMAN DE ANTONIO JACKSON DANIEL","direccion":"Cll 67 # 116B-20","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":22,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RODRIGUEZ FORERO FRANCISCO","direccion":"CLL 13 D 82 05","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":23,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RODRIGUEZ FORERO FRANCISCO","direccion":"CARRERA 81A#13A-33","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":24,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RODRIGUEZ FORERO FRANCISCO","direccion":"CALLE 13A#80C-13","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":25,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GRUPO LEFRADE SAS","direccion":"CL 8 SUR NO. 35 36","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":26,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GRUPO LEFRADE SAS","direccion":"CR 69 D 1- 34","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":27,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SALAS CASTILLO S.A.S","direccion":"CRA 141 A BIS A # 143B - 11","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":28,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"JUAN DAVID OVALLE RAMIREZ","direccion":"CR 90 69 A 20","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":29,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"DURAN PAEZ CLAUDIA PATRICIA","direccion":"CL 75 100 A 06","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":30,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SAAVEDRA MALDONADO LIBARDO","direccion":"CR 110 BIS 64 97","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":31,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SUPERTIENDAS 1A SAS","direccion":"CR 117 150B 10","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":32,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2003,"nombre":"MIE ‚Äì Cindy","vendedor":"Cindy","dia":"MIE","paradas":[{"clienteId":null,"clienteNombre":"RAIGOZA GONZALEZ MARTHA LUCIA","direccion":"CL 132 93A 24","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"HERNANDEZ BLANCO DARIO","direccion":"CL 163A 8G 89","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MATEUS ESPITIA CLAUDIA PATRICIA","direccion":"CL 25 35 24","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ALDERETE RENGIFO MARTHA LUCIA","direccion":"CL 86 87-06","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORALES DE HERNANDEZ MARIA ELISA","direccion":"CL 186B 16 14","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RIOS VALENCIA ALFREDO","direccion":"CL 70B 57B 84","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"LA PERLA E HIJOS Y CIA LIMITADA","direccion":"CL 162A 6 10","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SURTI TODO DEL NORTE SAS","direccion":"CR 19 164 10","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GRUPO COMERCIAL CRUZ SAS","direccion":"CL 66 23 19","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"COMERCIALIZADORA MERCA SOCIAL SAS","direccion":"CL 156 7D 31","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"INVERSIONES MARTINEZ FRUTIMAX SAS","direccion":"CL 161 8G 68","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":11,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GRUPO VELASQUEZ VILLALOBOS SAS","direccion":"CR 47 22 35 LC 3","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":12,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"DISTRIBUCIONES GRUPO GREEN SAS","direccion":"Cra 48 # 168A-21","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":13,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"DISTRIBUCIONES GRUPO GREEN SAS","direccion":"Cra 8H # 165-34","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":14,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"HERNANDEZ SANTAMARIA LEIDY JHOANA","direccion":"CR 55 174 81","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":15,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"INV SANTAMARIA & ASOCIADOS SAS","direccion":"CRA 91 # 132 - 49","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":16,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"K.D. INVESTMENTS S.A.S","direccion":"CR 8D 161A 17","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":17,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2004,"nombre":"VIE ‚Äì Cindy","vendedor":"Cindy","dia":"VIE","paradas":[{"clienteId":null,"clienteNombre":"RAMIREZ AREVALO HENRY ORLANDO","direccion":"CL 4 SUR 11A 14","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GUZMAN MOGOLLON EDILBERTO","direccion":"CL 157A 98A 54","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PUENTES CESPEDES CARLOS JULIO","direccion":"CL 2BIS 16 34","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GUTIERREZ VARGAS LUIS EDUARDO","direccion":"CALLE 72 # 52- 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ARIZA ALARCON ANGELA RUTH","direccion":"CLL 148 95-19","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"AREVALO BOHORQUEZ CARLOS JULIO","direccion":"CR 102A 133A 26","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"REYES MORA PEDRO ALEJANDRO","direccion":"CL 152B 114 D 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SUPER COMPRAS S.A.S.","direccion":"CL 136 99A 67","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ARIAS RAMIREZ ALEXANDER","direccion":"CL 139 # 112-15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MAYLIN CARCAMO MARTINEZ","direccion":"CL 12 4 40","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"AREVALO BOHORQUEZ BERENICE","direccion":"CR 124 130B 03","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":11,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2005,"nombre":"JUE ‚Äì Diana","vendedor":"Diana","dia":"JUE","paradas":[{"clienteId":null,"clienteNombre":"GRUPO VADEL SAS","direccion":"CL 19 19 02 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PAEZ CASTELLANOS PEDRO JULIO","direccion":"CR 4 ESTE 37C SUR 42","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"JIMENEZ AMAYA JORGE IGNACIO","direccion":"DG 43 A BIS SUR 7 23 ESTE","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MARIN GIRALDO CARLOS ARIEL","direccion":"CR 4B 51B SUR 29","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CASTELLANOS MORENO ROOSEBETT","direccion":"CR 19 D 66 61 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CASTELLANOS MORENO ROOSEBETT","direccion":"CL 64 SUR 26 04","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"REYES AMADO PEDRO ELIAS","direccion":"CL 46 SUR 11A ESTE 33","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SUPERMERCADOS DIA DIA S.A.S.","direccion":"CL 28 SUR 19B 16","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CADENA GALINDO MAYLUZ","direccion":"CLL 49D 2 B 31 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2006,"nombre":"LUN ‚Äì Diana","vendedor":"Diana","dia":"LUN","paradas":[{"clienteId":null,"clienteNombre":"VERDUGO VELANDIA LUIS ENRIQUE","direccion":"CR 1B  #  41-56 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"BECERRA JARAMILLO WILSON","direccion":"CR 12B 52 SUR 80","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"TORRES PABON CARLOS JULIO","direccion":"CL 49 G NO. 5 X - 16 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"TORRES PABON CARLOS JULIO","direccion":"CARRERA 5 I N. 48 M 05 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"VELA ARRIGUI DIONISIDEL","direccion":"CL 49 H 10 04 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SUPERMERCADEO S.A.S","direccion":"CL 48J SUR 5F-56","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RUIZ RAMIREZ AUDALI","direccion":"CR 10 # 50-10 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":7,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2007,"nombre":"MAR ‚Äì Diana","vendedor":"Diana","dia":"MAR","paradas":[{"clienteId":null,"clienteNombre":"GOMEZ BELTRAN WALDO ALFONSO","direccion":"CL 46G SUR 15ESTE 34","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MARIN GIRALDO FRANCISCO JAVIER","direccion":"CR 18Q BIS 67C SUR 10","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CUBILLOS DELGADO FIDOLO","direccion":"CL 106 SUR 2 ESTE 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"VARGAS RINCON JOSE","direccion":"TV 14 ESTE 57 SUR 3","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ROMERO QUEVEDO LILIA NELCY","direccion":"DG 77A SUR 18D 74","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RESTREPO QUIROGA JOSE URIEL","direccion":"DG 71B SUR 18I 51","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"RODRIGUEZ RODRIGUEZ HEYDI JOHANA","direccion":"CR 12D 27SUR 28","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"HERNANDEZ ULLOA MIGUEL","direccion":"CL 61SUR 14 H ESTE 09","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2008,"nombre":"MIE ‚Äì Diana","vendedor":"Diana","dia":"MIE","paradas":[{"clienteId":null,"clienteNombre":"ADRIANA MARCELA ESCAMILLA BAZURTO","direccion":"Cl 77 Sur # 8 D 25","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CUBILLOS DELGADO FIDOLO","direccion":"CR 82 A 6-16 LOCAL 44","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"LOPEZ SOBA NANCY ROCIO","direccion":"CR 39A 34 SUR 6","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GRUPO EMPRESARIAL AHORRAMAS S A S","direccion":"CR 25 48 SUR 27","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"COMERCIALIZADORA MERCA2 SAS","direccion":"CRA 14 74b 34 sur santa librada","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SANCHEZ RIOS JULY ANDREA","direccion":"DG 45F SUR 13C 21","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CHAPARRO DELGADO OSCAR ALEXANDER","direccion":"DG 44B SUR 22A 59","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"TORRES REYES YECSON","direccion":"CR 6 82-96 SUR VIA AL LLANO","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CASTRO RODRIGUEZ JEISSON ALEXANDER","direccion":"CL 81SUR 10 78","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2009,"nombre":"VIE ‚Äì Diana","vendedor":"Diana","dia":"VIE","paradas":[{"clienteId":null,"clienteNombre":"CASTELLANOS MORENO ROOSEBETT","direccion":"CARRERA 17 F 70 A 16 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CASTELLANOS MORENO ROOSEBETT","direccion":"CARRERA 17G NO.65 - 84 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ROMERO QUEVEDO LILIA NELCY","direccion":"CLL 104 SUR 14-21","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CAGUE√ëAS CAGUE√ëAS JUAN DE DIOS","direccion":"CR 6F ESTE 97F SUR 52","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ORTIZ CUBILLOS OSCAR FERNEY","direccion":"CR 1F 91 SUR 79","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MERCADOS MERKA HOGAR LA 91 SAS","direccion":"CL 91 SUR 5-05 ESTE","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GONZALEZ CALDERON ALEJANDRO","direccion":"CRA 14 SUR  92 B 17 USME","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2010,"nombre":"JUE ‚Äì Wilson","vendedor":"Wilson","dia":"JUE","paradas":[{"clienteId":null,"clienteNombre":"ALMACENES MEXIMER SAS","direccion":"CR 72D 56A SUR 21","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"GRUPO COMERCIAL MERCADOS LA SABANA","direccion":"CL 51A 80 SUR 76","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"INVERSIONES GRUPO ROAL SAS","direccion":"CR 52 21 25 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"INVERSIONES GRUPO ROAL SAS","direccion":"CRA 79 40a 47 sur","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CELIS NOVOA JOSE ARMANDO","direccion":"CR 7 7-95","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CASTELLANOS Y SEGURA E HIJOS SAS","direccion":"CR 7 9A 110","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"YULY ANDREA CUJAR CASTA√ëEDA","direccion":"CALLE 10 A 18 61 SOACHA","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ORTIZ CAGUE√ëAS ALEXANDER","direccion":"CL 59C SUR 46A 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"REINA BEJARANO EDWIN FERNANDO","direccion":"TV 12A 41C 7","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"INVERSIONES GRUPO ROAL SAS","direccion":"CR 52A 27 24","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"M C CONSTRUCTORES Y CONSULTORES SAS","direccion":"CR 7 12 A 21","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":11,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MERKAEXITO HNOS SAS","direccion":"Carrera 7 8 28","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":12,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2011,"nombre":"LUN ‚Äì Wilson","vendedor":"Wilson","dia":"LUN","paradas":[{"clienteId":null,"clienteNombre":"ARIZA BOHORQUEZ LUIS RAUL","direccion":"CR 86 F 34 A 23 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"LOPEZ PULIDO ELIZABETH","direccion":"CR 80 72A 37","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"HERRERA GUTIERREZ CARLOS ADELMO","direccion":"CL 17 SUR 29C 07","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ALONSO CASTILLO VICTOR JULIO","direccion":"CLL 51 A SUR 78 H 20","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ORTIZ QUEVEDO GLADYS ODILIA","direccion":"CL 38 SUR 86C 85","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ROJAS PABON JUAN BATUEL","direccion":"CL 6B 78C 28","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"TRIANA LOPEZ HUGO ALFONSO","direccion":"CR 87C 66A 03 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORA MORA EDISSON LEONARDO","direccion":"DG 50 SUR 53 89","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORA MORA EDISSON LEONARDO","direccion":"calle 7 sur 24a 03","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"BURITICA GOMEZ LAURA LILI","direccion":"CL 54C SUR 88I 94","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"LA MARCA COMER DE VIVERES Y LICORES","direccion":"CR 18 Q 7A 12","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":11,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"LA MARCA COMER DE VIVERES Y LICORES","direccion":"CLL 71A SUR 83A 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":12,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PLAZAS WILCHES LUIS CARLOS","direccion":"AV ESPERANZA NO. 44 A 33","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":13,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORA TORRES BLANCA DORIS","direccion":"DG 49A SUR 53B 90","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":14,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MORE CHAPARRO DIEGO FERNANDO","direccion":"CR 35 25 09","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":15,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SURKAFAN SA","direccion":"CL 37 SUR 33 A 88","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":16,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PLAZAS WILCHES LUIS CARLOS","direccion":"CL 6 SUR 16A 150 LC 55","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":17,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2012,"nombre":"MAR ‚Äì Wilson","vendedor":"Wilson","dia":"MAR","paradas":[{"clienteId":null,"clienteNombre":"HERNANDEZ PEREZ JOSE ANTONIO","direccion":"TV 15F BIS 31G SUR 28","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CABRERA GARCIA MARTHA ISABEL","direccion":"TV 7 4B 16","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MERKATELL S A S","direccion":"DG 37 18 78 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"NIETO PRIETO HECTOR AUGUSTO","direccion":"CL 45 SUR 72J 14","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ROMERO CASTRO NELSON JOANY","direccion":"CR 18 Q 10 62","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ORTIZ CAGUE√ëAS ALEXANDER","direccion":"CR 14 26 27 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ORTIZ CAGUE√ëAS ALEXANDER","direccion":"CLL 30 SUR 16F 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PUNTO MARKET EXPRESS LA UNION SAS","direccion":"CL 11 5A 49","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ALMACEN LOS ANDES L.R","direccion":"clle 35 sur 15b 11","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":9,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2013,"nombre":"MIE ‚Äì Wilson","vendedor":"Wilson","dia":"MIE","paradas":[{"clienteId":null,"clienteNombre":"M&M PETUNIA S.A.S","direccion":"DIAGONAL 46 A SUR 51-94","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"FINO MENDIETA GABRIEL","direccion":"CL 42 SUR 53 26","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"FINO MENDIETA GABRIEL","direccion":"CALLE 30 5 -15 ESTE","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"ALVARADO MORALES PABLO ANTONIO","direccion":"CL 76A 73B 01 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"M C CONSTRUCTORES Y CONSULTORES SAS","direccion":"CR 36 17 293","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MERCADOS CUNDINAMARCA JR SAS","direccion":"CR 26A ESTE 59-13","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"INVERSIONES SHOP RITE S.A.S.","direccion":"CR 66 58 SUR 2","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"INVERSIONES NARANJO RODRIGUEZ S.A.S","direccion":"CL 59 32A ESTE 05","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CAGUE√ëAS BETANCOURT JUAN DAVID","direccion":"CL 59 29 ESTE 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PARRA BOHORQUEZ JOSE IGNACIO","direccion":"CLL 37 SUR 72J 89","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SURKAFAN SA","direccion":"CL 46 2B 21","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":11,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"SURKAFAN SA","direccion":"Calle 46 3A 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":12,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"TOVAR HUERTAS BLANCA NELLY","direccion":"CLL 72 B SUR 87 C 15","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":13,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true},{"id":2014,"nombre":"VIE ‚Äì Wilson","vendedor":"Wilson","dia":"VIE","paradas":[{"clienteId":null,"clienteNombre":"FRANCO OSORIO RAFAEL ANGEL","direccion":"CR 88C SUR 59C 98","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":1,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CELIS MARTINEZ JOSE ALEXANDER","direccion":"CR 88C 59 04 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":2,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"FINO SALAMANCA JUAN GABRIEL","direccion":"CL 57B SUR 63 47","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":3,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CUBILLOS & CAG√úE√ëAS SAS","direccion":"CL 52A SUR 83 3","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":4,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"VELASQUEZ PEDRO ADRIANO","direccion":"Carrera 81 # 68a-51 sur","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":5,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"VELASQUEZ PEDRO ADRIANO","direccion":"Calle 71 a sur # 81f -03","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":6,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"NOVOA ORTIZ MARTIN EMILIO","direccion":"CR 68D SUR 37A 23","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":7,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"NOVOA ORTIZ MARTIN EMILIO","direccion":"CLL 39 SUR 68D 91","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":8,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"MERCADOS JP SAS","direccion":"CL 63  98A 30 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":9,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"JIMENEZ ECHAVARRIA JOHAN MATEO","direccion":"CLL 83 SUR 91 48","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":10,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"EL MANJAR VALE√ëO E U","direccion":"CL 6  79 29 BRR PIO XII","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"2","orden":11,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"PLAZAS WILCHES LUIS CARLOS","direccion":"CALLE 2 91 10","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":12,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"JIMENEZ ECHAVARRIA JOHAN MATEO","direccion":"CLL 83 SUR 91 48","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":13,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"VARON RAQUEJO CARLOS SNEIDER","direccion":"CR 51D 30 07 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":14,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"TIENDAS MEGA BOSA SAS","direccion":"CL 65 SUR 78 51","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":15,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"CORATIENDAS 165 E.U","direccion":"CALLE 46 SUR N 81 H 32","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":16,"visitado":false,"omitido":false,"gps":null},{"clienteId":null,"clienteNombre":"BAUTISTA BOCACHICA YENNI ALEXANDRA","direccion":"CR 72A 54A 7 SUR","telefono":"","ciudad":"Bogot√°","nota":"SEMANAL","semana":"1","orden":17,"visitado":false,"omitido":false,"gps":null}],"estado":"pendiente","timestamp":0,"finTs":null,"importada":true}];  // Calcular timestamps para rutas pendientes basadas en dia de la semana
  // Mostrar ruta de HOY si el d√≠a coincide, sino la pr√≥xima ocurrencia
  const DIA_DOW={'LUN':1,'MAR':2,'MIE':3,'JUE':4,'VIE':5};
  const now=new Date();
  const curDOW=now.getDay(); // 0=Dom,1=Lun,...,6=Sab
  raw.forEach(r=>{
    if(r.timestamp===0){
      const target=DIA_DOW[r.dia]||1;
      let diff=target-curDOW;
      // Si es hoy ‚Üí timestamp de hoy a las 8am
      // Si ya pas√≥ ‚Üí pr√≥xima semana
      if(diff<0)diff+=7;
      const d=new Date(now);
      d.setDate(now.getDate()+diff);
      d.setHours(8,0,0,0);
      r.timestamp=d.getTime();
    }
  });
  return raw;
}()));


let config=load(K.c,{
  negocio:'Multimarcas',whatsapp:'573001234567',ciudad:'Bogot√°',nit:'',
  prefijo_fact:'FAC',iva:19,regimen:'simplificado',
  dir_empresa:'',tel_empresa:'',email_empresa:'',pie_factura:'',
  stockMinGlobal:5,
  trial:{activo:true,inicio:Date.now(),dias:30}
});

// Trial setup
let trialData=load(K.tr,{activo:true,inicio:Date.now(),dias:30});
save(K.tr,trialData);

const genId=()=>Date.now()+Math.floor(Math.random()*9999);
const nowStr=()=>new Date().toLocaleString('es-CO');
const todayStr=()=>new Date().toDateString();
const fmt=n=>'$'+Math.round(n).toLocaleString('es-CO');
const fmtN=n=>Math.round(n).toLocaleString('es-CO');
// Formatea n√∫mero para wa.me: limpia, agrega c√≥digo de pa√≠s si falta (57 = Colombia)
function fmtWA(tel){
  if(!tel)return config.whatsapp;
  const digits=String(tel).replace(/\D/g,'');
  if(!digits)return config.whatsapp;
  if(digits.length>=11)return digits;
  if(digits.length===10&&digits.startsWith('3'))return '57'+digits;
  if(digits.length<7)return config.whatsapp;
  return digits;
}


// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let session=null,currentTab='inicio',pedidoStepNum=1,carrito={};
let pedidoCliente={id:null,nombre:'',telefono:'',direccion:'',nota:'',ciudad:''};
let filtroEstado='todos',pinBuffer='',selectedUser=null,ajusteTabActual='negocio';
let prodBusq='',prodCat='Todos',userPos=null,gpsWatcher=null;
let pwaPrompt=null;

// Capture PWA install prompt
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();pwaPrompt=e;});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TRIAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function trialDiasRestantes(){
  const elapsed=Math.floor((Date.now()-trialData.inicio)/(1000*60*60*24));
  return Math.max(0, trialData.dias-elapsed);
}
function trialVencido(){return trialData.activo&&trialDiasRestantes()<=0;}
function trialBanner(){
  if(!trialData.activo) return '';
  const dias=trialDiasRestantes();
  if(dias<=0) return `<div class="alert a-err">‚õî Per√≠odo gratuito vencido. Contacta a tu proveedor para continuar.</div>`;
  return `<div class="trial-banner"><span class="trial-icon">‚è≥</span><div><div class="fw7" style="font-size:.82rem">Per√≠odo de prueba gratuito</div><div class="text-xs text-muted">${dias} d√≠a${dias!==1?'s':''} restante${dias!==1?'s':''}  ¬∑ Luego contacta a tu proveedor</div></div></div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GPS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGPS(){
  if(!navigator.geolocation){
    mostrarSyncToast('‚ö†Ô∏è GPS no disponible en este navegador');
    return;
  }
  // Detectar si est√° en WhatsApp WebView (bloquea GPS)
  const ua=navigator.userAgent;
  const esWhatsApp=/WhatsApp/i.test(ua);
  if(esWhatsApp){
    const dot=document.getElementById('gps-dot');
    const txt=document.getElementById('gps-txt');
    if(dot)dot.className='gps-dot';
    if(txt)txt.textContent='GPS ‚úó';
    // Mostrar aviso para abrir en Chrome
    setTimeout(()=>{
      document.getElementById('modal-alerta-content').innerHTML=`
        <div class="modal-handle"></div>
        <div style="text-align:center;padding:.5rem 0">
          <div style="font-size:2.5rem;margin-bottom:.5rem">üì°</div>
          <div class="modal-title">Abre la app en Chrome</div>
          <div style="font-size:.82rem;color:var(--muted2);margin-bottom:1rem;line-height:1.6">
            WhatsApp no permite usar el GPS.<br>
            Para que funcione correctamente, abre la app en <strong>Google Chrome</strong>.
          </div>
          <div style="background:var(--card);border-radius:.75rem;padding:.75rem;margin-bottom:1rem;font-size:.78rem;color:var(--muted2);text-align:left">
            1. Toca los <strong>3 puntos ‚ãÆ</strong> arriba a la derecha<br>
            2. Selecciona <strong>"Abrir en Chrome"</strong><br>
            3. El GPS funcionar√° autom√°ticamente
          </div>
          <button class="btn btn-primary btn-full" onclick="closeAlertaModal()">Entendido</button>
        </div>`;
      document.getElementById('modal-alerta').classList.add('open');
    },1500);
    return;
  }

  const dot=document.getElementById('gps-dot');
  const txt=document.getElementById('gps-txt');
  if(txt)txt.textContent='GPS...';

  // Verificar permiso primero si la API est√° disponible
  if(navigator.permissions){
    navigator.permissions.query({name:'geolocation'}).then(result=>{
      if(result.state==='denied'){
        if(dot)dot.className='gps-dot';
        if(txt)txt.textContent='GPS ‚úó';
        mostrarDialogoGPS();
        return;
      }
      _iniciarGPSWatch();
    }).catch(()=>_iniciarGPSWatch());
  } else {
    _iniciarGPSWatch();
  }
}

function _iniciarGPSWatch(){
  const dot=document.getElementById('gps-dot');
  const txt=document.getElementById('gps-txt');
  // getCurrentPosition primero para mostrar el popup de permiso r√°pido
  navigator.geolocation.getCurrentPosition(
    p=>{
      userPos={lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy,ts:Date.now()};
      if(dot){dot.className='gps-dot on';}
      if(txt)txt.textContent='GPS ‚úì';
      // Watch continuo despu√©s del primer fix
      gpsWatcher=navigator.geolocation.watchPosition(
        wp=>{
          userPos={lat:wp.coords.latitude,lng:wp.coords.longitude,acc:wp.coords.accuracy,ts:Date.now()};
          if(dot)dot.className='gps-dot on';
          if(txt)txt.textContent='GPS ‚úì';
          if(_mapa)actualizarUserMarkerMapa();
        },
        ()=>{},
        {enableHighAccuracy:true,maximumAge:10000,timeout:30000}
      );
    },
    err=>{
      if(dot)dot.className='gps-dot';
      if(txt)txt.textContent='GPS ‚úó';
      if(err.code===1)mostrarDialogoGPS();
      else mostrarSyncToast('‚ö†Ô∏è GPS no disponible. Verifica la se√±al.');
    },
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
}

function mostrarDialogoGPS(){
  document.getElementById('modal-alerta-content').innerHTML=`
    <div class="modal-handle"></div>
    <div style="text-align:center;padding:1rem 0">
      <div style="font-size:2.5rem;margin-bottom:.5rem">üìç</div>
      <div class="modal-title">GPS desactivado</div>
      <div style="font-size:.82rem;color:var(--muted2);margin-bottom:1.25rem">Para registrar visitas y evidencias con ubicaci√≥n, necesitas activar el GPS.</div>
      <button class="btn btn-primary btn-full" onclick="solicitarGPS()" style="font-size:.95rem;padding:.8rem">
        üì° Activar GPS ahora
      </button>
      <button class="btn btn-secondary btn-full" style="margin-top:.5rem" onclick="closeAlertaModal()">Continuar sin GPS</button>
    </div>`;
  document.getElementById('modal-alerta').classList.add('open');
}

function solicitarGPS(){
  closeAlertaModal();
  navigator.geolocation.getCurrentPosition(
    p=>{
      userPos={lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy,ts:Date.now()};
      const dot=document.getElementById('gps-dot');
      const txt=document.getElementById('gps-txt');
      if(dot)dot.className='gps-dot on';
      if(txt)txt.textContent='GPS ‚úì';
      mostrarSyncToast('‚úÖ GPS activado correctamente');
    },
    err=>{
      // Si sigue bloqueado, mostrar alerta simple para ir a configuraci√≥n
      if(err.code===1){
        if(confirm('El GPS est√° bloqueado en el navegador.\n\n¬øAbrir configuraci√≥n del celular para activarlo?')){
          // En Android abre configuraci√≥n de ubicaci√≥n
          window.open('intent://settings#Intent;action=android.settings.LOCATION_SOURCE_SETTINGS;end','_blank');
        }
      } else {
        mostrarSyncToast('‚ö†Ô∏è No se pudo obtener GPS. Intenta de nuevo.');
      }
    },
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
}

function stopGPS(){if(gpsWatcher)navigator.geolocation.clearWatch(gpsWatcher);userPos=null;}

async function getGPS(){
  return new Promise((res,rej)=>{
    if(!navigator.geolocation)return rej('No GPS');
    if(userPos&&(Date.now()-userPos.ts)<20000)return res(userPos);
    navigator.geolocation.getCurrentPosition(
      p=>{
        userPos={lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy,ts:Date.now()};
        res(userPos);
      },
      err=>rej('GPS error: '+err.message),
      {enableHighAccuracy:true,timeout:15000,maximumAge:0}
    );
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LOGIN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLogin(){
  const p=document.getElementById('login-pass');
  const e=document.getElementById('login-err');
  const u=document.getElementById('login-user');
  if(u)u.value='';
  if(p){p.value='';p.type='password';}
  if(e)e.style.display='none';
  const btn=document.getElementById('btn-toggle-pw');
  if(btn)btn.textContent='üëÅÔ∏è';
  const pinWrap=document.getElementById('login-pin-wrap');
  if(pinWrap)pinWrap.style.display='none';
  const userBtns=document.getElementById('login-user-btns');
  if(userBtns)userBtns.style.display='flex';
  renderLoginUserBtns();
}
function togglePw(){
  const inp=document.getElementById('login-pass');
  const btn=document.getElementById('btn-toggle-pw');
  if(!inp||!btn)return;
  if(inp.type==='password'){inp.type='text';btn.textContent='üôà';}
  else{inp.type='password';btn.textContent='üëÅÔ∏è';}
}
function renderLoginUserBtns(){
  const wrap=document.getElementById('login-user-btns');
  if(!wrap)return;
  const colores={admin:'linear-gradient(135deg,#00d4ff,#7c4dff)',vendedor:'linear-gradient(135deg,#00e676,#009688)',super:'linear-gradient(135deg,#ff9800,#ff3d57)'};
  wrap.innerHTML=USUARIOS_BASE.filter(u=>u.activo!==false).map(u=>`
    <button class="user-btn" onclick="selUsuarioLogin('${u.username}')">
      <div class="u-avatar" style="background:${colores[u.rol]||colores.vendedor};color:#000;font-size:.8rem;font-weight:800">${u.nombre.charAt(0)}</div>
      <div>
        <div class="user-name">${u.nombre}</div>
        <div class="user-rol">${u.rol}</div>
      </div>
      <div style="margin-left:auto;font-size:.65rem;color:var(--muted)">‚Üí</div>
    </button>`).join('');
}
function selUsuarioLogin(username){
  document.getElementById('login-user').value=username;
  document.getElementById('login-user-btns').style.display='none';
  document.getElementById('login-pin-wrap').style.display='block';
  document.getElementById('login-pass').value='';
  document.getElementById('login-pass').type='password';
  const btn=document.getElementById('btn-toggle-pw');
  if(btn)btn.textContent='üëÅÔ∏è';
  document.getElementById('login-err').style.display='none';
  setTimeout(()=>document.getElementById('login-pass').focus(),100);
}
function cancelarSelUsuario(){
  document.getElementById('login-user').value='';
  document.getElementById('login-pass').value='';
  document.getElementById('login-pin-wrap').style.display='none';
  document.getElementById('login-user-btns').style.display='flex';
  document.getElementById('login-err').style.display='none';
}
function intentarLogin(){
  const userInput=(document.getElementById('login-user').value||'').trim().toLowerCase();
  const passInput=(document.getElementById('login-pass').value||'').trim();
  const errEl=document.getElementById('login-err');
  errEl.style.display='none';

  // Buscar en usuarios del array (pueden venir de localStorage o del default)
  // PLUS siempre buscar en USUARIOS_BASE como fallback garantizado
  const todosUsr=[...usuarios,...USUARIOS_BASE.filter(b=>!usuarios.find(u=>u.username===b.username))];
  const u=todosUsr.find(u=>u.activo!==false&&(
    (u.username||'').toLowerCase()===userInput||
    u.nombre.toLowerCase()===userInput||
    u.nombre.toLowerCase().split(' ')[0]===userInput
  ));

  if(!u){errEl.style.display='block';return;}

  const passOk=(u.pass&&u.pass===passInput)||(u.pin&&u.pin===passInput);
  if(!passOk){
    errEl.style.display='block';
    document.getElementById('login-pass').value='';
    document.getElementById('login-pass').focus();
    return;
  }
  doLogin(u);
}
function doLogin(u){
  session=u;
  document.getElementById('login-screen').style.display='none';
  document.getElementById('main-app').style.display='flex';
  document.getElementById('app-title').textContent=config.negocio;
  document.getElementById('app-user').textContent=u.nombre+' ¬∑ '+(sucursales.find(s=>s.id===u.sucursalId)?.nombre||'Todas las sucursales');
  // Mostrar bot√≥n Dev solo al admin
  const isAdm=u.rol==='admin'||u.rol==='super';
  document.getElementById('ia-fab').style.display='flex';
  document.getElementById('ia-btn-hdr').style.display=isAdm?'flex':'none';
  buildNav();goTab('inicio');startGPS();
  // Cargar datos desde Firebase al iniciar sesi√≥n
  (async()=>{
    const btn=document.getElementById('sync-btn');
    const icon=document.getElementById('sync-icon');
    const lbl=document.getElementById('sync-label');
    if(btn){btn.classList.add('syncing');if(icon)icon.textContent='üî•';if(lbl)lbl.textContent='...';}
    await syncAll();
    // Refrescar UI con datos frescos de Firebase
    if(currentTab==='inicio')renderInicio();
    else if(currentTab==='rutas')renderRutas();
    if(btn){btn.classList.remove('syncing');if(icon)icon.textContent='‚úì';if(lbl)lbl.textContent='OK';}
    mostrarSyncToast('‚úÖ Conectado a la nube');
    setTimeout(()=>{if(icon)icon.textContent='üîÑ';if(lbl)lbl.textContent='Sync';},2500);
    setTimeout(()=>updateAlertaBadge(),200);
  })();
  startSync(); // Activa listener de Firebase en tiempo real
  // Pedir permiso de notificaciones
  if(Notification&&Notification.permission==='default'){
    setTimeout(()=>Notification.requestPermission().catch(()=>{}),2000);
  }
  setTimeout(()=>{updateAlertaBadge();_watchMapaGPS();},800);
}
function logout(){session=null;stopGPS();stopSync();iaOpen=false;document.getElementById('ia-panel').classList.remove('open');document.getElementById('login-screen').style.display='flex';document.getElementById('main-app').style.display='none';iaHistory=[];// Limpiar datos de versiones anteriores si los usuarios no tienen 'pass'
(function(){
  try {
    const k='pp3_usuarios';
    const raw=localStorage.getItem(k);
    if(raw){
      const arr=JSON.parse(raw);
      // Si alg√∫n usuario base no tiene pass, borrar cache para forzar carga limpia
      const necesitaReset=arr.some(u=>(u.id<=4)&&!u.pass);
      if(necesitaReset){ localStorage.removeItem(k); }
    }
  } catch(e){}
})();
renderLogin();}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NAV
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildNav(){
  const isAdmin=session.rol==='admin'||session.rol==='super';
  const tabs=[
    {id:'inicio',icon:'üè†',label:'Inicio'},
    {id:'nuevo',icon:'üõí',label:'Pedido'},
    {id:'pedidos',icon:'üìã',label:'Pedidos'},
    {id:'clientes',icon:'üë•',label:'Clientes'},
    {id:'rutas',icon:'üó∫Ô∏è',label:'Rutas'},
    ...(isAdmin?[{id:'reportes',icon:'üìä',label:'Reportes'},{id:'exhibiciones',icon:'üñºÔ∏è',label:'Exhibic.'},{id:'productos',icon:'üì¶',label:'Productos'},{id:'importar',icon:'‚¨ÜÔ∏è',label:'Importar'},{id:'ajustes',icon:'‚öôÔ∏è',label:'Ajustes'}]:[]),
  ];
  const nav=document.getElementById('main-nav');
  nav.innerHTML='';
  tabs.forEach(t=>{
    const b=document.createElement('button');
    b.className='nav-btn';b.id='nav-'+t.id;
    b.innerHTML=`<span class="nav-icon">${t.icon}</span><p class="nav-label">${t.label}</p>`;
    b.onclick=()=>goTab(t.id);
    nav.appendChild(b);
  });
}
let tabHistory=[];
function goTab(id){
  if(currentTab&&currentTab!==id)tabHistory.push(currentTab);
  if(tabHistory.length>10)tabHistory.shift();
  currentTab=id;
  // Mostrar/ocultar bot√≥n atr√°s
  const btnBack=document.getElementById('btn-back');
  if(btnBack)btnBack.style.display=tabHistory.length>0?'block':'none';
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id)?.classList.add('active');
  document.getElementById('nav-'+id)?.classList.add('active');
  if(id==='inicio')renderInicio();
  if(id==='nuevo'){
    // Solo resetear cliente si NO viene precargado desde una ruta
    if(!window._pedidoRutaCtx){
      carrito={};
      pedidoCliente={id:null,nombre:'',telefono:'',direccion:'',nota:'',ciudad:''};
      pedidoStepNum=1;
    } else {
      carrito={};
      pedidoStepNum=2;
      // Limpiar contexto despu√©s de usarlo
      setTimeout(()=>{ window._pedidoRutaCtx=null; },500);
    }
    renderPedidoStep();
  }
  if(id==='pedidos')renderPedidos();
  if(id==='clientes')renderClientes();
  if(id==='rutas')renderRutas();
  if(id==='reportes')renderReportes();
  if(id==='exhibiciones')renderExhibiciones();
  if(id==='importar')renderImportar();
  if(id==='productos')renderProductos();
  if(id==='ajustes')renderAjustes();
}
function goBack(){
  if(tabHistory.length===0)return;
  const prev=tabHistory.pop();
  currentTab=prev;
  const btnBack=document.getElementById('btn-back');
  if(btnBack)btnBack.style.display=tabHistory.length>0?'block':'none';
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+prev)?.classList.add('active');
  document.getElementById('nav-'+prev)?.classList.add('active');
  if(prev==='inicio')renderInicio();
  if(prev==='pedidos')renderPedidos();
  if(prev==='clientes')renderClientes();
  if(prev==='rutas')renderRutas();
  if(prev==='reportes')renderReportes();
  if(prev==='exhibiciones')renderExhibiciones();
  if(prev==='productos')renderProductos();
  if(prev==='ajustes')renderAjustes();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INICIO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const badgeClass=e=>e==='completado'?'b-done':e==='cancelado'?'b-cancel':e==='facturado'?'b-fact':'b-pend';

function renderInicio(){
  const hoy=todayStr();
  const isAdmin=session.rol==='admin'||session.rol==='super';
  const pedHoy=pedidos.filter(p=>new Date(p.timestamp).toDateString()===hoy);
  const ventas=p=>['completado','facturado'].includes(p.estado);
  const ventasHoy=pedHoy.filter(ventas).reduce((s,p)=>s+p.total,0);
  const totalGral=pedidos.filter(ventas).reduce((s,p)=>s+p.total,0);
  const misP=isAdmin?pedidos:pedidos.filter(p=>p.vendedor===session.nombre);
  const stockBajo=productos.filter(p=>p.stock<=(p.stockMin||config.stockMinGlobal||5));
  const rutaHoy=rutas.filter(r=>r.vendedor===session.nombre&&new Date(r.timestamp).toDateString()===hoy&&r.estado==='en_curso');

  // PWA install
  const _isPWA=window.matchMedia('(display-mode: standalone)').matches;
  const _isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent);
  let pwaBan='';
  if(!_isPWA){
    if(pwaPrompt){
      pwaBan=`<div class="pwa-banner" style="margin-bottom:.6rem">
        <span style="font-size:1.4rem">üì≤</span>
        <div style="flex:1"><div class="fw7" style="font-size:.82rem">¬°Instala PedidosPro!</div><div class="text-xs text-muted">√ösala sin internet ¬∑ r√°pida y como app nativa</div></div>
        <button class="btn btn-primary btn-sm" style="white-space:nowrap" onclick="installPWA()">Instalar</button>
      </div>`;
    } else if(_isIOS){
      pwaBan=`<div class="pwa-banner" style="margin-bottom:.6rem" onclick="ajusteTabActual='app';goTab('ajustes')" style="cursor:pointer">
        <span style="font-size:1.4rem">üçé</span>
        <div style="flex:1"><div class="fw7" style="font-size:.82rem">Instala la app en tu iPhone</div><div class="text-xs text-muted">Toca aqu√≠ para ver c√≥mo instalarla</div></div>
        <span style="color:var(--accent);font-size:1rem">‚Üí</span>
      </div>`;
    }
  }

  let stats='';
  if(isAdmin){
    stats=`<div class="stats-grid">
      <div class="stat"><div class="stat-val c-accent">${fmt(ventasHoy)}</div><div class="stat-lbl">Ventas hoy</div></div>
      <div class="stat"><div class="stat-val c-green">${pedHoy.length}</div><div class="stat-lbl">Pedidos hoy</div></div>
      <div class="stat"><div class="stat-val c-orange">${clientes.filter(c=>c.activo).length}</div><div class="stat-lbl">Clientes</div></div>
      <div class="stat"><div class="stat-val c-purple">${productos.length}</div><div class="stat-lbl">Productos</div></div>
    </div>
    ${stockBajo.length?`<div class="stock-alert">‚ö†Ô∏è <strong>${stockBajo.length} producto${stockBajo.length>1?'s':''}</strong> con stock bajo: ${stockBajo.map(p=>p.nombre).join(', ')}</div>`:''}
    ${productos.filter(p=>p.stock===0).length?`<div class="alert a-err" style="margin-top:.4rem">üö® <strong>${productos.filter(p=>p.stock===0).length} sin stock:</strong> ${productos.filter(p=>p.stock===0).map(p=>p.nombre).join(', ')}</div>`:''}
    <div class="card" style="text-align:center">
      <div class="text-xs text-muted" style="margin-bottom:.3rem;text-transform:uppercase;letter-spacing:.07em">Total acumulado</div>
      <div class="mono c-accent" style="font-size:1.8rem;font-weight:700">${fmt(totalGral)}</div>
      <div class="text-muted text-sm" style="margin-top:.2rem">${pedidos.filter(ventas).length} pedidos completados</div>
    </div>
    <div class="card" style="border-color:rgba(0,230,118,.15)">
      <div class="card-title" style="margin-bottom:.5rem">üë• Estado del equipo hoy</div>
      ${usuarios.filter(u=>u.rol==='vendedor'&&u.activo).map(u=>{
        const rutaU=rutas.find(r=>r.vendedor===u.nombre&&r.estado==='en_curso');
        const hoyDia=['DOM','LUN','MAR','MIE','JUE','VIE','SAB'][new Date().getDay()];
        const rutaHoyU=!rutaU&&rutas.find(r=>r.vendedor===u.nombre&&r.estado==='pendiente'&&r.dia===hoyDia);
        const pedHoyU=pedidos.filter(p=>p.vendedor===u.nombre&&new Date(p.timestamp).toDateString()===new Date().toDateString()&&['completado','facturado'].includes(p.estado));
        const rutaRef=rutaU||rutaHoyU;
        const vis=rutaRef?rutaRef.paradas.filter(p=>p.visitado).length:0;
        const tot=rutaRef?rutaRef.paradas.length:0;
        return `<div class="row-between" style="padding:.4rem 0;border-bottom:1px solid var(--border)">
          <div class="row"><div class="u-avatar u-av-vendor" style="width:30px;height:30px;font-size:.75rem;border-radius:.4rem">${u.nombre.charAt(0)}</div>
          <div><div class="fw7 text-sm">${u.nombre}</div>
          <div class="text-xs text-muted">${rutaRef?`üó∫Ô∏è ${rutaRef.nombre} ¬∑ ${vis}/${tot} visitas`:'Sin ruta hoy'}</div></div></div>
          <div style="text-align:right">
            <div class="text-accent mono" style="font-size:.8rem">${fmt(pedHoyU.reduce((s,p)=>s+p.total,0))}</div>
            <div class="text-xs text-muted">${pedHoyU.length} pedidos${rutaU?'<span class="badge b-fact" style="margin-left:.3rem">EN RUTA</span>':''}</div>
          </div></div>`;
      }).join('')}
    </div>
    <button class="btn btn-purple btn-full" onclick="abrirModalAlertaAdmin()">üì£ Enviar mensaje al equipo</button>`;
  } else {
    const myV=misP.filter(ventas);
    // Rutero del d√≠a: primero en_curso, luego pendiente de hoy
    const misRutasVend=rutas.filter(r=>r.vendedor===session.nombre);
    const rutaEnCurso=misRutasVend.find(r=>r.estado==='en_curso');
    const hoyDIA=['DOM','LUN','MAR','MIE','JUE','VIE','SAB'][new Date().getDay()];
    const rutaHoyPend=!rutaEnCurso&&misRutasVend.find(r=>r.estado==='pendiente'&&r.dia===hoyDIA);
    const rutaA=rutaEnCurso||rutaHoyPend||rutaHoy[0];
    const visitadasRuta=rutaA?rutaA.paradas.filter(p=>p.visitado).length:0;
    const pendientesRuta=rutaA?rutaA.paradas.filter(p=>!p.visitado&&!p.omitido).length:0;
    const pctRuta=rutaA?Math.round(visitadasRuta/rutaA.paradas.length*100):0;

    // Alertas sin leer
    const misAlertasNew=alertas.filter(a=>(a.para===session.nombre||a.para==='todos')&&!a.leida);

    stats=`<div class="stats-grid">
      <div class="stat"><div class="stat-val c-accent">${myV.length}</div><div class="stat-lbl">Mis ventas</div></div>
      <div class="stat"><div class="stat-val c-green">${fmt(myV.reduce((s,p)=>s+p.total,0))}</div><div class="stat-lbl">Mi total</div></div>
      <div class="stat"><div class="stat-val c-purple">${misP.filter(p=>p.estado==='pendiente').length}</div><div class="stat-lbl">Pendientes</div></div>
      <div class="stat"><div class="stat-val c-orange">${misRutasVend.length}</div><div class="stat-lbl">Mis rutas</div></div>
    </div>
    ${misAlertasNew.length?`<div class="alert a-warn" style="cursor:pointer" onclick="toggleIA()">üì£ <strong>${misAlertasNew.length} mensaje${misAlertasNew.length>1?'s':''} nuevo${misAlertasNew.length>1?'s':''}</strong> de tu coordinador. <span style="color:var(--accent)">Ver ‚Üí</span></div>`:''}
    ${rutaA?`<div class="route-card" style="border-color:rgba(0,212,255,.25);cursor:pointer" onclick="goTab('rutas')">
      <div class="row-between" style="margin-bottom:.35rem">
        <div><div class="fw7 text-sm">üó∫Ô∏è ${rutaA.nombre}</div>
        <div class="text-xs text-muted">${rutaA.vendedor} ¬∑ ${rutaA.paradas.length} paradas</div></div>
        <span class="badge ${rutaEnCurso?'b-fact':'b-pend'}">${rutaEnCurso?'EN CURSO':'HOY'}</span>
      </div>
      <div class="route-progress" style="margin:.4rem 0"><div class="route-bar" style="width:${pctRuta}%"></div></div>
      <div class="text-xs text-muted" style="margin-bottom:.5rem">${visitadasRuta}/${rutaA.paradas.length} visitas ¬∑ ${pendientesRuta} pendientes (${pctRuta}%)</div>
      <div class="btn-row">
        ${rutaEnCurso?`<button class="btn btn-teal btn-sm" style="flex:1" onclick="event.stopPropagation();abrirMapaRuta('${rutaA.id}')">üó∫Ô∏è Mapa</button>`:''}
        <button class="btn btn-primary" style="flex:2" onclick="event.stopPropagation();${rutaEnCurso?`goTab('rutas')`:`iniciarRutaPendiente('${rutaA.id}');goTab('rutas')`}">${rutaEnCurso?'Ver ruta en curso ‚Üí':'‚ñ∂ Iniciar ruta de hoy'}</button>
      </div>
    </div>`:`<div class="card2 text-muted" style="text-align:center;padding:1.2rem"><div style="font-size:1.5rem">üó∫Ô∏è</div><div class="text-sm" style="margin-top:.3rem">Sin ruta asignada hoy</div><button class="btn btn-secondary btn-sm" style="margin-top:.5rem" onclick="goTab('rutas')">Ver todas mis rutas</button></div>`}`;
  }

  const ultimos=pedidos.slice(-5).reverse();
  let ul=ultimos.length?ultimos.map(p=>`<div class="order-item"><div><div class="oi-name">${p.cliente}</div><div class="oi-detail">${p.vendedor} ¬∑ ${new Date(p.timestamp).toLocaleTimeString('es-CO')}</div></div><div style="text-align:right"><div class="text-accent fw7 mono" style="font-size:.825rem">${fmt(p.total)}</div><span class="badge ${badgeClass(p.estado)}">${p.estado}</span></div></div>`).join(''):'<div class="text-muted text-sm">Sin pedidos a√∫n</div>';

  document.getElementById('inicio-content').innerHTML=`
    ${trialBanner()}
    ${pwaBan}
    <div class="card" style="background:linear-gradient(135deg,rgba(0,212,255,.07),rgba(124,77,255,.04));border-color:rgba(0,212,255,.18)">
      <div class="text-xs text-muted" style="margin-bottom:.2rem">Bienvenido</div>
      <div class="fw7" style="font-size:1.3rem">${session.nombre} üëã</div>
      <div class="text-muted" style="font-size:.75rem;margin-top:.1rem">${nowStr()}</div>
    </div>
    ${stats}
    <div class="card"><div class="card-title">üïê √öltimos pedidos</div>${ul}</div>`;
}

function installPWA(){if(pwaPrompt){pwaPrompt.prompt();pwaPrompt.userChoice.then(r=>{pwaPrompt=null;renderInicio();});}}

function compartirApp(){
  const url=location.href.split('?')[0];
  if(navigator.share){navigator.share({title:'PedidosPro',text:'Instala PedidosPro ‚Äî App de ventas y rutas',url});}
  else{copiarUrlApp();}
}

function copiarUrlApp(){
  const url=location.href.split('?')[0];
  navigator.clipboard.writeText(url).then(()=>{
    const t=document.createElement('div');
    t.textContent='‚úÖ Enlace copiado';
    t.style.cssText='position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);color:var(--text);padding:.5rem 1.2rem;border-radius:2rem;font-size:.82rem;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,.5)';
    document.body.appendChild(t);setTimeout(()=>t.remove(),2200);
  }).catch(()=>prompt('Copia este enlace:',url));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// NUEVO PEDIDO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pedidoStep(n){
  if(n===2&&!pedidoCliente.nombre)return alert('Ingresa el nombre del cliente');
  if(n===3&&!Object.keys(carrito).length)return alert('Agrega al menos un producto');
  pedidoStepNum=n;renderPedidoStep();
}
function renderPedidoStep(){
  ['tab1','tab2','tab3'].forEach((id,i)=>document.getElementById(id).className='tab'+(pedidoStepNum===i+1?' active':''));
  const c=document.getElementById('pedido-content');
  // Si el cliente ya viene precargado desde ruta, mostrar banner y ir directo a productos
  if(pedidoStepNum===2&&pedidoCliente.nombre){
    const banner=`<div style="background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);border-radius:.75rem;padding:.6rem .875rem;margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem;font-size:.82rem">
      <span style="font-size:1.1rem">üë§</span>
      <div><strong>${pedidoCliente.nombre}</strong><br><span style="color:var(--muted);font-size:.7rem">${pedidoCliente.direccion||''}</span></div>
      <button onclick="pedidoStep(1)" style="margin-left:auto;background:none;border:1px solid var(--border);border-radius:.4rem;padding:.2rem .5rem;color:var(--muted);cursor:pointer;font-size:.7rem">Cambiar</button>
    </div>`;
    renderStep2(c, banner);
  } else if(pedidoStepNum===1)renderStep1(c);
  else if(pedidoStepNum===2)renderStep2(c,'');
  else renderStep3(c);
}
function renderStep1(c){
  const opts=clientes.filter(cl=>cl.activo).map(cl=>`<option value="${cl.id}">${cl.nombre}${cl.telefono?' ‚Äì '+cl.telefono:''}</option>`).join('');
  c.innerHTML=`<div class="card"><div class="card-title">üë§ Datos del cliente</div>
  <div class="form-stack">
    <div class="field"><label class="label">Cliente registrado</label>
      <select class="input" id="cli-select" onchange="selCliente(this.value)"><option value="">‚Äî Ingreso manual ‚Äî</option>${opts}</select>
    </div>
    <div class="field"><label class="label">Nombre *</label><input class="input" id="cli-nombre" placeholder="Nombre completo" value="${pedidoCliente.nombre}" oninput="pedidoCliente.nombre=this.value"/></div>
    <div class="form-grid">
      <div class="field"><label class="label">Tel√©fono</label><input class="input" id="cli-tel" type="tel" value="${pedidoCliente.telefono}" oninput="pedidoCliente.telefono=this.value"/></div>
      <div class="field"><label class="label">Ciudad</label><input class="input" id="cli-ciu" value="${pedidoCliente.ciudad||''}" oninput="pedidoCliente.ciudad=this.value"/></div>
    </div>
    <div class="field"><label class="label">Direcci√≥n</label><input class="input" id="cli-dir" value="${pedidoCliente.direccion}" oninput="pedidoCliente.direccion=this.value"/></div>
    <div class="field"><label class="label">Nota</label><input class="input" id="cli-nota" value="${pedidoCliente.nota}" oninput="pedidoCliente.nota=this.value"/></div>
    <button class="btn btn-primary btn-full" onclick="if(pedidoCliente.nombre)pedidoStep(2);else alert('Ingresa el nombre del cliente')">Continuar ‚Üí</button>
  </div></div>`;
  if(pedidoCliente.id)document.getElementById('cli-select').value=pedidoCliente.id;
}
function selCliente(id){
  if(!id){pedidoCliente={id:null,nombre:'',telefono:'',direccion:'',nota:'',ciudad:''};renderStep1(document.getElementById('pedido-content'));return;}
  const cl=clientes.find(c=>c.id===Number(id));
  if(cl){pedidoCliente={id:cl.id,nombre:cl.nombre,telefono:cl.telefono||'',direccion:cl.direccion||'',nota:'',ciudad:cl.ciudad||''};renderStep1(document.getElementById('pedido-content'));}
}
function renderStep2(c, banner=''){
  const cats=['Todos',...new Set(productos.map(p=>p.categoria))];
  const busq=prodBusq.toLowerCase();
  const filtered=productos.filter(p=>(prodCat==='Todos'||p.categoria===prodCat)&&p.nombre.toLowerCase().includes(busq));
  const total=calcTotal();
  const items=Object.values(carrito).reduce((s,q)=>s+q,0);
  let grid=filtered.map(p=>{
    const q=carrito[p.id]||0;
    const lowStock=p.stock<=(p.stockMin||5);
    return `<div class="prod-card${q?' sel':''}${lowStock?' low-stock':''}">
      ${q?`<div class="prod-badge">${q}</div>`:''}
      <div class="prod-emoji">${p.emoji}</div>
      <div class="prod-name">${p.nombre}</div>
      <div class="prod-price">${fmt(p.precio)}</div>
      <div class="prod-stock${lowStock?' text-orange':''}">Stock: ${p.stock}${lowStock?' ‚ö†Ô∏è':''}</div>
      <div class="qty-ctrl">
        <button class="qty-btn" onclick="setQty(${p.id},${q-1})">‚àí</button>
        <div class="qty-val">${q}</div>
        <button class="qty-btn" onclick="setQty(${p.id},${q+1})">+</button>
      </div>
    </div>`;
  }).join('');
  const chips=cats.map(cat=>`<button class="chip${prodCat===cat?' active':''}" onclick="prodCat='${cat}';renderPedidoStep()">${cat}</button>`).join('');
  c.innerHTML=`${banner}<div class="search-wrap"><span class="search-ico">üîç</span><input class="input" placeholder="Buscar producto..." value="${prodBusq}" oninput="prodBusq=this.value;renderPedidoStep()"/></div>
    <div class="chips">${chips}</div>
    <div class="prod-grid">${grid||'<div class="empty" style="grid-column:span 2"><div class="empty-ico">üì¶</div>Sin productos</div>'}</div>
    ${items?`<div class="sticky-bottom"><button class="btn btn-primary btn-full" onclick="pedidoStep(3)">Ver resumen ¬∑ ${fmt(total)} (${items} items)</button></div>`:''}`;
}
function setQty(id,q){if(q<=0)delete carrito[id];else carrito[id]=q;renderPedidoStep();}
function calcTotal(){return Object.entries(carrito).reduce((s,[id,q])=>{const p=productos.find(pr=>pr.id===Number(id));return s+(p?p.precio*q:0);},0);}
function renderStep3(c){
  const sub=calcTotal();
  const desc=Number(document.getElementById('desc-val')?.value||0);
  const descM=sub*desc/100;
  const total=sub-descM;
  const items=Object.entries(carrito).map(([id,q])=>{const p=productos.find(pr=>pr.id===Number(id));return p?`<div class="order-item"><div><div class="oi-name">${p.emoji} ${p.nombre}</div><div class="oi-detail">${fmt(p.precio)} √ó ${q}</div></div><div class="text-accent fw7 mono" style="font-size:.825rem">${fmt(p.precio*q)}</div></div>`:''}).join('');
  c.innerHTML=`<div class="card"><div class="card-title">üìã Resumen del pedido</div>
  <div class="alert a-info">üë§ <strong>${pedidoCliente.nombre}</strong>${pedidoCliente.telefono?'<br>üìû '+pedidoCliente.telefono:''}${pedidoCliente.direccion?'<br>üìç '+pedidoCliente.direccion:''}</div>
  ${items}
  <div class="divider"></div>
  <div class="form-grid" style="margin-bottom:.75rem">
    <div class="field"><label class="label">Descuento %</label><input class="input" type="number" id="desc-val" value="${desc}" min="0" max="100" oninput="renderStep3(document.getElementById('pedido-content'))"/></div>
    <div class="field"><label class="label">Forma de pago</label>
      <select class="input" id="pago-forma">
        <option value="efectivo">üíµ Efectivo</option>
        <option value="transferencia">üè¶ Transferencia</option>
        <option value="credito">üìÖ Cr√©dito</option>
        <option value="datafono">üí≥ Dat√°fono</option>
      </select>
    </div>
  </div>
  ${desc?`<div class="fact-total-row text-sm"><span class="text-muted">Subtotal</span><span class="mono">${fmt(sub)}</span></div><div class="fact-total-row text-sm"><span class="text-muted">Descuento (${desc}%)</span><span class="text-red mono">-${fmt(descM)}</span></div>`:''}
  <div class="order-total"><div class="ot-lbl">Total a pagar</div><div class="ot-val">${fmt(total)}</div></div>
  <div class="btn-row mt-1">
    <button class="btn btn-secondary" style="flex:1" onclick="pedidoStep(2)">‚Üê Editar</button>
    <button class="btn btn-success" style="flex:2" onclick="confirmarPedido()">‚úì Confirmar pedido</button>
  </div></div>`;
}
function confirmarPedido(){
  const sub=calcTotal();
  const desc=Number(document.getElementById('desc-val')?.value||0);
  const descM=sub*desc/100;
  const total=sub-descM;
  const pago=document.getElementById('pago-forma')?.value||'efectivo';
  const items=Object.entries(carrito).map(([id,q])=>{const p=productos.find(pr=>pr.id===Number(id));return{id:Number(id),nombre:p.nombre,precio:p.precio,qty:q,subtotal:p.precio*q,emoji:p.emoji};});
  // Bajar stock
  items.forEach(i=>{const pi=productos.findIndex(p=>p.id===i.id);if(pi>=0)productos[pi].stock=Math.max(0,productos[pi].stock-i.qty);});
  const numero=(pedidos.length+1).toString().padStart(5,'0');
  const ped={id:genId(),numero,cliente:pedidoCliente.nombre,clienteId:pedidoCliente.id||null,
    telefono:pedidoCliente.telefono,direccion:pedidoCliente.direccion,nota:pedidoCliente.nota,ciudad:pedidoCliente.ciudad,
    items,subtotal:sub,descuento:desc,descuentoMonto:descM,total,formaPago:pago,
    vendedor:session.nombre,sucursalId:session.sucursalId||null,timestamp:Date.now(),estado:'pendiente',gps:userPos||null};
  pedidos.push(ped);sp();
  // Si el pedido viene desde una parada de ruta, marcar visita autom√°ticamente
  if(window._pedidoRutaCtx){
    const {rutaId,idx}=window._pedidoRutaCtx;
    window._pedidoRutaCtx=null;
    const ri=rutas.findIndex(r=>String(r.id)===rutaId);
    if(ri>=0){
      rutas[ri].paradas[idx].visitado=true;
      rutas[ri].paradas[idx].visitadoTs=Date.now();
      rutas[ri].paradas[idx].gps=userPos||null;
      rutas[ri].paradas[idx].pedidoId=ped.id;
      sp();
    }
  }
  showSuccess(ped);
}
function showSuccess(ped){
  const c=document.getElementById('pedido-content');
  document.getElementById('pedido-tabs').style.display='none';
  const wa=encodeURIComponent(`üõí *PEDIDO #${ped.numero} - ${config.negocio}*\nüë§ ${ped.cliente}\n${ped.direccion?'üìç '+ped.direccion+'\n':''}${ped.telefono?'üìû '+ped.telefono+'\n':''}\n*PRODUCTOS:*\n${ped.items.map(i=>`‚Ä¢ ${i.nombre} √ó${i.qty} = ${fmt(i.subtotal)}`).join('\n')}\n\n${ped.descuento?`üè∑Ô∏è Desc. ${ped.descuento}%: -${fmt(ped.descuentoMonto)}\n`:''}üí∞ *TOTAL: ${fmt(ped.total)}*\nüí≥ Pago: ${ped.formaPago}\nüïê ${new Date(ped.timestamp).toLocaleString('es-CO')}`);
  c.innerHTML=`<div class="success-screen"><div class="success-ico">‚úÖ</div><div class="success-title">¬°Pedido creado!</div><div class="success-sub">#${ped.numero} ¬∑ ${fmt(ped.total)}</div>
  <div class="success-actions">
    <button class="btn btn-primary btn-full" onclick="generarFactura('${ped.id}')">üßæ Generar Factura</button>
    <a href="https://wa.me/${fmtWA(ped.telefono)}?text=${wa}" target="_blank" class="btn btn-wa btn-full">üì≤ WhatsApp</a>
    <button class="btn btn-secondary btn-full" onclick="document.getElementById('pedido-tabs').style.display='';carrito={};pedidoCliente={id:null,nombre:'',telefono:'',direccion:'',nota:'',ciudad:''};pedidoStepNum=1;renderPedidoStep()">+ Nuevo pedido</button>
  </div></div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PEDIDOS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setFiltro(f){
  filtroEstado=f;
  ['todos','pendiente','completado','cancelado','facturado'].forEach(x=>{const e=document.getElementById('fchip-'+x);if(e)e.className='chip'+(f===x?' active':'');});
  renderPedidos();
}
function renderPedidos(){
  const busq=(document.getElementById('ped-search')?.value||'').toLowerCase();
  const isAdmin=session.rol==='admin'||session.rol==='super';
  const lista=pedidos
    .filter(p=>isAdmin||p.vendedor.toLowerCase()===session.nombre.toLowerCase())
    .filter(p=>filtroEstado==='todos'||p.estado===filtroEstado)
    .filter(p=>(p.cliente||'').toLowerCase().includes(busq)||(p.numero||'').includes(busq))
    .sort((a,b)=>b.timestamp-a.timestamp);
  const el=document.getElementById('pedidos-lista');
  if(!lista.length){el.innerHTML=`<div class="empty"><div class="empty-ico">üìã</div>Sin pedidos</div>`;return;}
  el.innerHTML=lista.map(p=>`<div class="ped-card" onclick="openPedModal('${p.id}')" style="margin-bottom:.55rem">
    <div class="row-between" style="margin-bottom:.35rem">
      <div><div class="fw7 mono" style="font-size:.82rem">#${p.numero}</div><div class="text-xs text-muted">${new Date(p.timestamp).toLocaleString('es-CO')}</div></div>
      <span class="badge ${badgeClass(p.estado)}">${p.estado}</span>
    </div>
    <div class="text-sm" style="margin-bottom:.35rem">üë§ ${p.cliente}${p.telefono?' ¬∑ üìû '+p.telefono:''}</div>
    <div class="row-between">
      <div class="text-xs text-muted">üë®‚Äçüíº ${p.vendedor} ¬∑ ${p.items.length} items ¬∑ ${p.formaPago||'efectivo'}</div>
      <div class="text-accent fw7 mono" style="font-size:.875rem">${fmt(p.total)}</div>
    </div>
  </div>`).join('');
}
function openPedModal(id){
  const p=pedidos.find(x=>String(x.id)===String(id));
  if(!p)return;
  const wa=encodeURIComponent(`üõí *PEDIDO #${p.numero}*\nüë§ ${p.cliente}\n\n${p.items.map(i=>`‚Ä¢ ${i.nombre} √ó${i.qty} = ${fmt(i.subtotal)}`).join('\n')}\n\nüí∞ *TOTAL: ${fmt(p.total)}*`);
  document.getElementById('modal-ped-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">üìã Pedido #${p.numero}</div>
  <div class="alert a-info">üë§ <strong>${p.cliente}</strong>${p.telefono?'<br>üìû '+p.telefono:''}${p.direccion?'<br>üìç '+p.direccion:''}${p.nota?'<br>üìù '+p.nota:''}</div>
  ${p.items.map(i=>`<div class="order-item"><div><div class="oi-name">${i.emoji||''} ${i.nombre}</div><div class="oi-detail">${fmt(i.precio)} √ó ${i.qty}</div></div><div class="text-accent fw7 mono" style="font-size:.825rem">${fmt(i.subtotal)}</div></div>`).join('')}
  ${p.descuento?`<div class="fact-total-row text-sm"><span class="text-muted">Descuento (${p.descuento}%)</span><span class="text-red mono">-${fmt(p.descuentoMonto)}</span></div>`:''}
  <div class="order-total"><div class="ot-lbl">Total ¬∑ ${p.formaPago||'efectivo'}</div><div class="ot-val">${fmt(p.total)}</div></div>
  ${p.gps?`<div class="text-xs text-muted mt-sm">üìç GPS: ${p.gps.lat.toFixed(5)}, ${p.gps.lng.toFixed(5)} ¬±${Math.round(p.gps.acc||0)}m</div>`:''}
  <div class="divider"></div>
  <div style="display:flex;gap:.45rem;flex-wrap:wrap;margin-bottom:.65rem">
    ${p.estado!=='completado'?`<button class="btn btn-success btn-sm" onclick="cambiarEstado('${p.id}','completado')">‚úì Completar</button>`:''}
    ${p.estado!=='cancelado'?`<button class="btn btn-danger btn-sm" onclick="cambiarEstado('${p.id}','cancelado')">‚úó Cancelar</button>`:''}
    ${p.estado!=='pendiente'?`<button class="btn btn-secondary btn-sm" onclick="cambiarEstado('${p.id}','pendiente')">‚ü≥ Pendiente</button>`:''}
    ${p.estado!=='facturado'?`<button class="btn btn-purple btn-sm" onclick="generarFactura('${p.id}');closePedModal()">üßæ Facturar</button>`:''}
  </div>
  <a href="https://wa.me/${fmtWA(p.telefono)}?text=${wa}" target="_blank" class="btn btn-wa btn-full" style="margin-bottom:.5rem">üì≤ WhatsApp</a>
  <button class="btn btn-secondary btn-full" onclick="closePedModal()">Cerrar</button>`;
  document.getElementById('modal-ped').classList.add('open');
}
function cambiarEstado(id,estado){const i=pedidos.findIndex(p=>String(p.id)===String(id));if(i>=0){pedidos[i].estado=estado;sp();}closePedModal();renderPedidos();if(currentTab==='inicio')renderInicio();}
function closePedModal(e){if(!e||e.target===document.getElementById('modal-ped'))document.getElementById('modal-ped').classList.remove('open');}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FACTURACI√ìN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generarFactura(pedidoId){
  const ped=pedidos.find(p=>String(p.id)===String(pedidoId));
  if(!ped)return;
  const num=(facturas.length+1).toString().padStart(5,'0');
  const codigo=`${config.prefijo_fact||'FAC'}-${num}`;
  const aplicaIva=config.regimen!=='simplificado';
  const ivaPct=aplicaIva?(config.iva||19):0;
  const base=ped.total;
  const mIva=aplicaIva?base*ivaPct/100:0;
  const totalF=base+mIva;
  const fact={id:genId(),codigo,pedidoId:ped.id,pedidoNum:ped.numero,cliente:ped.cliente,clienteId:ped.clienteId||null,
    telefono:ped.telefono,direccion:ped.direccion,items:ped.items,subtotal:ped.subtotal||ped.total,
    descuento:ped.descuento||0,descuentoMonto:ped.descuentoMonto||0,baseGravable:base,iva:ivaPct,montoIva:mIva,
    total:totalF,formaPago:ped.formaPago||'efectivo',vendedor:ped.vendedor,timestamp:Date.now(),estado:'emitida'};
  facturas.push(fact);
  const pi=pedidos.findIndex(p=>String(p.id)===String(pedidoId));
  if(pi>=0)pedidos[pi].estado='facturado';
  sp();mostrarFactura(fact);
}
function mostrarFactura(f){
  const isIva=f.iva>0;
  document.getElementById('modal-fact-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">üßæ Factura ${f.codigo}</div>
  <div class="card" style="margin-bottom:.7rem;border-color:rgba(0,212,255,.2)">
    <div class="row-between" style="margin-bottom:.5rem">
      <div><div class="fw7">${config.negocio}</div>${config.nit?`<div class="text-xs text-muted">NIT: ${config.nit}</div>`:''}${config.dir_empresa?`<div class="text-xs text-muted">${config.dir_empresa}</div>`:''}</div>
      <div style="text-align:right"><div class="mono c-accent" style="font-size:.7rem;font-weight:700">${f.codigo}</div><div class="text-xs text-muted">${new Date(f.timestamp).toLocaleDateString('es-CO')}</div></div>
    </div>
    <div class="divider"></div>
    <div class="text-xs text-muted">CLIENTE</div>
    <div class="fw7">${f.cliente}</div>
    ${f.telefono?`<div class="text-xs text-muted">üìû ${f.telefono}</div>`:''}
  </div>
  <div class="card2" style="margin-bottom:.7rem">
    ${f.items.map(i=>`<div class="fact-line"><span style="flex:2">${i.emoji||''} ${i.nombre}</span><span class="mono">√ó${i.qty}</span><span class="mono">${fmt(i.precio)}</span><span class="mono c-accent">${fmt(i.subtotal)}</span></div>`).join('')}
    <div class="divider"></div>
    ${f.descuento?`<div class="fact-total-row text-sm"><span class="text-muted">Descuento (${f.descuento}%)</span><span class="text-red mono">-${fmt(f.descuentoMonto)}</span></div>`:''}
    ${isIva?`<div class="fact-total-row text-sm"><span class="text-muted">Base gravable</span><span class="mono">${fmt(f.baseGravable)}</span></div><div class="fact-total-row text-sm"><span class="text-muted">IVA (${f.iva}%)</span><span class="mono">${fmt(f.montoIva)}</span></div>`:''}
    <div class="fact-total-row" style="border-top:1px solid var(--border);padding-top:.45rem"><span>TOTAL</span><span class="c-accent mono" style="font-size:1.1rem">${fmt(f.total)}</span></div>
    <div class="text-xs text-muted" style="margin-top:.2rem">Pago: ${f.formaPago} ¬∑ Vendedor: ${f.vendedor}</div>
    ${config.pie_factura?`<div class="text-xs text-muted" style="margin-top:.35rem;font-style:italic">${config.pie_factura}</div>`:''}
  </div>
  <div class="btn-row" style="margin-bottom:.55rem">
    <button class="btn btn-secondary" style="flex:1" onclick="printFactura('${f.id}')">üñ®Ô∏è Imprimir</button>
    <button class="btn btn-wa" style="flex:1" onclick="waFactura('${f.id}')">üì≤ WhatsApp</button>
  </div>
  <button class="btn btn-secondary btn-full" onclick="closeFactModal()">Cerrar</button>`;
  document.getElementById('modal-fact').classList.add('open');
}
function printFactura(fid){
  const f=facturas.find(x=>String(x.id)===String(fid));if(!f)return;
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>Factura ${f.codigo}</title><style>body{font-family:Arial,sans-serif;padding:20px;max-width:380px;margin:0 auto;font-size:11px}h2{font-size:14px;margin:0 0 2px}.line{border-top:1px dashed #999;margin:8px 0}.right{text-align:right}table{width:100%;border-collapse:collapse}td{padding:2px 0}.total{font-size:14px;font-weight:700}@media print{.no-print{display:none}}</style></head><body>
  <h2>${config.negocio}</h2>${config.nit?`<div>NIT: ${config.nit}</div>`:''}<div class="line"></div>
  <strong>${f.codigo}</strong> | ${new Date(f.timestamp).toLocaleDateString('es-CO')}<br>
  Cliente: ${f.cliente}${f.telefono?' | Tel: '+f.telefono:''}<div class="line"></div>
  <table>${f.items.map(i=>`<tr><td>${i.nombre}</td><td style="text-align:center">${i.qty}</td><td class="right">${fmt(i.precio)}</td><td class="right">${fmt(i.subtotal)}</td></tr>`).join('')}</table>
  <div class="line"></div>${f.descuento?`Desc. ${f.descuento}%: -${fmt(f.descuentoMonto)}<br>`:''}${f.iva?`IVA ${f.iva}%: ${fmt(f.montoIva)}<br>`:''}
  <div class="total">TOTAL: ${fmt(f.total)}</div><div>Pago: ${f.formaPago}</div>
  ${config.pie_factura?`<div style="margin-top:8px;font-style:italic;font-size:9px">${config.pie_factura}</div>`:''}
  <script>window.onload=()=>{window.print();setTimeout(()=>window.close(),1000);}<\/script></body></html>`);
}
function waFactura(fid){
  const f=facturas.find(x=>String(x.id)===String(fid));if(!f)return;
  const txt=encodeURIComponent(`üßæ *FACTURA ${f.codigo}*\nüè™ ${config.negocio}${config.nit?' ¬∑ NIT: '+config.nit:''}\nüìÖ ${new Date(f.timestamp).toLocaleDateString('es-CO')}\n\nüë§ ${f.cliente}\n\n*DETALLE:*\n${f.items.map(i=>`‚Ä¢ ${i.nombre} √ó${i.qty} = ${fmt(i.subtotal)}`).join('\n')}\n\n${f.descuento?`üè∑Ô∏è Desc. (${f.descuento}%): -${fmt(f.descuentoMonto)}\n`:''}${f.iva?`üìä IVA (${f.iva}%): ${fmt(f.montoIva)}\n`:''}\nüí∞ *TOTAL: ${fmt(f.total)}*`);
  window.open(`https://wa.me/${fmtWA(f.telefono)}?text=${txt}`,'_blank');
}
function closeFactModal(e){if(!e||e.target===document.getElementById('modal-fact'))document.getElementById('modal-fact').classList.remove('open');}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CLIENTES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderClientes(){
  const busq=(document.getElementById('cli-search')?.value||'').toLowerCase();
  const isAdmin=session.rol==='admin'||session.rol==='super';
  const lista=clientes.filter(c=>c.activo&&
    (isAdmin||!c.vendedor||c.vendedor.toLowerCase()===session.nombre.toLowerCase())&&
    (c.nombre.toLowerCase().includes(busq)||(c.telefono||'').includes(busq)));
  const el=document.getElementById('clientes-lista');
  if(!lista.length){el.innerHTML=`<div class="empty"><div class="empty-ico">üë•</div>Sin clientes. Agrega o importa desde Excel.</div>`;return;}
  el.innerHTML=lista.map(cl=>{
    const pCli=pedidos.filter(p=>p.clienteId===cl.id);
    const total=pCli.filter(p=>['completado','facturado'].includes(p.estado)).reduce((s,p)=>s+p.total,0);
    return `<div class="cliente-card" onclick="abrirModalCliente(${cl.id})">
      <div class="row"><div class="c-avatar">${cl.nombre.charAt(0)}</div>
      <div style="flex:1"><div class="fw7">${cl.nombre}${(session.rol==='admin'||session.rol==='super')&&cl.vendedor?`<span class="vendedor-tag">${cl.vendedor}</span>`:''}</div>
      <div class="text-xs text-muted">${cl.telefono||''}${cl.ciudad?' ¬∑ '+cl.ciudad:''}</div>
      <div class="text-xs" style="margin-top:.2rem"><span class="text-accent">${fmt(total)}</span> <span class="text-muted">¬∑ ${pCli.length} pedidos</span>${cl.lat?'<span style="margin-left:.3rem;color:var(--accent)">üìç</span>':''}</div></div></div>
    </div>`;
  }).join('');
}
function abrirModalCliente(id, modoEdicion=false){
  const cl=id?clientes.find(c=>c.id===id):null;
  const f=cl||{nombre:'',telefono:'',email:'',direccion:'',ciudad:'Bogot√°',nit:'',notas:''};
  const peds=cl?pedidos.filter(p=>p.clienteId===cl.id).slice(-5).reverse():[];
  const totalCli=cl?pedidos.filter(p=>p.clienteId===cl.id&&['completado','facturado'].includes(p.estado)).reduce((s,p)=>s+p.total,0):0;
  const isAdmin=session.rol==='admin'||session.rol==='super';

  if(cl && !modoEdicion){
    // ‚îÄ‚îÄ MODO FICHA (vista r√°pida del vendedor) ‚îÄ‚îÄ
    const gpsTag=cl.lat?`<span class="badge" style="background:rgba(0,212,255,.12);color:var(--accent)">üìç GPS guardado</span>`:`<span class="badge" style="background:rgba(90,106,128,.15);color:var(--muted)">üìç Sin GPS</span>`;
    const mapsUrl=cl.lat?`https://www.google.com/maps?q=${cl.lat},${cl.lng}`:cl.direccion?`https://maps.google.com/?q=${encodeURIComponent(cl.direccion+' '+cl.ciudad)}`:'';
    document.getElementById('modal-cliente-content').innerHTML=`<div class="modal-handle"></div>
    <div class="row-between" style="margin-bottom:.75rem">
      <div class="row"><div class="c-avatar" style="width:44px;height:44px;font-size:1.1rem">${cl.nombre.charAt(0)}</div>
        <div><div class="fw7" style="font-size:1rem">${cl.nombre}</div>
        <div class="text-xs text-muted">${cl.ciudad||''}${cl.nit?' ¬∑ NIT: '+cl.nit:''}</div>
        ${gpsTag}
      </div></div>
      ${isAdmin?`<button class="btn btn-secondary btn-sm" onclick="abrirModalCliente(${id},true)">‚úèÔ∏è Editar</button>`:''}
    </div>

    <div class="stats-grid" style="margin-bottom:.75rem">
      <div class="stat"><div class="stat-val c-accent" style="font-size:1rem">${fmt(totalCli)}</div><div class="stat-lbl">Total compras</div></div>
      <div class="stat"><div class="stat-val c-green" style="font-size:1rem">${peds.length}</div><div class="stat-lbl">Pedidos</div></div>
    </div>

    <div class="card2" style="margin-bottom:.6rem">
      ${cl.telefono?`<div class="row-between" style="margin-bottom:.35rem"><div class="row"><span>üìû</span><span class="text-sm">${cl.telefono}</span></div><a href="tel:${cl.telefono}" class="btn btn-secondary btn-xs">Llamar</a></div>`:''}
      ${cl.direccion?`<div class="row" style="margin-bottom:.35rem"><span>üìç</span><span class="text-sm" style="flex:1">${cl.direccion}</span></div>`:''}
      ${cl.email?`<div class="row"><span>‚úâÔ∏è</span><span class="text-sm">${cl.email}</span></div>`:''}
    </div>

    <div class="btn-row" style="margin-bottom:.6rem">
      <button class="btn btn-primary" style="flex:2" onclick="pedidoDesdeCliente(${cl.id})">üõí Tomar pedido</button>
      <button class="btn btn-teal" style="flex:1" onclick="capturarGPSCliente(${cl.id})">üìç GPS</button>
      <button class="btn btn-secondary" style="flex:1" onclick="abrirMapaClienteIndividual(${cl.id})"${!mapsUrl&&!cl.lat?' disabled style="flex:1;opacity:.4"':' style="flex:1"'}>üó∫Ô∏è Mapa</button>
    </div>
    ${cl.telefono?`<a href="https://wa.me/${fmtWA(cl.telefono)}" target="_blank" class="btn btn-wa btn-full" style="margin-bottom:.6rem">üì≤ WhatsApp</a>`:''}

    ${peds.length?`<div class="card-title" style="margin-bottom:.35rem">üìã √öltimos pedidos</div>
    ${peds.map(p=>`<div class="order-item" style="cursor:pointer" onclick="closeClienteModal();openPedModal('${p.id}')"><div><div class="oi-name mono">#${p.numero}</div><div class="oi-detail">${new Date(p.timestamp).toLocaleDateString('es-CO')}</div></div><div style="text-align:right"><span class="text-accent fw7 mono" style="font-size:.8rem">${fmt(p.total)}</span><br><span class="badge ${badgeClass(p.estado)}">${p.estado}</span></div></div>`).join('')}`:'<div class="empty" style="padding:1.2rem"><div class="empty-ico" style="font-size:1.8rem">üõí</div>Sin pedidos a√∫n</div>'}
    <button class="btn btn-secondary btn-full" style="margin-top:.75rem" onclick="closeClienteModal()">Cerrar</button>`;
  } else {
    // ‚îÄ‚îÄ MODO EDICI√ìN ‚îÄ‚îÄ
    document.getElementById('modal-cliente-content').innerHTML=`<div class="modal-handle"></div>
    <div class="modal-title">${cl?'‚úèÔ∏è Editar cliente':'‚ûï Nuevo cliente'}</div>
    <div class="form-stack">
      <div class="form-grid">
        <div class="field"><label class="label">Nombre *</label><input class="input" id="nc-nombre" value="${f.nombre}"/></div>
        <div class="field"><label class="label">Tel√©fono</label><input class="input" id="nc-tel" value="${f.telefono}" type="tel"/></div>
      </div>
      <div class="form-grid">
        <div class="field"><label class="label">Email</label><input class="input" id="nc-email" value="${f.email||''}" type="email"/></div>
        <div class="field"><label class="label">NIT / C√©dula</label><input class="input" id="nc-nit" value="${f.nit||''}"/></div>
      </div>
      <div class="field"><label class="label">Direcci√≥n</label><input class="input" id="nc-dir" value="${f.direccion||''}"/></div>
      <div class="field"><label class="label">Ciudad</label><input class="input" id="nc-ciu" value="${f.ciudad||''}"/></div>
      <div class="field"><label class="label">Notas</label><textarea class="input" id="nc-notas">${f.notas||''}</textarea></div>
      ${cl&&cl.lat?`<div class="alert a-info" style="font-size:.75rem">üìç GPS guardado: ${cl.lat.toFixed(5)}, ${cl.lng.toFixed(5)}</div>`:''}
    </div>
    <div class="btn-row" style="margin-top:.875rem">
      <button class="btn btn-secondary" style="flex:1" onclick="${cl?'abrirModalCliente('+id+')':'closeClienteModal()'}">Cancelar</button>
      ${cl?`<button class="btn btn-danger btn-sm" onclick="eliminarCliente(${cl.id})">üóëÔ∏è</button>`:''}
      <button class="btn btn-primary" style="flex:2" onclick="guardarCliente(${id||'null'})">Guardar</button>
    </div>`;
  }
  document.getElementById('modal-cliente').classList.add('open');
}

function pedidoDesdeCliente(clienteId){
  const cl=clientes.find(c=>c.id===clienteId);if(!cl)return;
  closeClienteModal();
  // Pre-cargar cliente en el flujo de pedido
  pedidoCliente={id:cl.id,nombre:cl.nombre,telefono:cl.telefono||'',direccion:cl.direccion||'',nota:'',ciudad:cl.ciudad||''};
  carrito={};
  pedidoStepNum=2; // ir directo a productos
  goTab('nuevo');
}

async function capturarGPSCliente(clienteId){
  const i=clientes.findIndex(c=>c.id===clienteId);if(i<0)return;
  const btn=document.querySelector('[onclick*="capturarGPSCliente"]');
  if(btn){btn.textContent='‚è≥ Capturando...';btn.disabled=true;}
  try{
    const pos=await getGPS();
    clientes[i].lat=pos.lat;
    clientes[i].lng=pos.lng;
    clientes[i].gpsAcc=pos.acc;
    clientes[i].gpsFecha=Date.now();
    sp();
    // Refrescar modal
    abrirModalCliente(clienteId);
    setTimeout(()=>{
      const el=document.querySelector('#modal-cliente-content .alert');
      if(el){el.innerHTML='‚úÖ Ubicaci√≥n guardada: '+pos.lat.toFixed(5)+', '+pos.lng.toFixed(5);el.className='alert a-success';}
    },100);
  }catch(e){
    if(btn){btn.textContent='üìç GPS';btn.disabled=false;}
    alert('No se pudo obtener GPS. Verifica que los permisos est√©n activados.');
  }
}
function guardarCliente(id){
  const nombre=document.getElementById('nc-nombre').value.trim();
  if(!nombre)return alert('Nombre requerido');
  const data={nombre,telefono:document.getElementById('nc-tel').value,email:document.getElementById('nc-email').value,
    direccion:document.getElementById('nc-dir').value,ciudad:document.getElementById('nc-ciu').value,
    nit:document.getElementById('nc-nit').value,notas:document.getElementById('nc-notas').value,activo:true};
  if(id){const i=clientes.findIndex(c=>c.id===id);if(i>=0)clientes[i]={...clientes[i],...data};}
  else clientes.push({id:genId(),...data});
  sp();closeClienteModal();renderClientes();
}
function eliminarCliente(id){if(!confirm('¬øEliminar cliente?'))return;const i=clientes.findIndex(c=>c.id===id);if(i>=0)clientes[i].activo=false;sp();closeClienteModal();renderClientes();}
function closeClienteModal(e){if(!e||e.target===document.getElementById('modal-cliente'))document.getElementById('modal-cliente').classList.remove('open');}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// IMPORTAR EXCEL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let importTab='productos';
function renderImportar(){
  const el=document.getElementById('importar-content');
  el.innerHTML=`
  <div class="card-title">üìä Importaci√≥n masiva desde Excel</div>
  <div class="tabs" style="margin-bottom:.75rem">
    <button class="tab ${importTab==='productos'?'active':''}" onclick="importTab='productos';renderImportar()">üì¶ Productos</button>
    <button class="tab ${importTab==='clientes'?'active':''}" onclick="importTab='clientes';renderImportar()">üë• Clientes</button>
    <button class="tab ${importTab==='pedidos'?'active':''}" onclick="importTab='pedidos';renderImportar()">üìã Pedidos</button>
    <button class="tab ${importTab==='rutas'?'active':''}" onclick="importTab='rutas';renderImportar()">üó∫Ô∏è Rutas</button>
  </div>
  <div class="alert a-info" style="margin-bottom:.75rem">üì• Descarga la plantilla, compl√©tala y s√∫bela aqu√≠. Hasta <strong>5.000 registros</strong> por archivo.${importTab==='pedidos'?' Los pedidos hist√≥ricos se importar√°n como completados.':importTab==='rutas'?' Cada fila es una parada. Columna DIA agrupa las rutas por d√≠a/vendedor.':''}</div>
  <button class="btn btn-teal btn-full" style="margin-bottom:.75rem" onclick="descargarPlantilla()">‚¨áÔ∏è Descargar plantilla Excel</button>
  <div class="import-zone" id="import-zone" onclick="document.getElementById('file-input').click()" 
    ondragover="event.preventDefault();this.classList.add('drag')" 
    ondragleave="this.classList.remove('drag')"
    ondrop="event.preventDefault();this.classList.remove('drag');handleFile(event.dataTransfer.files[0])">
    <div class="import-zone-ico">üìÇ</div>
    <div class="import-zone-txt">Toca aqu√≠ para seleccionar archivo</div>
    <div class="import-zone-sub">.xlsx, .xls o .csv ¬∑ Arrastra y suelta</div>
  </div>
  <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFile(this.files[0])"/>
  <div id="import-result"></div>`;
}

function descargarPlantilla(){
  let headers,example;
  if(importTab==='productos'){
    headers=['nombre','precio','categoria','stock','emoji','descripcion','codigo_barras'];
    example=['Producto Ejemplo',25000,'General',50,'üì¶','Descripci√≥n','COD001'];
  } else if(importTab==='clientes'){
    headers=['nombre','telefono','email','direccion','ciudad','nit_cedula','regimen','notas'];
    example=['Juan Garc√≠a','3001234567','juan@email.com','Calle 10 # 5-20','Bogot√°','80123456','simplificado',''];
  } else if(importTab==='rutas'){
    headers=['dia','vendedor','orden','cliente','telefono','direccion','ciudad','nota'];
    const rows=[
      ['Lunes','Vendedor 1',1,'Juan Garc√≠a','3001234567','Calle 10 # 5-20','Bogot√°','Pedir factura pendiente'],
      ['Lunes','Vendedor 1',2,'Dist. L√≥pez','3109876543','Carrera 15 # 80-10','Bogot√°',''],
      ['Martes','Vendedor 1',1,'Supermercado XYZ','3201112233','Av. 68 # 22-15','Bogot√°','Entrega pedido grande'],
      ['Lunes','Vendedor 2',1,'Tienda Norte','3001112222','Calle 100 # 15-30','Bogot√°',''],
    ];
    const csv=[headers.join(','),...rows.map(r=>r.join(','))].join('\n');
    const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='plantilla_rutas.csv';a.click();
    return;
  } else {
    headers=['fecha','cliente','telefono','direccion','ciudad','vendedor','producto1','precio1','cantidad1','producto2','precio2','cantidad2','total','forma_pago','estado','nota'];
    example=['2024-01-15','Juan Garc√≠a','3001234567','Calle 10 # 5-20','Bogot√°','Admin','Producto A',25000,2,'Producto B',45000,1,95000,'efectivo','completado','Pedido hist√≥rico'];
  }
  const csv=[headers.join(','),example.join(',')].join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`plantilla_${importTab}.csv`;
  a.click();
}

function handleFile(file){
  if(!file)return;
  const ext=file.name.split('.').pop().toLowerCase();
  const res=document.getElementById('import-result');
  res.innerHTML=`<div class="import-progress"><div class="fw7 text-sm">üìñ Leyendo archivo...</div><div class="prog-bar-wrap"><div class="prog-bar" id="prog" style="width:30%"></div></div></div>`;

  const reader=new FileReader();
  reader.onload=e=>{
    try{
      let rows=[];
      if(ext==='csv'){
        const text=e.target.result;
        const lines=text.split('\n').filter(l=>l.trim());
        const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/[^a-z_]/g,''));
        rows=lines.slice(1).map(l=>{
          const vals=l.split(',');
          const obj={};
          headers.forEach((h,i)=>obj[h]=(vals[i]||'').trim());
          return obj;
        });
      } else {
        const wb=XLSX.read(e.target.result,{type:'binary'});
        // Find the right sheet
        const sheetName=importTab==='productos'?wb.SheetNames.find(n=>n.toLowerCase().includes('prod'))||wb.SheetNames[0]:importTab==='pedidos'?wb.SheetNames.find(n=>n.toLowerCase().includes('ped'))||wb.SheetNames[0]:wb.SheetNames.find(n=>n.toLowerCase().includes('cli'))||wb.SheetNames[Math.min(1,wb.SheetNames.length-1)];
        const ws=wb.Sheets[sheetName];
        const raw=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
        // Find header row (skip title/instruction rows)
        let hIdx=0;
        for(let i=0;i<Math.min(5,raw.length);i++){
          const row=raw[i];
          const hasNombre=row.some(c=>String(c).toLowerCase().includes('nombre'));
          if(hasNombre){hIdx=i;break;}
        }
        const headers=raw[hIdx].map(h=>String(h).toLowerCase().trim().replace(/\s+/g,'_').replace(/[^a-z_]/g,'').replace(/\*/g,''));
        rows=raw.slice(hIdx+1).filter(r=>r.some(c=>c!=='')).map(r=>{
          const obj={};
          headers.forEach((h,i)=>obj[h]=(r[i]!==undefined?String(r[i]).trim():''));
          return obj;
        });
      }
      document.getElementById('prog').style.width='70%';
      importData(rows,res);
    } catch(err){
      res.innerHTML=`<div class="alert a-err">‚ùå Error al leer el archivo: ${err.message}</div>`;
    }
  };
  if(ext==='csv')reader.readAsText(file,'UTF-8');
  else reader.readAsBinaryString(file);
}

function importData(rows,res){
  let ok=0,skip=0,errors=[];
  if(importTab==='productos'){
    rows.forEach((r,i)=>{
      const nombre=(r.nombre||'').trim();
      const precio=Number(String(r.precio||'').replace(/[^0-9.]/g,''));
      if(!nombre||!precio){skip++;return;}
      const existing=productos.findIndex(p=>p.nombre.toLowerCase()===nombre.toLowerCase());
      const prod={nombre,precio,categoria:r.categoria||'General',stock:Number(r.stock)||0,stockMin:5,
        emoji:r.emoji||'üì¶',descripcion:r.descripcion||'',codigoBarras:r.codigo_barras||''};
      if(existing>=0){productos[existing]={...productos[existing],...prod};ok++;}
      else{productos.push({id:genId(),...prod});ok++;}
    });
  } else if(importTab==='clientes'){
    rows.forEach((r,i)=>{
      const nombre=(r.nombre||'').trim();
      if(!nombre){skip++;return;}
      const existing=clientes.findIndex(c=>c.nombre.toLowerCase()===nombre.toLowerCase());
      const cli={nombre,telefono:r.telefono||'',email:r.email||'',direccion:r.direccion||'',
        ciudad:r.ciudad||'',nit:r.nit_cedula||r.nit||'',notas:r.notas||'',activo:true};
      if(existing>=0){clientes[existing]={...clientes[existing],...cli};ok++;}
      else{clientes.push({id:genId(),...cli});ok++;}
    });
  } else if(importTab==='pedidos'){
    rows.forEach((r,i)=>{
      const cliente=(r.cliente||r.nombre||'').trim();
      if(!cliente){skip++;return;}
      // Parse items from columns producto1,precio1,cantidad1, producto2,precio2,cantidad2...
      const items=[];
      for(let n=1;n<=10;n++){
        const pn=r['producto'+n]||r['producto_'+n]||'';
        if(!pn)break;
        const pr=Number(String(r['precio'+n]||r['precio_'+n]||0).replace(/[^0-9.]/g,''));
        const qty=Number(r['cantidad'+n]||r['cantidad_'+n]||1);
        if(pn&&qty>0)items.push({id:genId(),nombre:pn,precio:pr||0,qty,subtotal:(pr||0)*qty,emoji:'üì¶'});
      }
      if(!items.length){
        // Try single product style
        const pn=r.producto||r.articulo||'';
        const pr=Number(String(r.precio||r.precio_unitario||0).replace(/[^0-9.]/g,''));
        const qty=Number(r.cantidad||r.qty||1);
        if(pn)items.push({id:genId(),nombre:pn,precio:pr,qty,subtotal:pr*qty,emoji:'üì¶'});
      }
      const total=Number(String(r.total||'').replace(/[^0-9.]/g,''))||items.reduce((s,i)=>s+i.subtotal,0);
      const fechaStr=r.fecha||r.date||'';
      let ts=Date.now();
      if(fechaStr){const d=new Date(fechaStr);if(!isNaN(d))ts=d.getTime();}
      const numero=(pedidos.length+ok+1).toString().padStart(5,'0');
      const ped={id:genId(),numero,cliente,clienteId:null,
        telefono:r.telefono||'',direccion:r.direccion||'',nota:r.nota||r.notas||'',ciudad:r.ciudad||'',
        items,subtotal:total,descuento:0,descuentoMonto:0,total,
        formaPago:r.forma_pago||r.pago||'efectivo',
        vendedor:r.vendedor||session.nombre,sucursalId:session.sucursalId||null,
        timestamp:ts,estado:r.estado||'completado',gps:null,importado:true};
      pedidos.push(ped);ok++;
    });
  } else if(importTab==='rutas'){
    // Detectar formato del Excel autom√°ticamente
    // Soporta formato est√°ndar (columnas: dia, vendedor, cliente, direccion)
    // Y formato Programaci√≥n (columnas: nombre_asesor, nombre_cliente, direcci√≥n, tipo, atributo1, atributo2)
    // donde atributo2 = dia de semana (LUN,MAR,MIE,JUE,VIE,SAB,DOM) y nombre_asesor = vendedor

    const DIAS_MAP={
      'LUN':'LUN','LUNES':'LUN','MON':'LUN','MONDAY':'LUN',
      'MAR':'MAR','MARTES':'MAR','TUE':'MAR','TUESDAY':'MAR',
      'MIE':'MIE','MIERCOLES':'MIE','MIE':'MIE','WED':'MIE','WEDNESDAY':'MIE',
      'JUE':'JUE','JUEVES':'JUE','THU':'JUE','THURSDAY':'JUE',
      'VIE':'VIE','VIERNES':'VIE','FRI':'VIE','FRIDAY':'VIE',
      'SAB':'SAB','SABADO':'SAB','SAT':'SAB','SATURDAY':'SAB',
      'DOM':'DOM','DOMINGO':'DOM','SUN':'DOM','SUNDAY':'DOM',
    };
    const DIA_DOW={DOM:0,LUN:1,MAR:2,MIE:3,JUE:4,VIE:5,SAB:6};

    const grupos={};
    const primeraFila=rows[0]||{};
    const esFmtProg=Object.keys(primeraFila).some(k=>
      k==='nombre_asesor'||k==='nombre_cliente'||k==='atributo2'||k==='atributo1'
    );

    rows.forEach(r=>{
      let dia, vendedor, clienteNombre, direccion, nota;
      if(esFmtProg){
        const rawAsesor=(r.nombre_asesor||r.asesor||'').trim();
        const asesorLower=rawAsesor.toLowerCase();
        const usuarioMatch=usuarios.find(u=>
          u.rol==='vendedor'&&(
            asesorLower.includes(u.nombre.toLowerCase())||
            u.nombre.toLowerCase().includes(asesorLower.split(' ')[0].toLowerCase())
          )
        );
        vendedor=usuarioMatch?usuarioMatch.nombre:rawAsesor;
        clienteNombre=(r.nombre_cliente||r.cliente||r.nombre||'').trim();
        // Buscar columna de direcci√≥n con o sin tilde
        direccion='';
        for(const k of Object.keys(r)){
          if(k.includes('direcci')||k==='dir'){direccion=String(r[k]||'').trim();break;}
        }
        const rawDia=String(r.atributo2||r.dia||'').trim().toUpperCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        dia=DIAS_MAP[rawDia]||rawDia||'LUN';
        nota=r.tipo||'';
      } else {
        let rawDia=String(r.dia||r.day||'LUN').trim().toUpperCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        dia=DIAS_MAP[rawDia]||rawDia;
        vendedor=(r.vendedor||r.vendor||session.nombre).trim();
        clienteNombre=(r.cliente||r.nombre||'').trim();
        direccion=(r.direccion||r.dir||'').trim();
        nota=r.nota||r.notas||'';
      }

      if(!clienteNombre){skip++;return;}
      const key=dia+'|||'+vendedor;
      if(!grupos[key])grupos[key]={dia,vendedor,paradas:[]};
      const clMatch=clientes.find(c=>c.nombre.toLowerCase()===clienteNombre.toLowerCase());
      grupos[key].paradas.push({
        clienteId:clMatch?clMatch.id:null,
        clienteNombre,
        telefono:r.telefono||clMatch?.telefono||'',
        direccion:direccion||clMatch?.direccion||'',
        ciudad:r.ciudad||clMatch?.ciudad||'',
        nota,
        orden:grupos[key].paradas.length+1,
        visitado:false,omitido:false,gps:null
      });
      ok++;
    });

    Object.values(grupos).forEach(g=>{
      const hoy=new Date();
      const dow=hoy.getDay();
      const target=DIA_DOW[g.dia]!==undefined?DIA_DOW[g.dia]:1;
      let diff=target-dow; if(diff<0)diff+=7;
      const fecha=new Date(hoy); fecha.setDate(hoy.getDate()+diff); fecha.setHours(8,0,0,0);
      const ts=fecha.getTime();
      const nombreRuta=g.dia+' ‚Äì '+g.vendedor;
      const existIdx=rutas.findIndex(rt=>rt.importada&&rt.vendedor===g.vendedor&&rt.dia===g.dia&&rt.estado==='pendiente');
      if(existIdx>=0){
        rutas[existIdx].paradas=g.paradas;
        rutas[existIdx].timestamp=ts;
        rutas[existIdx].nombre=nombreRuta;
      } else {
        rutas.push({id:genId(),nombre:nombreRuta,vendedor:g.vendedor,dia:g.dia,paradas:g.paradas,estado:'pendiente',timestamp:ts,finTs:null,importada:true});
      }
    });
  }
  sp();
  document.getElementById('prog').style.width='100%';
  setTimeout(()=>{
    res.innerHTML=`<div class="alert a-success">‚úÖ Importaci√≥n completada<br>
    <strong>${ok}</strong> registros importados/actualizados<br>
    ${skip?`<span style="color:var(--orange)">${skip} filas omitidas (sin nombre o precio)</span>`:''}
    </div>
    <div class="btn-row" style="margin-top:.6rem">
      <button class="btn btn-secondary" style="flex:1" onclick="renderImportar()">Importar m√°s</button>
      <button class="btn btn-primary" style="flex:1" onclick="goTab(importTab==='pedidos'?'pedidos':importTab==='rutas'?'rutas':importTab)">Ver ${importTab==='productos'?'productos':importTab==='pedidos'?'pedidos':importTab==='rutas'?'rutas':'clientes'} ‚Üí</button>
    </div>`;
  },500);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// RUTAS GPS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRutas(){
  const el=document.getElementById('rutas-content');
  const isAdmin=session.rol==='admin'||session.rol==='super';
  const hoyDIA=['DOM','LUN','MAR','MIE','JUE','VIE','SAB'][new Date().getDay()];
  const DIAS_NOMBRE={LUN:'Lunes',MAR:'Martes',MIE:'Mi√©rcoles',JUE:'Jueves',VIE:'Viernes',SAB:'S√°bado',DOM:'Domingo'};
  let html='';

  if(isAdmin){
    const todasEnCurso=rutas.filter(r=>r.estado==='en_curso');
    const todasPend=rutas.filter(r=>r.estado==='pendiente');
    // Estad√≠sticas
    html+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.75rem">
      <div class="card" style="text-align:center;padding:.65rem"><div style="font-size:1.4rem;font-weight:800;color:var(--accent)">${todasEnCurso.length}</div><div class="text-xs text-muted">Rutas activas</div></div>
      <div class="card" style="text-align:center;padding:.65rem"><div style="font-size:1.4rem;font-weight:800;color:var(--teal)">${todasPend.filter(r=>r.dia===hoyDIA).length}</div><div class="text-xs text-muted">Para hoy (${DIAS_NOMBRE[hoyDIA]||hoyDIA})</div></div>
    </div>`;
    html+=`<div class="btn-row" style="margin-bottom:.75rem">
      <button class="btn btn-primary" style="flex:2" onclick="abrirImportRutero()">üìä Cargar rutero Excel</button>
      <button class="btn btn-secondary" style="flex:1" onclick="abrirModalRuta()">+ Manual</button>
    </div>`;
    // Rutas en curso
    if(todasEnCurso.length){
      html+=`<div class="card-title" style="margin:.1rem 0 .4rem">üî¥ En curso ahora</div>`;
      todasEnCurso.forEach(r=>{
        const v=r.paradas.filter(p=>p.visitado).length;
        const pct=Math.round(v/r.paradas.length*100);
        html+=`<div class="route-card" style="margin-bottom:.5rem;border-left:3px solid var(--accent)">
          <div class="row-between" style="margin-bottom:.3rem"><div><div class="fw7 text-sm">üë§ ${r.vendedor}</div><div class="text-xs text-muted">${r.nombre} ¬∑ ${r.paradas.length} clientes</div></div><span class="badge b-fact">EN CURSO</span></div>
          <div class="route-progress"><div class="route-bar" style="width:${pct}%"></div></div>
          <div class="text-xs text-muted" style="margin-bottom:.35rem">${v}/${r.paradas.length} visitas ¬∑ ${pct}%</div>
          <div class="btn-row"><button class="btn btn-teal btn-sm" style="flex:1" onclick="abrirMapaRuta('${r.id}')">üó∫Ô∏è Mapa</button><button class="btn btn-secondary btn-sm" style="flex:1" onclick="verRuta('${r.id}')">üëÅÔ∏è Ver</button><button class="btn btn-success btn-sm" onclick="terminarRuta('${r.id}','completada')">‚úì</button></div>
        </div>`;
      });
    }
    // Hoy
    const hoyPend=todasPend.filter(r=>r.dia===hoyDIA);
    if(hoyPend.length){
      html+=`<div class="card-title" style="margin:.5rem 0 .4rem">üìÖ Hoy ¬∑ ${DIAS_NOMBRE[hoyDIA]||hoyDIA}</div>`;
      hoyPend.forEach(r=>{
        html+=`<div class="route-card" style="margin-bottom:.45rem;border-left:3px solid var(--teal)">
          <div class="row-between" style="margin-bottom:.3rem"><div><div class="fw7 text-sm">üë§ ${r.vendedor}</div><div class="text-xs text-muted">${r.paradas.length} clientes</div></div><span class="badge" style="background:rgba(0,191,165,.15);color:var(--teal)">HOY</span></div>
          <div class="text-xs text-muted" style="margin-bottom:.35rem">${r.paradas.slice(0,4).map(p=>p.clienteNombre.split(' ')[0]).join(' ¬∑ ')}${r.paradas.length>4?'...':''}</div>
          <div class="btn-row"><button class="btn btn-secondary btn-sm" style="flex:1" onclick="verRuta('${r.id}')">üëÅÔ∏è Ver ruta</button><button class="btn btn-danger btn-sm" onclick="confirmarEliminarRuta('${r.id}')">üóëÔ∏è</button></div>
        </div>`;
      });
    }
    // Semana completa
    const diasOrden=['LUN','MAR','MIE','JUE','VIE','SAB','DOM'];
    const otrosPend=todasPend.filter(r=>r.dia!==hoyDIA);
    if(otrosPend.length){
      html+=`<div class="card-title" style="margin:.5rem 0 .4rem">üìã Semana programada</div>`;
      diasOrden.forEach(dia=>{
        const rutasDia=otrosPend.filter(r=>r.dia===dia);
        if(!rutasDia.length)return;
        html+=`<div class="card" style="margin-bottom:.5rem;padding:.6rem .875rem"><div class="fw7 text-sm" style="margin-bottom:.4rem">üìÖ ${DIAS_NOMBRE[dia]||dia}</div>`;
        rutasDia.forEach(r=>{
          html+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:.35rem 0;border-bottom:1px solid var(--border)"><div><div class="text-sm fw7" style="font-size:.82rem">üë§ ${r.vendedor}</div><div class="text-xs text-muted">${r.paradas.length} clientes</div></div><div class="btn-row"><button class="btn btn-secondary btn-sm" onclick="verRuta('${r.id}')">üëÅÔ∏è</button><button class="btn btn-danger btn-sm" onclick="confirmarEliminarRuta('${r.id}')">üóëÔ∏è</button></div></div>`;
        });
        html+=`</div>`;
      });
    }
    // Historial admin
    const hist=rutas.filter(r=>['completada','cancelada'].includes(r.estado)).sort((a,b)=>(b.finTs||0)-(a.finTs||0));
    if(hist.length){
      html+=`<div class="card-title" style="margin:.5rem 0 .4rem">üìä Historial reciente</div>`;
      hist.slice(0,10).forEach(r=>{
        const v=r.paradas.filter(p=>p.visitado).length;
        html+=`<div class="route-card" onclick="verRuta('${r.id}')" style="margin-bottom:.4rem"><div class="row-between"><div><div class="fw7 text-sm">üë§ ${r.vendedor} ¬∑ ${r.nombre}</div><div class="text-xs text-muted">${r.finTs?new Date(r.finTs).toLocaleDateString('es-CO',{weekday:'short',day:'numeric',month:'short'}):''}</div></div><span class="badge ${r.estado==='completada'?'b-done':'b-cancel'}">${v}/${r.paradas.length}</span></div></div>`;
      });
    }
  } else {
    // ‚ïê‚ïê‚ïê VISTA VENDEDOR ‚ïê‚ïê‚ïê
    const misRutas=rutas.filter(r=>r.vendedor===session.nombre);
    const enCurso=misRutas.find(r=>r.estado==='en_curso');
    const pendientes=misRutas.filter(r=>r.estado==='pendiente');
    const hist=misRutas.filter(r=>['completada','cancelada'].includes(r.estado)).sort((a,b)=>(b.finTs||0)-(a.finTs||0));
    const rutaHoy=!enCurso&&pendientes.find(r=>r.dia===hoyDIA);

    if(enCurso){
      html+=renderRutaEnCurso(enCurso);
    } else if(rutaHoy){
      html+=`<div class="card" style="border:2px solid var(--teal);margin-bottom:.75rem">
        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
          <div style="width:2.5rem;height:2.5rem;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--accent));display:flex;align-items:center;justify-content:center;font-size:1.2rem">üìÖ</div>
          <div><div class="fw7">Tu ruta de hoy</div><div class="text-xs text-muted">${DIAS_NOMBRE[hoyDIA]} ¬∑ ${rutaHoy.paradas.length} clientes</div></div>
        </div>
        <div style="background:var(--bg);border-radius:.6rem;padding:.5rem;margin-bottom:.6rem;max-height:120px;overflow-y:auto">
          ${rutaHoy.paradas.slice(0,6).map((p,i)=>`<div style="display:flex;align-items:center;gap:.4rem;padding:.2rem 0;font-size:.78rem"><span style="background:var(--accent);color:#000;border-radius:50%;width:1.1rem;height:1.1rem;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.6rem;flex-shrink:0">${i+1}</span><span>${p.clienteNombre}</span></div>`).join('')}
          ${rutaHoy.paradas.length>6?`<div class="text-xs text-muted" style="padding:.2rem 0">+${rutaHoy.paradas.length-6} m√°s...</div>`:''}
        </div>
        <div class="btn-row">
          <button class="btn btn-success" style="flex:2;font-size:.9rem" onclick="iniciarRutaPendiente('${rutaHoy.id}');setTimeout(()=>{renderRutas();abrirMapaRuta('${rutaHoy.id}')},300)">‚ñ∂ Iniciar ruta de hoy</button>
          <button class="btn btn-teal btn-sm" onclick="verRuta('${rutaHoy.id}')">üëÅÔ∏è Ver</button>
        </div>
      </div>`;
    } else if(!enCurso){
      html+=`<div class="card" style="text-align:center;padding:1rem;margin-bottom:.75rem;border:1.5px dashed var(--border)"><div style="font-size:2rem;margin-bottom:.3rem">üìÖ</div><div class="fw7">Sin ruta para hoy (${DIAS_NOMBRE[hoyDIA]})</div><div class="text-xs text-muted" style="margin-top:.2rem">Puedes iniciar cualquier ruta de la semana desde abajo</div></div>`;
    }

    // ‚îÄ‚îÄ Semana completa con bot√≥n de selecci√≥n para CUALQUIER d√≠a ‚îÄ‚îÄ
    if(misRutas.length){
      html+=`<div class="card-title">üìã Mi semana ‚Äî Selecciona una ruta</div>`;
      ['LUN','MAR','MIE','JUE','VIE','SAB'].forEach(dia=>{
        // Buscar ruta de ese d√≠a (cualquier estado activo)
        const r=misRutas.find(p=>p.dia===dia&&p.estado!=='cancelada');
        if(!r)return;
        const esHoy=dia===hoyDIA;
        const enCursoDia=r.estado==='en_curso';
        const completada=r.estado==='completada';
        const v=r.paradas.filter(p=>p.visitado).length;
        const pct=r.paradas.length?Math.round(v/r.paradas.length*100):0;

        let estadoBadge='';
        if(enCursoDia)estadoBadge=`<span class="badge b-fact" style="font-size:.6rem">EN CURSO</span>`;
        else if(completada)estadoBadge=`<span class="badge b-done" style="font-size:.6rem">${pct}%</span>`;
        else if(esHoy)estadoBadge=`<span class="badge" style="background:rgba(0,191,165,.15);color:var(--teal);font-size:.6rem">HOY</span>`;

        let btnAccion='';
        if(!completada&&!enCursoDia){
          btnAccion=`<button class="btn btn-success btn-sm" style="flex:2;font-size:.8rem" onclick="iniciarRutaPendiente('${r.id}');setTimeout(()=>{renderRutas();abrirMapaRuta('${r.id}')},300)">‚ñ∂ Iniciar</button>`;
        } else if(enCursoDia){
          btnAccion=`<button class="btn btn-teal btn-sm" style="flex:2;font-size:.8rem" onclick="abrirMapaRuta('${r.id}')">üó∫Ô∏è Continuar</button>`;
        }

        html+=`<div class="route-card" style="margin-bottom:.45rem${esHoy&&!completada?';border-left:3px solid var(--teal)':''}${completada?';opacity:.7':''}">
          <div class="row-between" style="margin-bottom:.25rem">
            <div style="display:flex;align-items:center;gap:.4rem">
              <div class="fw7 text-sm">${DIAS_NOMBRE[dia]||dia}</div>
              ${estadoBadge}
            </div>
            <div class="text-xs text-muted">${r.paradas.length} clientes</div>
          </div>
          ${completada?`<div class="route-progress" style="margin-bottom:.3rem"><div class="route-bar" style="width:${pct}%"></div></div>`:
          `<div class="text-xs text-muted" style="margin-bottom:.3rem">${r.paradas.slice(0,3).map(p=>p.clienteNombre.split(' ')[0]).join(' ¬∑ ')}${r.paradas.length>3?` +${r.paradas.length-3} m√°s`:''}</div>`}
          <div class="btn-row">
            ${btnAccion}
            <button class="btn btn-secondary btn-sm" style="flex:1" onclick="verRuta('${r.id}')">üëÅÔ∏è Ver</button>
          </div>
        </div>`;
      });
    }

    if(hist.length){
      html+=`<div class="card-title" style="margin-top:.5rem">üìä Historial</div>`;
      hist.slice(0,5).forEach(r=>{
        const v=r.paradas.filter(p=>p.visitado).length;
        const pct=Math.round(v/r.paradas.length*100);
        html+=`<div class="route-card" onclick="verRuta('${r.id}')" style="margin-bottom:.4rem"><div class="row-between"><div><div class="fw7 text-sm">${r.nombre}</div><div class="text-xs text-muted">${r.finTs?new Date(r.finTs).toLocaleDateString('es-CO',{weekday:'short',day:'numeric',month:'short'}):''}</div></div><span class="badge ${r.estado==='completada'?'b-done':'b-cancel'}">${v}/${r.paradas.length} ¬∑ ${pct}%</span></div></div>`;
      });
    }
    if(!misRutas.length){
      html+=`<div class="empty"><div class="empty-ico">üó∫Ô∏è</div><div>Sin rutas asignadas</div><div class="text-xs text-muted" style="margin-top:.35rem">Pide a tu coordinador que cargue el rutero</div></div>`;
    }
  }
  el.innerHTML=html;
}

function confirmarEliminarRuta(rutaId){
  if(!confirm('¬øEliminar esta ruta?'))return;
  const i=rutas.findIndex(r=>String(r.id)===String(rutaId));
  if(i>=0)rutas.splice(i,1);
  sp();renderRutas();
}

function abrirImportRutero(){
  const el=document.getElementById('rutas-content');
  el.innerHTML=`
    <div class="card" style="margin-bottom:.75rem">
      <div class="fw7" style="margin-bottom:.3rem;font-size:1rem">üìä Cargar Rutero desde Excel</div>
      <div class="text-xs text-muted" style="margin-bottom:.75rem">Formato: NOMBRE ASESOR ¬∑ NOMBRE CLIENTE ¬∑ DIRECCI√ìN ¬∑ TIPO ¬∑ SEMANA ¬∑ D√çA</div>
      <div class="field" style="margin-bottom:.6rem">
        <label class="label">Archivo Excel (.xlsx)</label>
        <input type="file" accept=".xlsx,.xls" class="input" id="rutero-file" onchange="previsualizarRutero(this)"/>
      </div>
      <div id="rutero-preview"></div>
    </div>
    <button class="btn btn-secondary" style="width:100%" onclick="renderRutas()">‚Üê Volver</button>`;
}

function previsualizarRutero(input){
  const file=input.files[0];if(!file)return;
  const prev=document.getElementById('rutero-preview');
  prev.innerHTML='<div class="text-xs text-muted">‚è≥ Leyendo archivo...</div>';
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      const header=data[0].map(h=>String(h).toLowerCase());
      const rows=data.slice(1).filter(r=>r.some(v=>v));
      const grupos={};
      const NOMBRE_MAP={'DIANA CAROLINA RODRIGUEZ ROJAS':'Diana','WILSON JAVIER CHAPARRO CARRILLO':'Wilson','SANCHEZ MU√ëOZ CINDY LORENA':'Cindy'};
      const DIAS_MAP={'LUNES':'LUN','MARTES':'MAR','MIERCOLES':'MIE','MI√âRCOLES':'MIE','JUEVES':'JUE','VIERNES':'VIE','SABADO':'SAB','S√ÅBADO':'SAB','DOMINGO':'DOM','LUN':'LUN','MAR':'MAR','MIE':'MIE','JUE':'JUE','VIE':'VIE','SAB':'SAB','DOM':'DOM'};
      let ok=0,skip=0;
      rows.forEach(r=>{
        const esProgFormat=header[0]&&(header[0].includes('asesor')||header[0].includes('nombre'));
        let asesorRaw=String(r[0]||'').trim(),cliente='',direccion='',dia='',nota='';
        if(esProgFormat){cliente=String(r[1]||'').trim();direccion=String(r[2]||'').trim();nota=String(r[3]||'').trim();const rd=String(r[5]||'').trim().toUpperCase();dia=DIAS_MAP[rd]||rd;}
        else{cliente=String(r[1]||'').trim();direccion=String(r[2]||'').trim();const rd=String(r[5]||r[3]||'').trim().toUpperCase();dia=DIAS_MAP[rd]||rd;}
        let vendedor=NOMBRE_MAP[asesorRaw]||asesorRaw;
        if(!NOMBRE_MAP[asesorRaw]&&asesorRaw){const palabras=asesorRaw.split(' ').filter(p=>p.length>3);const match=usuarios.find(u=>palabras.some(p=>u.nombre.toLowerCase().includes(p.toLowerCase())));if(match)vendedor=match.nombre;}
        if(!cliente||!dia||dia.length>5){skip++;return;}
        const key=vendedor+'|'+dia;
        if(!grupos[key])grupos[key]={vendedor,dia,paradas:[]};
        grupos[key].paradas.push({clienteId:null,clienteNombre:cliente,direccion,telefono:'',ciudad:'Bogot√°',nota,orden:grupos[key].paradas.length+1,visitado:false,omitido:false,gps:null});
        ok++;
      });
      const gList=Object.values(grupos).sort((a,b)=>a.vendedor.localeCompare(b.vendedor)||a.dia.localeCompare(b.dia));
      if(!gList.length){prev.innerHTML='<div class="alert a-warn">‚ö†Ô∏è No se encontraron rutas v√°lidas.</div>';return;}
      const byVend={};gList.forEach(g=>{if(!byVend[g.vendedor])byVend[g.vendedor]=[];byVend[g.vendedor].push(g);});
      let pvHtml=`<div class="alert a-success" style="margin-bottom:.5rem">‚úÖ <strong>${ok}</strong> clientes en <strong>${gList.length}</strong> rutas detectadas</div>`;
      pvHtml+=`<div style="max-height:30vh;overflow-y:auto;margin-bottom:.75rem">`;
      Object.entries(byVend).forEach(([vend,rv])=>{
        pvHtml+=`<div class="fw7 text-sm" style="margin:.3rem 0 .2rem">üë§ ${vend}</div>`;
        rv.forEach(g=>{pvHtml+=`<div style="display:flex;justify-content:space-between;font-size:.78rem;padding:.25rem .5rem;background:var(--card);border-radius:.4rem;margin-bottom:.2rem"><span>üìÖ ${g.dia}</span><span class="text-muted">${g.paradas.length} clientes</span></div>`;});
      });
      pvHtml+=`</div><div class="btn-row"><button class="btn btn-secondary" style="flex:1" onclick="abrirImportRutero()">‚Ü© Cambiar</button><button class="btn btn-success" style="flex:2" onclick="aplicarImportRutero(window._importGrupos)">‚úÖ Cargar ${gList.length} rutas</button></div>`;
      window._importGrupos=gList;
      prev.innerHTML=pvHtml;
    }catch(err){prev.innerHTML=`<div class="alert a-error">‚ùå Error: ${err.message}</div>`;}
  };
  reader.readAsArrayBuffer(file);
}

function aplicarImportRutero(grupos){
  const DIA_DOW={DOM:0,LUN:1,MAR:2,MIE:3,JUE:4,VIE:5,SAB:6};
  let creadas=0,actualizadas=0;
  grupos.forEach(g=>{
    const hoy=new Date(),dow=hoy.getDay(),target=DIA_DOW[g.dia]!==undefined?DIA_DOW[g.dia]:1;
    let diff=target-dow;if(diff<0)diff+=7;
    const fecha=new Date(hoy);fecha.setDate(hoy.getDate()+diff);fecha.setHours(8,0,0,0);
    const ts=fecha.getTime(),nombre=g.dia+' ‚Äì '+g.vendedor;
    const idx=rutas.findIndex(r=>r.importada&&r.vendedor===g.vendedor&&r.dia===g.dia&&r.estado==='pendiente');
    if(idx>=0){rutas[idx].paradas=g.paradas;rutas[idx].timestamp=ts;rutas[idx].nombre=nombre;actualizadas++;}
    else{rutas.push({id:genId(),nombre,vendedor:g.vendedor,dia:g.dia,paradas:g.paradas,estado:'pendiente',timestamp:ts,finTs:null,importada:true});creadas++;}
  });
  sp();
  document.getElementById('rutas-content').innerHTML=`<div class="alert a-success" style="margin-bottom:.75rem">‚úÖ <strong>Rutero cargado</strong><br>${creadas} rutas nuevas ¬∑ ${actualizadas} actualizadas</div><button class="btn btn-primary" style="width:100%" onclick="renderRutas()">Ver rutero completo ‚Üí</button>`;
}

function iniciarRutaPendiente(rutaId){
  const ri=rutas.findIndex(r=>String(r.id)===String(rutaId));if(ri<0)return;
  // Verificar si ya hay una en curso del mismo vendedor
  const enCurso=rutas.find(r=>r.estado==='en_curso'&&r.vendedor===rutas[ri].vendedor);
  if(enCurso)return alert('Ya tienes una ruta en curso. Final√≠zala primero.');
  rutas[ri].estado='en_curso';
  rutas[ri].timestamp=Date.now(); // actualizar inicio real
  sp();renderRutas();
}

function eliminarRuta(rutaId){
  if(!confirm('¬øEliminar esta ruta?'))return;
  const i=rutas.findIndex(r=>String(r.id)===String(rutaId));
  if(i>=0)rutas.splice(i,1);
  sp();renderRutas();
}
function renderRutaEnCurso(ruta){
  const v=ruta.paradas.filter(p=>p.visitado).length;
  const pct=Math.round(v/ruta.paradas.length*100);
  const paradas=ruta.paradas.map((p,i)=>`
    <div class="route-stop">
      <div class="${p.visitado?'route-num visited':p.omitido?'route-num skip':'route-num'}">${p.visitado?'‚úì':p.omitido?'‚úó':(i+1)}</div>
      <div style="flex:1">
        <div class="fw7 text-sm">${p.clienteNombre}</div>
        <div class="text-xs text-muted">${p.direccion||'Sin direcci√≥n'}</div>
        ${p.visitado?`<div class="text-xs text-green">‚úì Visitado ¬∑ ${new Date(p.visitadoTs).toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'})}${p.gps?` ¬∑ üìç ¬±${Math.round(p.gps.acc||0)}m`:''}</div>`:''}
        ${p.omitido?`<div class="text-xs text-muted">‚úó Omitida</div>`:''}
        ${!p.visitado&&!p.omitido?`<div class="btn-row" style="margin-top:.35rem">
          <button class="btn btn-success btn-xs" onclick="marcarVisita('${ruta.id}',${i})">‚úì Registrar visita</button>
          <button class="btn btn-secondary btn-xs" onclick="omitirParada('${ruta.id}',${i})">Omitir</button>
        </div>`:''}
        ${p.nota?`<div class="text-xs text-muted">üìù ${p.nota}</div>`:''}
      </div>
    </div>`).join('');
  return `<div class="card" style="border-color:rgba(0,212,255,.2);margin-bottom:.75rem">
    <div class="row-between" style="margin-bottom:.4rem">
      <div><div class="fw7">${ruta.nombre}</div><div class="text-xs text-muted">${new Date(ruta.timestamp).toLocaleDateString('es-CO')} ¬∑ <span class="gps-dot ${userPos?'on':''}" style="display:inline-block;margin-right:2px"></span>${userPos?'GPS activo':'Sin GPS'}</div></div>
      <span class="badge b-fact">EN CURSO</span>
    </div>
    <div class="route-progress"><div class="route-bar" style="width:${pct}%"></div></div>
    <div class="text-xs text-muted" style="margin-bottom:.75rem">${v}/${ruta.paradas.length} visitas (${pct}%)</div>
    ${paradas}
    <div class="btn-row" style="margin-top:.75rem">
      <button class="btn btn-teal" style="flex:1" onclick="abrirMapaRuta('${ruta.id}')">üó∫Ô∏è Ver mapa</button>
      <button class="btn btn-danger btn-sm" onclick="terminarRuta('${ruta.id}','cancelada')">‚úó</button>
      <button class="btn btn-success" style="flex:2" onclick="terminarRuta('${ruta.id}','completada')">‚úì Finalizar</button>
    </div>
  </div>`;
}
async function marcarVisita(rutaId,idx){
  const ri=rutas.findIndex(r=>String(r.id)===String(rutaId));if(ri<0)return;
  let pos=userPos;
  try{pos=await getGPS();}catch(e){}
  rutas[ri].paradas[idx].visitado=true;
  rutas[ri].paradas[idx].visitadoTs=Date.now();
  rutas[ri].paradas[idx].gps=pos;
  sp();renderRutas();
}

function pedidoDesdeParada(clienteId, rutaId, idx){
  // Guardar contexto de ruta para marcar visita autom√°ticamente al confirmar pedido
  window._pedidoRutaCtx={rutaId:String(rutaId),idx};
  const cl=clientes.find(c=>c.id===clienteId);if(!cl)return;
  closeRutaModal&&closeRutaModal();
  pedidoCliente={id:cl.id,nombre:cl.nombre,telefono:cl.telefono||'',direccion:cl.direccion||'',nota:'',ciudad:cl.ciudad||''};
  carrito={};
  pedidoStepNum=2;
  goTab('nuevo');
}
function omitirParada(rutaId,idx){const ri=rutas.findIndex(r=>String(r.id)===String(rutaId));if(ri<0)return;rutas[ri].paradas[idx].omitido=true;sp();renderRutas();}
function terminarRuta(rutaId,estado){if(!confirm(`¬ø${estado==='completada'?'Finalizar':'Cancelar'} la ruta?`))return;const ri=rutas.findIndex(r=>String(r.id)===String(rutaId));if(ri>=0){rutas[ri].estado=estado;rutas[ri].finTs=Date.now();}sp();renderRutas();}
function abrirModalRuta(){
  const cliActivos=clientes.filter(c=>c.activo);
  const vendorOpts=[...usuarios].filter(u=>u.activo).sort((a,b)=>a.nombre.localeCompare(b.nombre)).map(u=>`<option value="${u.nombre}" ${u.nombre===session.nombre?'selected':''}>${u.nombre} (${u.rol})</option>`).join('');
  document.getElementById('modal-ruta-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">üó∫Ô∏è Nueva ruta del d√≠a</div>
  <div class="form-stack">
    <div class="field"><label class="label">Nombre de la ruta</label><input class="input" id="rn-nombre" placeholder="Ej: Zona Norte ‚Äì Lunes"/></div>
    <div class="field"><label class="label">Vendedor</label>
      <select class="input" id="rn-vendedor" onchange="filtrarClientesPorVendedor()">${vendorOpts}</select>
    </div>
    <div class="field">
      <label class="label">Agregar clientes (en orden de visita)</label>
      <div class="btn-row">
        <select class="input" id="rn-cli-sel" style="flex:1"><option value="">‚Äî Seleccionar ‚Äî</option>${cliActivos.map(c=>`<option value="${c.id}" data-v="${(c.vendedor||'').toLowerCase()}">${c.nombre}${c.ciudad?' ¬∑ '+c.ciudad:''}</option>`).join('')}</select>
        <button class="btn btn-secondary" onclick="addParadaForm()">+</button>
      </div>
      <label style="display:flex;align-items:center;gap:.4rem;font-size:.72rem;color:var(--muted);cursor:pointer;margin-top:.3rem">
        <input type="checkbox" id="rn-filtrar-vend" checked onchange="filtrarClientesPorVendedor()"> Solo clientes de este vendedor
      </label>
    </div>
    <div id="ruta-paradas-form"><div class="text-xs text-muted">Sin paradas a√∫n</div></div>
  </div>
  <div class="btn-row" style="margin-top:.875rem">
    <button class="btn btn-secondary" style="flex:1" onclick="closeRutaModal()">Cancelar</button>
    <button class="btn btn-primary" style="flex:2" onclick="crearRuta()">üöÄ Iniciar ruta</button>
  </div>`;
  window._rutaParadasTemp=[];
  setTimeout(()=>filtrarClientesPorVendedor(),50);
  document.getElementById('modal-ruta').classList.add('open');
}
function filtrarClientesPorVendedor(){
  const vendedorSel=(document.getElementById('rn-vendedor')?.value||'').toLowerCase();
  const filtrar=document.getElementById('rn-filtrar-vend')?.checked;
  const sel=document.getElementById('rn-cli-sel');
  if(!sel)return;
  const cliActivos=clientes.filter(c=>c.activo);
  const filtrados=filtrar&&vendedorSel?cliActivos.filter(c=>!c.vendedor||c.vendedor.toLowerCase()===vendedorSel):cliActivos;
  sel.innerHTML=`<option value="">‚Äî Seleccionar ‚Äî</option>${filtrados.map(c=>`<option value="${c.id}">${c.nombre}${c.ciudad?' ¬∑ '+c.ciudad:''}</option>`).join('')}`;
}
function addParadaForm(){
  const sel=document.getElementById('rn-cli-sel');const cliId=Number(sel.value);if(!cliId)return;
  const cl=clientes.find(c=>c.id===cliId);if(!cl)return;
  if(window._rutaParadasTemp.find(p=>p.clienteId===cliId))return alert('Ya est√° en la ruta');
  window._rutaParadasTemp.push({clienteId:cliId,clienteNombre:cl.nombre,direccion:cl.direccion||'',telefono:cl.telefono||'',nota:'',visitado:false,omitido:false,gps:null});
  sel.value='';renderParadasForm();
}
function renderParadasForm(){
  const el=document.getElementById('ruta-paradas-form');
  if(!window._rutaParadasTemp.length){el.innerHTML='<div class="text-xs text-muted">Sin paradas a√∫n</div>';return;}
  el.innerHTML=window._rutaParadasTemp.map((p,i)=>`<div class="route-stop" style="background:var(--card);border-radius:.7rem;padding:.55rem;margin-bottom:.35rem">
    <div class="route-num">${i+1}</div>
    <div style="flex:1"><div class="fw7 text-sm">${p.clienteNombre}</div>
    <div class="text-xs text-muted">${p.direccion||'Sin direcci√≥n'}</div>
    <input class="input" style="margin-top:.3rem;font-size:.75rem;padding:.35rem .55rem" placeholder="Nota..." oninput="window._rutaParadasTemp[${i}].nota=this.value" value="${p.nota}"/></div>
    <button class="btn btn-danger btn-xs" onclick="window._rutaParadasTemp.splice(${i},1);renderParadasForm()">‚úï</button>
  </div>`).join('');
}
function crearRuta(){
  const nombre=document.getElementById('rn-nombre').value.trim();
  const vendedor=document.getElementById('rn-vendedor').value;
  if(!nombre)return alert('Ingresa el nombre de la ruta');
  if(!window._rutaParadasTemp.length)return alert('Agrega al menos un cliente');
  rutas.push({id:genId(),nombre,vendedor,paradas:[...window._rutaParadasTemp],estado:'en_curso',timestamp:Date.now(),finTs:null});
  sp();closeRutaModal();renderRutas();
}
function verRuta(id){
  const ruta=rutas.find(r=>String(r.id)===String(id));if(!ruta)return;
  renderVerRuta(ruta);
  document.getElementById('modal-ruta').classList.add('open');
}

function renderVerRuta(ruta){
  const isAdmin=session.rol==='admin'||session.rol==='super';
  const esPropia=ruta.vendedor===session.nombre;
  const puedeGestionar=isAdmin||esPropia;
  const v=ruta.paradas.filter(p=>p.visitado).length;
  const pct=ruta.paradas.length?Math.round(v/ruta.paradas.length*100):0;
  const enCurso=ruta.estado==='en_curso';
  const DIAS={LUN:'Lunes',MAR:'Martes',MIE:'Mi√©rcoles',JUE:'Jueves',VIE:'Viernes',SAB:'S√°bado',DOM:'Domingo'};

  const paradasHtml=ruta.paradas.map((p,i)=>{
    // Buscar cliente en base de datos para obtener m√°s info
    const clDB=p.clienteId?clientes.find(c=>c.id===p.clienteId):clientes.find(c=>c.nombre.toLowerCase()===p.clienteNombre.toLowerCase());
    const tieneCliente=!!clDB;
    
    // Pedidos anteriores de este cliente
    const pedsCli=clDB?pedidos.filter(ped=>ped.clienteId===clDB.id).sort((a,b)=>b.timestamp-a.timestamp):[];
    const ultimoPed=pedsCli[0];

    const estadoIcon=p.visitado?'‚úì':p.omitido?'‚úó':(i+1);
    const estadoCls=p.visitado?'route-num visited':p.omitido?'route-num skip':'route-num';

    // Botones de acci√≥n seg√∫n estado y permisos
    let accionesHtml='';
    if(puedeGestionar){
      if(!p.visitado&&!p.omitido){
        accionesHtml=`<div class="btn-row" style="margin-top:.4rem;flex-wrap:wrap;gap:.3rem">
          <button class="btn btn-primary btn-sm" style="flex:2;min-width:0" onclick="abrirPedidoDesdeRuta('${ruta.id}',${i})">üõí Gestionar pedido</button>
          ${enCurso?`<button class="btn btn-success btn-sm" onclick="marcarVisitaRapida('${ruta.id}',${i})">‚úì Visita</button>`:''}
          ${enCurso?`<button class="btn btn-secondary btn-sm" onclick="omitirParada('${ruta.id}',${i});renderVerRuta(rutas.find(r=>String(r.id)==='${ruta.id}'))">Omitir</button>`:''}
        </div>`;
      } else if(p.visitado){
        accionesHtml=`<div class="btn-row" style="margin-top:.35rem">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="abrirPedidoDesdeRuta('${ruta.id}',${i})">üõí Nuevo pedido</button>
          ${pedsCli.length?`<button class="btn btn-teal btn-sm" onclick="verPedidoModal('${ultimoPed.id}')">üìã Ver √∫ltimo</button>`:''}
        </div>`;
      }
    } else {
      // Solo lectura para vendedores viendo rutas de otros
      accionesHtml='';
    }

    return `<div class="route-stop" style="background:var(--card);border-radius:.7rem;padding:.55rem .7rem;margin-bottom:.4rem;${p.visitado?'opacity:.75':''}">
      <div class="${estadoCls}">${estadoIcon}</div>
      <div style="flex:1;min-width:0">
        <div class="fw7 text-sm" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.clienteNombre}</div>
        ${p.direccion?`<div class="text-xs text-muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">üìç ${p.direccion}</div>`:''}
        ${p.nota?`<div class="text-xs text-muted">üìù ${p.nota}</div>`:''}
        ${p.visitado?`<div class="text-xs" style="color:var(--green)">‚úì Visitado ${p.visitadoTs?new Date(p.visitadoTs).toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'}):''}</div>`:''}
        ${p.omitido?`<div class="text-xs text-muted">‚úó Omitido</div>`:''}
        ${ultimoPed&&!p.omitido?`<div class="text-xs text-muted" style="margin-top:.15rem">üßæ √öltimo pedido: ${fmt(ultimoPed.total)} ¬∑ ${new Date(ultimoPed.timestamp).toLocaleDateString('es-CO',{day:'numeric',month:'short'})}</div>`:''}
        ${accionesHtml}
      </div>
    </div>`;
  }).join('');

  // Barra de progreso + acciones de ruta
  let rutaAcciones='';
  if(puedeGestionar&&ruta.estado==='pendiente'){
    rutaAcciones=`<button class="btn btn-success" style="flex:2" onclick="iniciarRutaPendiente('${ruta.id}');document.getElementById('modal-ruta').classList.remove('open');setTimeout(()=>{renderRutas();abrirMapaRuta('${ruta.id}')},300)">‚ñ∂ Iniciar ruta</button>`;
  } else if(enCurso){
    rutaAcciones=`<button class="btn btn-teal btn-sm" style="flex:1" onclick="closeRutaModal();setTimeout(()=>abrirMapaRuta('${ruta.id}'),100)">üó∫Ô∏è Mapa</button>
    <button class="btn btn-success btn-sm" style="flex:1" onclick="terminarRuta('${ruta.id}','completada');closeRutaModal()">‚úì Finalizar</button>`;
  }

  document.getElementById('modal-ruta-content').innerHTML=`
    <div class="modal-handle"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem">
      <div>
        <div class="fw7" style="font-size:1.05rem">${DIAS[ruta.dia]||ruta.dia||ruta.nombre}</div>
        <div class="text-xs text-muted">üë§ ${ruta.vendedor} ¬∑ ${ruta.paradas.length} clientes</div>
      </div>
      <span class="badge ${ruta.estado==='en_curso'?'b-fact':ruta.estado==='completada'?'b-done':ruta.estado==='cancelada'?'b-cancel':''}" style="${ruta.estado==='pendiente'?'background:rgba(0,212,255,.1);color:var(--accent)':''}">${ruta.estado==='en_curso'?'EN CURSO':ruta.estado==='completada'?'COMPLETADA':ruta.estado==='cancelada'?'CANCELADA':'PENDIENTE'}</span>
    </div>
    ${ruta.paradas.length?`<div style="background:var(--bg);border-radius:.5rem;padding:.4rem .6rem;margin-bottom:.6rem">
      <div style="display:flex;justify-content:space-between;font-size:.75rem;margin-bottom:.3rem"><span class="text-muted">${v} visitados ¬∑ ${ruta.paradas.length-v-ruta.paradas.filter(p=>p.omitido).length} pendientes</span><span class="fw7">${pct}%</span></div>
      <div class="route-progress"><div class="route-bar" style="width:${pct}%"></div></div>
    </div>`:''}
    <div style="max-height:52vh;overflow-y:auto;padding-right:.1rem">${paradasHtml}</div>
    <div class="btn-row" style="margin-top:.6rem">
      <button class="btn btn-secondary btn-sm" onclick="closeRutaModal()">‚úï Cerrar</button>
      ${rutaAcciones}
    </div>`;
}

async function marcarVisitaRapida(rutaId, idx){
  const ri=rutas.findIndex(r=>String(r.id)===String(rutaId));if(ri<0)return;
  let pos=userPos;
  try{pos=await getGPS();}catch(e){}
  rutas[ri].paradas[idx].visitado=true;
  rutas[ri].paradas[idx].visitadoTs=Date.now();
  rutas[ri].paradas[idx].gps=pos;
  sp();
  renderVerRuta(rutas[ri]);
  if(document.getElementById('page-rutas').classList.contains('active'))renderRutas();
}

function abrirPedidoDesdeRuta(rutaId, idx){
  const ruta=rutas.find(r=>String(r.id)===String(rutaId));if(!ruta)return;
  const parada=ruta.paradas[idx];
  
  // Guardar contexto para marcar visita autom√°ticamente al confirmar pedido
  window._pedidoRutaCtx={rutaId:String(rutaId),idx};
  
  // Buscar o crear cliente temporal
  let cl=parada.clienteId?clientes.find(c=>c.id===parada.clienteId):clientes.find(c=>c.nombre.toLowerCase()===parada.clienteNombre.toLowerCase());
  
  if(!cl){
    // Cliente no registrado ‚Üí usar datos de la parada como cliente temporal
    cl={id:null,nombre:parada.clienteNombre,telefono:parada.telefono||'',direccion:parada.direccion||'',nota:'',ciudad:parada.ciudad||'Bogot√°'};
  }
  
  closeRutaModal();
  pedidoCliente={id:cl.id,nombre:cl.nombre,telefono:cl.telefono||'',direccion:cl.direccion||'',nota:'',ciudad:cl.ciudad||''};
  carrito={};
  pedidoStepNum=2;
  goTab('nuevo');
}

function verPedidoModal(pedidoId){
  const p=pedidos.find(ped=>ped.id===pedidoId);if(!p)return;
  const cl=clientes.find(c=>c.id===p.clienteId);
  const items=Object.values(p.items||{}).map(it=>`<div style="display:flex;justify-content:space-between;font-size:.8rem;padding:.2rem 0;border-bottom:1px solid var(--border)"><span>${it.nombre}</span><span class="text-muted">${it.qty} √ó ${fmt(it.precio)} = ${fmt(it.qty*it.precio)}</span></div>`).join('');
  document.getElementById('modal-ruta-content').innerHTML=`
    <div class="modal-handle"></div>
    <div class="modal-title">üìã Pedido #${String(p.id).slice(-4)}</div>
    <div class="text-xs text-muted" style="margin-bottom:.5rem">üìÖ ${new Date(p.timestamp).toLocaleString('es-CO')} ¬∑ üë§ ${cl?cl.nombre:p.clienteNombre||'‚Äî'}</div>
    <div style="max-height:40vh;overflow-y:auto">${items}</div>
    <div style="display:flex;justify-content:space-between;padding:.5rem 0;font-weight:700;font-size:.9rem;border-top:2px solid var(--border);margin-top:.3rem"><span>Total</span><span style="color:var(--accent)">${fmt(p.total)}</span></div>
    <div class="btn-row" style="margin-top:.5rem">
      <button class="btn btn-secondary" style="flex:1" onclick="history.go(-1)">‚Üê Volver</button>
    </div>`;
}

function closeRutaModal(e){if(!e||e.target===document.getElementById('modal-ruta'))document.getElementById('modal-ruta').classList.remove('open');}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EXHIBICIONES ‚Äî An√°lisis de fotos por PDV con IA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let exhibFiltroVendedor='todos', exhibFiltroPDV='';

function renderExhibiciones(){
  const el=document.getElementById('exhibiciones-content');
  if(!el)return;

  // Recopilar todas las fotos de evidencia de todas las rutas
  const todasFotos=[];
  rutas.forEach(r=>{
    r.paradas.forEach(p=>{
      if(p.fotos&&p.fotos.length>0){
        p.fotos.forEach(f=>{
          todasFotos.push({
            img: f.img||f,
            hora: f.hora||'',
            gps: f.gps||null,
            vendedor: f.vendedor||r.vendedor||'',
            cliente: p.clienteNombre||'',
            direccion: p.direccion||'',
            rutaNombre: r.nombre||'',
            rutaId: r.id,
            visitadoTs: p.visitadoTs||0
          });
        });
      }
    });
  });

  // Filtros
  const vendedores=['todos',...new Set(todasFotos.map(f=>f.vendedor).filter(Boolean))];
  const fotosFiltradas=todasFotos.filter(f=>{
    const vOk=exhibFiltroVendedor==='todos'||f.vendedor===exhibFiltroVendedor;
    const pOk=!exhibFiltroPDV||f.cliente.toLowerCase().includes(exhibFiltroPDV.toLowerCase());
    return vOk&&pOk;
  });

  // Agrupar por cliente/PDV
  const porPDV={};
  fotosFiltradas.forEach(f=>{
    const key=f.cliente||'Sin nombre';
    if(!porPDV[key])porPDV[key]={cliente:key,fotos:[],vendedor:f.vendedor,direccion:f.direccion};
    porPDV[key].fotos.push(f);
  });
  const pdvList=Object.values(porPDV).sort((a,b)=>b.fotos.length-a.fotos.length);

  el.innerHTML=`
    <div class="card" style="background:linear-gradient(135deg,rgba(124,77,255,.08),rgba(0,212,255,.05));border-color:rgba(124,77,255,.25)">
      <div class="card-title">üñºÔ∏è Control de Exhibiciones</div>
      <div style="font-size:.78rem;color:var(--muted2)">An√°lisis IA de exhibiciones por punto de venta ¬∑ ${todasFotos.length} fotos en total</div>
    </div>

    <div class="card">
      <div class="form-stack">
        <div class="form-grid">
          <div class="field">
            <label class="label">Vendedor</label>
            <select class="input" onchange="exhibFiltroVendedor=this.value;renderExhibiciones()">
              ${vendedores.map(v=>`<option value="${v}" ${exhibFiltroVendedor===v?'selected':''}>${v==='todos'?'Todos':v}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label class="label">Buscar PDV</label>
            <input class="input" placeholder="Nombre cliente..." value="${exhibFiltroPDV}" oninput="exhibFiltroPDV=this.value;renderExhibiciones()"/>
          </div>
        </div>
      </div>
    </div>

    ${todasFotos.length===0?`
      <div class="empty">
        <div class="empty-ico">üñºÔ∏è</div>
        <div>A√∫n no hay fotos de evidencia.</div>
        <div class="text-xs text-muted" style="margin-top:.3rem">Los vendedores deben tomar fotos desde el mapa de rutas ‚Üí Evidencia</div>
      </div>`:
    pdvList.length===0?`<div class="empty"><div class="empty-ico">üîç</div><div>Sin resultados para este filtro</div></div>`:
    pdvList.map(pdv=>`
      <div class="card" style="margin-bottom:.5rem">
        <div class="card-title-row">
          <div>
            <div style="font-weight:700;font-size:.92rem">üè™ ${pdv.cliente}</div>
            <div style="font-size:.68rem;color:var(--muted)">üìç ${pdv.direccion||'Sin direcci√≥n'} ¬∑ üë§ ${pdv.vendedor}</div>
          </div>
          <span style="background:rgba(124,77,255,.15);color:var(--purple);border:1px solid rgba(124,77,255,.25);border-radius:2rem;padding:.2rem .6rem;font-size:.68rem;font-weight:700">${pdv.fotos.length} foto${pdv.fotos.length!==1?'s':''}</span>
        </div>
        <div style="display:flex;gap:.4rem;overflow-x:auto;padding-bottom:.3rem;margin-bottom:.7rem">
          ${pdv.fotos.map((f,i)=>`
            <div style="flex-shrink:0;position:relative">
              <img src="${f.img}" style="width:90px;height:90px;object-fit:cover;border-radius:.5rem;border:1px solid var(--border)"/>
              ${f.hora?`<div style="position:absolute;bottom:2px;left:2px;background:rgba(0,0,0,.75);color:#fff;font-size:.38rem;padding:1px 2px;border-radius:2px;line-height:1.3">${f.hora}</div>`:''}
            </div>`).join('')}
        </div>
        <button class="btn btn-purple btn-full" onclick="analizarExhibicionIA('${pdv.cliente}',${JSON.stringify(pdv.fotos.map(f=>f.img)).replace(/'/g,'&#39;')})">
          ü§ñ Analizar exhibici√≥n con IA
        </button>
        <div id="ia-exhib-${pdv.cliente.replace(/\s/g,'-')}" style="margin-top:.5rem"></div>
      </div>`).join('')}
  `;
}

async function analizarExhibicionIA(cliente, imagenes){
  const safeId=cliente.replace(/\s/g,'-');
  const el=document.getElementById('ia-exhib-'+safeId);
  if(!el)return;
  el.innerHTML=`<div style="background:var(--card);border:1px solid var(--border);border-radius:.75rem;padding:.875rem;text-align:center">
    <div class="ia-thinking" style="justify-content:center"><span></span><span></span><span></span></div>
    <div style="font-size:.75rem;color:var(--muted);margin-top:.5rem">IA analizando exhibici√≥n...</div>
  </div>`;

  // Preparar im√°genes como base64 para la API (m√°ximo 3 fotos para no exceder l√≠mites)
  const imgs=imagenes.slice(0,3);
  const content=[];
  imgs.forEach((img,i)=>{
    // Extraer base64 del dataURL
    const base64=img.split(',')[1];
    const mtype=img.startsWith('data:image/png')?'image/png':'image/jpeg';
    content.push({type:'image',source:{type:'base64',media_type:mtype,data:base64}});
    content.push({type:'text',text:`Foto ${i+1} de la exhibici√≥n en PDV: ${cliente}`});
  });
  content.push({type:'text',text:`Analiza estas ${imgs.length} foto(s) de exhibici√≥n del punto de venta "${cliente}". 
Eval√∫a con criterio de excelencia comercial:
1. üìä PUNTUACI√ìN GENERAL (0-100)
2. ‚úÖ FORTALEZAS de la exhibici√≥n
3. ‚ö†Ô∏è OPORTUNIDADES DE MEJORA
4. üéØ RECOMENDACIONES CONCRETAS para mejorar la visibilidad de nuestras marcas
5. üèÜ NIVEL: Deficiente / Regular / Bueno / Excelente

S√© espec√≠fico, pr√°ctico y usa emojis. M√°ximo 200 palabras.`});

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:600,
        messages:[{role:'user',content}]
      })
    });
    const data=await resp.json();
    const txt=data.content?.[0]?.text||'No se pudo analizar.';
    const html=txt.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
    el.innerHTML=`<div style="background:rgba(124,77,255,.06);border:1px solid rgba(124,77,255,.2);border-radius:.75rem;padding:.875rem;font-size:.8rem;line-height:1.6">
      <div style="font-weight:700;color:var(--purple);margin-bottom:.5rem;font-size:.85rem">ü§ñ An√°lisis IA ¬∑ ${cliente}</div>
      ${html}
      <div style="margin-top:.6rem;padding-top:.5rem;border-top:1px solid rgba(124,77,255,.15);font-size:.65rem;color:var(--muted)">Analizado: ${new Date().toLocaleString('es-CO')}</div>
    </div>`;
  }catch(e){
    el.innerHTML=`<div class="alert a-err">‚ö†Ô∏è Error al conectar con la IA. Verifica tu conexi√≥n.</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REPORTES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let chartVentas=null,chartProd=null,chartPago=null;
let reportePeriodo='7d',reporteSucursal='all';
function renderReportes(){
  const el=document.getElementById('reportes-content');
  const now=Date.now();

  // Period filter
  let desde;
  if(reportePeriodo==='7d')desde=now-7*86400000;
  else if(reportePeriodo==='30d')desde=now-30*86400000;
  else if(reportePeriodo==='mes'){const d=new Date();d.setDate(1);d.setHours(0,0,0,0);desde=d.getTime();}
  else desde=0; // all time

  // Branch filter
  const pedFilt=pedidos.filter(p=>p.timestamp>=desde&&(reporteSucursal==='all'||String(p.sucursalId)===String(reporteSucursal)));

  // Last N days chart
  const dias=reportePeriodo==='7d'?7:30;
  const daysArr=Array.from({length:dias},(_,i)=>{const d=new Date(now-i*86400000);return d.toDateString();}).reverse();
  const labels7=daysArr.map(d=>new Date(d).toLocaleDateString('es-CO',{weekday:'short',day:'numeric'}));
  const data7=daysArr.map(d=>pedFilt.filter(p=>new Date(p.timestamp).toDateString()===d&&['completado','facturado'].includes(p.estado)).reduce((s,p)=>s+p.total,0));

  // Top productos
  const prodVentas={};
  pedFilt.filter(p=>['completado','facturado'].includes(p.estado)).forEach(p=>p.items.forEach(i=>{prodVentas[i.nombre]=(prodVentas[i.nombre]||0)+i.qty;}));
  const topProds=Object.entries(prodVentas).sort((a,b)=>b[1]-a[1]).slice(0,6);

  // Formas de pago
  const pagoCount={efectivo:0,transferencia:0,credito:0,datafono:0};
  pedFilt.filter(p=>['completado','facturado'].includes(p.estado)).forEach(p=>{if(pagoCount[p.formaPago]!==undefined)pagoCount[p.formaPago]++;});

  // Stats gral
  const pedComp=pedFilt.filter(p=>['completado','facturado'].includes(p.estado));
  const total=pedComp.reduce((s,p)=>s+p.total,0);
  const ticketProm=pedComp.length?total/pedComp.length:0;
  const convRate=pedFilt.length?Math.round(pedComp.length/pedFilt.length*100):0;

  // Top vendedores
  const vendV={};
  pedComp.forEach(p=>{vendV[p.vendedor]=(vendV[p.vendedor]||0)+p.total;});
  const topVend=Object.entries(vendV).sort((a,b)=>b[1]-a[1]).slice(0,5);

  // Por sucursal
  const sucStats=sucursales.map(s=>{
    const sp2=pedComp.filter(p=>p.sucursalId===s.id);
    return {nombre:s.nombre,color:s.color,total:sp2.reduce((a,p)=>a+p.total,0),count:sp2.length};
  }).filter(s=>s.count>0);

  // Stock cr√≠tico
  const stockCritico=productos.filter(p=>p.stock===0);
  const stockBajoList=productos.filter(p=>p.stock>0&&p.stock<=(p.stockMin||config.stockMinGlobal||5));

  const sucOpts=sucursales.map(s=>`<option value="${s.id}" ${reporteSucursal===String(s.id)?'selected':''}>${s.nombre}</option>`).join('');

  el.innerHTML=`
  <div class="row-between" style="gap:.4rem;flex-wrap:wrap">
    <div class="tabs" style="flex:2;min-width:200px">
      <button class="tab ${reportePeriodo==='7d'?'active':''}" onclick="reportePeriodo='7d';renderReportes()">7 d√≠as</button>
      <button class="tab ${reportePeriodo==='30d'?'active':''}" onclick="reportePeriodo='30d';renderReportes()">30 d√≠as</button>
      <button class="tab ${reportePeriodo==='mes'?'active':''}" onclick="reportePeriodo='mes';renderReportes()">Este mes</button>
      <button class="tab ${reportePeriodo==='all'?'active':''}" onclick="reportePeriodo='all';renderReportes()">Todo</button>
    </div>
    ${sucursales.length>1?`<select class="input" style="flex:1;min-width:120px;padding:.42rem .7rem;font-size:.75rem" onchange="reporteSucursal=this.value;renderReportes()"><option value="all" ${reporteSucursal==='all'?'selected':''}>Todas las sedes</option>${sucOpts}</select>`:''}
  </div>

  <div class="stats-grid">
    <div class="stat"><div class="stat-val c-accent">${fmt(total)}</div><div class="stat-lbl">Total ventas</div></div>
    <div class="stat"><div class="stat-val c-green">${pedComp.length}</div><div class="stat-lbl">Pedidos</div></div>
    <div class="stat"><div class="stat-val c-orange">${fmt(ticketProm)}</div><div class="stat-lbl">Ticket prom.</div></div>
    <div class="stat"><div class="stat-val c-purple">${convRate}%</div><div class="stat-lbl">Conversi√≥n</div></div>
  </div>

  <div class="card">
    <div class="card-title">üìà Ventas ${reportePeriodo==='7d'?'√∫ltimos 7 d√≠as':reportePeriodo==='30d'?'√∫ltimos 30 d√≠as':reportePeriodo==='mes'?'este mes':'hist√≥ricas (resumen)'}</div>
    <div class="chart-wrap"><canvas id="chart-ventas"></canvas></div>
  </div>

  ${topProds.length?`<div class="card">
    <div class="card-title">üèÜ Productos m√°s vendidos</div>
    ${topProds.map(([nombre,qty],i)=>`<div class="order-item">
      <div class="oi-name">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'¬∑'} ${nombre}</div>
      <div class="fw7 mono c-accent">${fmtN(qty)} unid.</div>
    </div>`).join('')}
  </div>`:''}

  ${topVend.length?`<div class="card">
    <div class="card-title">üë®‚Äçüíº Ranking vendedores</div>
    ${topVend.map(([nombre,tot],i)=>`<div class="order-item">
      <div class="row"><div style="width:22px;text-align:center">${i+1}¬∞</div><div class="oi-name">${nombre}</div></div>
      <div class="fw7 mono c-green">${fmt(tot)}</div>
    </div>`).join('')}
  </div>`:''}

  ${sucStats.length>1?`<div class="card">
    <div class="card-title">üè¢ Por sucursal</div>
    ${sucStats.map(s=>`<div class="order-item">
      <div class="row"><div class="suc-dot" style="background:#${s.color}"></div><div class="oi-name">${s.nombre}</div></div>
      <div style="text-align:right"><div class="fw7 mono c-accent" style="font-size:.82rem">${fmt(s.total)}</div><div class="text-xs text-muted">${s.count} pedidos</div></div>
    </div>`).join('')}
  </div>`:''}

  <div class="card">
    <div class="card-title">üí≥ Formas de pago</div>
    <div class="chart-wrap" style="height:160px"><canvas id="chart-pago"></canvas></div>
  </div>

  <div class="card">
    <div class="card-title">‚ö†Ô∏è Control de inventario</div>
    ${stockCritico.length?`<div class="alert a-err" style="margin-bottom:.5rem">üö® <strong>${stockCritico.length}</strong> producto${stockCritico.length>1?'s':''} sin stock: ${stockCritico.map(p=>p.nombre).join(', ')}</div>`:''}
    ${stockBajoList.length?stockBajoList.map(p=>`<div class="order-item">
      <div><div class="oi-name">${p.emoji} ${p.nombre}</div><div class="oi-detail">${p.categoria} ¬∑ m√≠n: ${p.stockMin||5}</div></div>
      <div class="text-orange fw7">${p.stock} unid.</div>
    </div>`).join(''):'<div class="text-green text-sm">‚úì Todo el stock est√° bien</div>'}
  </div>

  <button class="btn btn-teal btn-full" onclick="exportarReporteCSV()">‚¨áÔ∏è Exportar reporte CSV</button>`;

  // Draw charts
  setTimeout(()=>{
    const ctx1=document.getElementById('chart-ventas')?.getContext('2d');
    if(ctx1){
      if(chartVentas)chartVentas.destroy();
      chartVentas=new Chart(ctx1,{type:'bar',data:{labels:labels7,datasets:[{label:'Ventas',data:data7,backgroundColor:'rgba(0,212,255,.3)',borderColor:'rgba(0,212,255,.8)',borderWidth:1,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#5a6a80',font:{size:9}},grid:{color:'rgba(255,255,255,.04)'}},y:{ticks:{color:'#5a6a80',font:{size:9},callback:v=>'$'+v.toLocaleString('es-CO')},grid:{color:'rgba(255,255,255,.04)'}}}}});
    }
    const ctx2=document.getElementById('chart-pago')?.getContext('2d');
    if(ctx2){
      if(chartPago)chartPago.destroy();
      const labels=['Efectivo','Transferencia','Cr√©dito','Dat√°fono'];
      const vals=[pagoCount.efectivo,pagoCount.transferencia,pagoCount.credito,pagoCount.datafono];
      chartPago=new Chart(ctx2,{type:'doughnut',data:{labels,datasets:[{data:vals,backgroundColor:['rgba(0,212,255,.6)','rgba(0,230,118,.6)','rgba(255,152,0,.6)','rgba(124,77,255,.6)'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8899aa',font:{size:9},boxWidth:10}}}}});
    }
  },100);
}

function exportarReporteCSV(){
  const now=Date.now();
  let desde;
  if(reportePeriodo==='7d')desde=now-7*86400000;
  else if(reportePeriodo==='30d')desde=now-30*86400000;
  else if(reportePeriodo==='mes'){const d=new Date();d.setDate(1);d.setHours(0,0,0,0);desde=d.getTime();}
  else desde=0;
  const filt=pedidos.filter(p=>p.timestamp>=desde&&['completado','facturado'].includes(p.estado)&&(reporteSucursal==='all'||String(p.sucursalId)===String(reporteSucursal)));
  const headers=['#Pedido','Fecha','Cliente','Telefono','Ciudad','Vendedor','Sucursal','Productos','Total','FormaPago','Estado'];
  const rows=filt.map(p=>[
    p.numero,
    new Date(p.timestamp).toLocaleDateString('es-CO'),
    p.cliente,p.telefono||'',p.ciudad||'',p.vendedor,
    sucursales.find(s=>s.id===p.sucursalId)?.nombre||'',
    p.items.map(i=>`${i.nombre}x${i.qty}`).join('; '),
    p.total,p.formaPago,p.estado
  ]);
  const csv=[headers.join(','),...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`reporte_ventas_${new Date().toLocaleDateString('es-CO').replace(/\//g,'-')}.csv`;
  a.click();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PRODUCTOS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderProductos(){
  const busq=(document.getElementById('prod-search')?.value||'').toLowerCase();
  const lista=productos.filter(p=>p.nombre.toLowerCase().includes(busq)||p.categoria.toLowerCase().includes(busq));
  const stockBajo=lista.filter(p=>p.stock<=(p.stockMin||5));
  const alEl=document.getElementById('stock-alerts');
  if(alEl)alEl.innerHTML=stockBajo.length?`<div class="stock-alert">‚ö†Ô∏è ${stockBajo.length} producto${stockBajo.length>1?'s':''} con stock bajo</div>`:'';
  const el=document.getElementById('productos-lista');
  if(!lista.length){el.innerHTML=`<div class="empty"><div class="empty-ico">üì¶</div>Sin productos. Agrega o importa desde Excel.</div>`;return;}
  el.innerHTML=lista.map(p=>{
    const low=p.stock<=(p.stockMin||5);
    return `<div class="ped-card" style="margin-top:.55rem;cursor:default;${low?'border-color:rgba(255,152,0,.35)':''}">
      <div class="row-between">
        <div class="row"><span style="font-size:1.6rem">${p.emoji}</span>
          <div><div class="fw7 text-sm">${p.nombre}</div>
          <div class="text-xs text-muted">${p.categoria} ¬∑ Stock: <span class="${low?'text-orange':'text-green'}">${p.stock}</span>${low?' ‚ö†Ô∏è':''}</div></div>
        </div>
        <div style="text-align:right">
          <div class="text-accent fw7 mono">${fmt(p.precio)}</div>
          <div class="btn-row" style="margin-top:.3rem">
            <button class="btn btn-teal btn-xs" onclick="ajustarStock(${p.id})">üì¶</button>
            <button class="btn btn-secondary btn-xs" onclick="abrirModalProducto(${p.id})">‚úèÔ∏è</button>
            <button class="btn btn-danger btn-xs" onclick="eliminarProducto(${p.id})">üóëÔ∏è</button>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}
const EMOJIS=['üì¶','üõçÔ∏è','‚ú®','üçï','ü•§','üëï','üíä','üîß','üì±','üéÅ','üåø','üè†','üß¥','üç´','‚öΩ','üéÆ','üñ•Ô∏è','üßÉ','üöó','üíº','üì∏','üéµ','üß∫','üîë','üçé','ü•©','üßÄ','üç∫','üåæ','üéí'];
function abrirModalProducto(id){
  const p=id?productos.find(x=>x.id===id):null;
  const f=p||{nombre:'',precio:'',categoria:'General',stock:'',stockMin:5,emoji:'üì¶'};
  document.getElementById('modal-prod-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">${p?'‚úèÔ∏è Editar':'‚ûï Nuevo'} producto</div>
  <div class="form-stack">
    <div class="field"><label class="label">Emoji</label>
      <div class="emoji-grid">${EMOJIS.map(e=>`<button class="emoji-opt${f.emoji===e?' sel':''}" onclick="selectEmoji('${e}',this)">${e}</button>`).join('')}</div>
      <input type="hidden" id="fp-emoji" value="${f.emoji}"/>
    </div>
    <div class="field"><label class="label">Nombre *</label><input class="input" id="fp-nombre" value="${f.nombre}" placeholder="Nombre del producto"/></div>
    <div class="form-grid">
      <div class="field"><label class="label">Precio (COP) *</label><input class="input" type="number" id="fp-precio" value="${f.precio}"/></div>
      <div class="field"><label class="label">Stock actual</label><input class="input" type="number" id="fp-stock" value="${f.stock}"/></div>
    </div>
    <div class="form-grid">
      <div class="field"><label class="label">Stock m√≠nimo alerta</label><input class="input" type="number" id="fp-stockmin" value="${f.stockMin||5}"/></div>
      <div class="field"><label class="label">Categor√≠a</label><input class="input" id="fp-cat" value="${f.categoria}"/></div>
    </div>
  </div>
  <div class="btn-row" style="margin-top:.875rem">
    <button class="btn btn-secondary" style="flex:1" onclick="closeProdModal()">Cancelar</button>
    <button class="btn btn-primary" style="flex:2" onclick="guardarProducto(${id||'null'})">Guardar</button>
  </div>`;
  document.getElementById('modal-prod').classList.add('open');
}
function selectEmoji(e,btn){document.getElementById('fp-emoji').value=e;document.querySelectorAll('.emoji-opt').forEach(b=>b.classList.remove('sel'));btn.classList.add('sel');}
function guardarProducto(id){
  const nombre=document.getElementById('fp-nombre').value.trim();
  const precio=Number(document.getElementById('fp-precio').value);
  const stock=Number(document.getElementById('fp-stock').value)||0;
  const stockMin=Number(document.getElementById('fp-stockmin').value)||5;
  const categoria=document.getElementById('fp-cat').value||'General';
  const emoji=document.getElementById('fp-emoji').value;
  if(!nombre||!precio)return alert('Nombre y precio son obligatorios');
  if(id){const i=productos.findIndex(p=>p.id===id);if(i>=0)productos[i]={...productos[i],nombre,precio,stock,stockMin,categoria,emoji};}
  else productos.push({id:genId(),nombre,precio,stock,stockMin,categoria,emoji});
  sp();closeProdModal();renderProductos();
}
function eliminarProducto(id){if(!confirm('¬øEliminar producto?'))return;productos=productos.filter(p=>p.id!==id);sp();renderProductos();}
function closeProdModal(e){if(!e||e.target===document.getElementById('modal-prod'))document.getElementById('modal-prod').classList.remove('open');}

function ajustarStock(id){
  const p=productos.find(x=>x.id===id);if(!p)return;
  document.getElementById('modal-prod-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">üì¶ Ajustar stock ‚Äì ${p.emoji} ${p.nombre}</div>
  <div class="form-stack">
    <div class="card2" style="text-align:center">
      <div class="text-xs text-muted">Stock actual</div>
      <div class="stat-val c-accent" style="font-size:2rem">${p.stock}</div>
      <div class="text-xs text-muted">m√≠n. alerta: ${p.stockMin||5}</div>
    </div>
    <div class="field"><label class="label">Movimiento</label>
      <select class="input" id="stk-tipo">
        <option value="entrada">‚ûï Entrada (compra/recepci√≥n)</option>
        <option value="salida">‚ûñ Salida (merma/ajuste)</option>
        <option value="ajuste">üìã Ajuste directo (fijar valor)</option>
      </select>
    </div>
    <div class="field"><label class="label">Cantidad / Nuevo valor</label><input class="input" type="number" id="stk-qty" value="0" min="0"/></div>
    <div class="field"><label class="label">Motivo</label><input class="input" id="stk-motivo" placeholder="Ej: Compra #123, Inventario f√≠sico..."/></div>
  </div>
  <div class="btn-row" style="margin-top:.875rem">
    <button class="btn btn-secondary" style="flex:1" onclick="closeProdModal()">Cancelar</button>
    <button class="btn btn-primary" style="flex:2" onclick="confirmarAjusteStock(${id})">‚úì Aplicar</button>
  </div>`;
  document.getElementById('modal-prod').classList.add('open');
}
function confirmarAjusteStock(id){
  const tipo=document.getElementById('stk-tipo').value;
  const qty=Number(document.getElementById('stk-qty').value)||0;
  const i=productos.findIndex(p=>p.id===id);
  if(i<0)return;
  if(tipo==='entrada')productos[i].stock+=qty;
  else if(tipo==='salida')productos[i].stock=Math.max(0,productos[i].stock-qty);
  else productos[i].stock=qty;
  sp();closeProdModal();renderProductos();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// AJUSTES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ajusteTab(t){
  ajusteTabActual=t;
  const map={neg:'negocio',fact:'factura',suc:'sucursal',usr:'usuarios',app:'app'};
  Object.entries(map).forEach(([k,v])=>{const el=document.getElementById('atab-'+k);if(el)el.className='tab'+(t===v?' active':'');});
  renderAjustes();
}
function renderAjustes(){
  const el=document.getElementById('ajuste-content');
  if(ajusteTabActual==='negocio'){
    el.innerHTML=`<div class="card"><div class="card-title">üè™ Datos de la empresa</div>
    <div class="form-stack">
      <div class="field"><label class="label">Nombre de la empresa *</label><input class="input" id="cfg-neg" value="${config.negocio}"/></div>
      <div class="form-grid">
        <div class="field"><label class="label">NIT</label><input class="input" id="cfg-nit" value="${config.nit||''}"/></div>
        <div class="field"><label class="label">Ciudad</label><input class="input" id="cfg-ciu" value="${config.ciudad}"/></div>
      </div>
      <div class="field"><label class="label">Direcci√≥n</label><input class="input" id="cfg-dir" value="${config.dir_empresa||''}"/></div>
      <div class="form-grid">
        <div class="field"><label class="label">Tel√©fono</label><input class="input" id="cfg-tel" value="${config.tel_empresa||''}"/></div>
        <div class="field"><label class="label">Email</label><input class="input" id="cfg-email" value="${config.email_empresa||''}"/></div>
      </div>
      <div class="field"><label class="label">WhatsApp (con c√≥digo pa√≠s)</label><input class="input" id="cfg-wa" value="${config.whatsapp}" placeholder="573001234567"/></div>
      <div class="form-grid">
        <div class="field"><label class="label">Stock m√≠nimo global</label><input class="input" type="number" id="cfg-stk" value="${config.stockMinGlobal||5}"/></div>
      </div>
      <div id="cfg-ok" style="display:none" class="alert a-success">‚úÖ Guardado</div>
      <button class="btn btn-primary btn-full" onclick="guardarConfig()">Guardar cambios</button>
    </div></div>
    <div class="card" style="margin-top:.6rem">
      <div class="card-title">üì± Per√≠odo gratuito</div>
      <div class="form-grid">
        <div class="field"><label class="label">D√≠as de prueba</label><input class="input" type="number" id="trial-dias" value="${trialData.dias}"/></div>
        <div class="field"><label class="label">Estado</label>
          <div class="input" style="display:flex;align-items:center;gap:.5rem">
            <label class="switch"><input type="checkbox" id="trial-activo" ${trialData.activo?'checked':''} onchange="toggleTrial(this.checked)"/><span class="slider"></span></label>
            <span class="text-sm">${trialData.activo?'Activo':'Inactivo'}</span>
          </div>
        </div>
      </div>
      <div class="text-xs text-muted" style="margin-top:.35rem">D√≠as restantes: <strong class="c-accent">${trialDiasRestantes()}</strong></div>
      <button class="btn btn-orange btn-full" style="margin-top:.6rem" onclick="resetTrial()">üîÑ Reiniciar per√≠odo de prueba</button>
    </div>
    <div class="card" style="margin-top:.6rem;border-color:rgba(255,80,80,.2)">
      <div class="card-title">üó∫Ô∏è Rutero del Excel</div>
      <div class="text-xs text-muted" style="margin-bottom:.6rem">Recarga las rutas originales del Excel para todos los vendedores. Los pedidos registrados <strong>no se borran</strong>.</div>
      <div class="text-xs" style="margin-bottom:.5rem">üìÖ Versi√≥n actual: <span class="mono c-accent">${DATA_VERSION}</span> ¬∑ ${rutas.length} rutas ¬∑ ${rutas.reduce((s,r)=>s+r.paradas.length,0)} paradas</div>
      <button class="btn btn-red btn-full" onclick="resetRutasDesdeExcel()">‚Ü∫ Recargar rutas del Excel</button>
    </div>`;
  } else if(ajusteTabActual==='factura'){
    el.innerHTML=`<div class="card"><div class="card-title">üìÑ Configuraci√≥n de factura</div>
    <div class="form-stack">
      <div class="form-grid">
        <div class="field"><label class="label">Prefijo</label><input class="input" id="cfg-pref" value="${config.prefijo_fact||'FAC'}"/></div>
        <div class="field"><label class="label">R√©gimen</label>
          <select class="input" id="cfg-reg">
            <option value="simplificado" ${config.regimen==='simplificado'?'selected':''}>Simplificado (sin IVA)</option>
            <option value="comun" ${config.regimen==='comun'?'selected':''}>R√©gimen com√∫n (IVA)</option>
          </select>
        </div>
      </div>
      <div class="field"><label class="label">IVA %</label><input class="input" type="number" id="cfg-iva" value="${config.iva||19}" min="0" max="100"/></div>
      <div class="field"><label class="label">Pie de p√°gina</label><textarea class="input" id="cfg-pie">${config.pie_factura||''}</textarea></div>
      <div id="cfg-ok2" style="display:none" class="alert a-success">‚úÖ Guardado</div>
      <button class="btn btn-primary btn-full" onclick="guardarConfigFact()">Guardar</button>
    </div></div>
    <div class="card" style="margin-top:.6rem"><div class="card-title">üßæ √öltimas facturas</div>
    ${facturas.length?facturas.slice(-8).reverse().map(f=>`<div class="order-item" style="cursor:pointer" onclick="mostrarFactura(facturas.find(x=>String(x.id)==='${f.id}'))">
      <div><div class="oi-name mono">${f.codigo}</div><div class="oi-detail">${f.cliente} ¬∑ ${new Date(f.timestamp).toLocaleDateString('es-CO')}</div></div>
      <div class="text-accent fw7 mono" style="font-size:.825rem">${fmt(f.total)}</div>
    </div>`).join(''):'<div class="text-xs text-muted">Sin facturas a√∫n</div>'}
    </div>`;
  } else if(ajusteTabActual==='sucursal'){
    el.innerHTML=`<button class="btn btn-primary btn-full" onclick="abrirModalSucursal(null)" style="margin-bottom:.6rem">+ Nueva sucursal</button>
    ${sucursales.map(s=>`<div class="suc-card">
      <div class="row-between">
        <div class="row"><div class="suc-dot" style="background:#${s.color}"></div><div><div class="fw7 text-sm">${s.nombre}</div><div class="text-xs text-muted">${s.ciudad||''}</div></div></div>
        <div class="btn-row">
          <button class="btn btn-secondary btn-xs" onclick="abrirModalSucursal(${s.id})">‚úèÔ∏è</button>
          ${sucursales.length>1?`<button class="btn btn-danger btn-xs" onclick="eliminarSucursal(${s.id})">üóëÔ∏è</button>`:''}
        </div>
      </div>
      <div class="text-xs text-muted" style="margin-top:.35rem">${pedidos.filter(p=>p.sucursalId===s.id).length} pedidos ¬∑ ${usuarios.filter(u=>u.sucursalId===s.id).length} vendedores</div>
    </div>`).join('')}`;
  } else if(ajusteTabActual==='app'){
    const isPWAInstalled=window.matchMedia('(display-mode: standalone)').matches;
    const isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent);
    const isAndroid=/android/i.test(navigator.userAgent);
    const isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isChrome=/chrome/i.test(navigator.userAgent)&&!/(edge|opr)/i.test(navigator.userAgent);
    let installSection='';
    if(isPWAInstalled){
      installSection=`<div style="text-align:center;padding:1.5rem .5rem">
        <div style="font-size:3rem;margin-bottom:.5rem">‚úÖ</div>
        <div class="fw7" style="font-size:1.1rem;margin-bottom:.3rem">¬°App instalada!</div>
        <div class="text-xs text-muted">PedidosPro ya est√° instalada como app en este dispositivo</div>
      </div>`;
    } else if(pwaPrompt){
      installSection=`<div style="text-align:center;padding:1rem .5rem 1.5rem">
        <div style="font-size:3.5rem;margin-bottom:.75rem">üì≤</div>
        <div class="fw7" style="font-size:1.1rem;margin-bottom:.4rem">Instala PedidosPro</div>
        <div class="text-xs text-muted" style="margin-bottom:1.2rem">√ösala sin internet, m√°s r√°pida y como app nativa en tu celular</div>
        <button class="btn btn-primary" style="width:100%;font-size:1rem;padding:.8rem;border-radius:.75rem;box-shadow:0 4px 20px rgba(0,212,255,.4)" onclick="installPWA()">
          üì≤ Instalar ahora ‚Äî Es gratis
        </button>
        <div class="text-xs text-muted" style="margin-top:.6rem">Sin tienda de apps ¬∑ Instala en segundos</div>
      </div>`;
    } else if(isIOS&&isSafari){
      installSection=`<div style="padding:.25rem 0 1rem">
        <div style="text-align:center;margin-bottom:.75rem"><div style="font-size:2.5rem">üçé</div><div class="fw7" style="margin-top:.3rem">En iPhone / iPad (Safari)</div></div>
        <div style="display:flex;flex-direction:column;gap:.45rem">
          <div style="display:flex;align-items:center;gap:.75rem;background:var(--card);border-radius:.75rem;padding:.7rem">
            <div style="width:2rem;height:2rem;border-radius:50%;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0">1</div>
            <div style="flex:1"><div class="fw7 text-sm">Toca el bot√≥n Compartir</div><div class="text-xs text-muted">El √≠cono ‚ñ°‚Üë en la barra de Safari</div></div>
            <div style="font-size:1.6rem;opacity:.8">‚ñ°‚Üë</div>
          </div>
          <div style="display:flex;align-items:center;gap:.75rem;background:var(--card);border-radius:.75rem;padding:.7rem">
            <div style="width:2rem;height:2rem;border-radius:50%;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0">2</div>
            <div style="flex:1"><div class="fw7 text-sm">Toca "A√±adir a pantalla de inicio"</div><div class="text-xs text-muted">Desliza hacia abajo en el men√∫</div></div>
            <div style="font-size:1.4rem;opacity:.8">Ôºã</div>
          </div>
          <div style="display:flex;align-items:center;gap:.75rem;background:var(--card);border-radius:.75rem;padding:.7rem">
            <div style="width:2rem;height:2rem;border-radius:50%;background:var(--green);color:#000;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0">3</div>
            <div style="flex:1"><div class="fw7 text-sm">Toca "Agregar"</div><div class="text-xs text-muted">La app aparecer√° como √≠cono en tu pantalla</div></div>
            <div style="font-size:1.4rem;opacity:.8">‚úì</div>
          </div>
        </div>
      </div>`;
    } else {
      installSection=`<div style="padding:.25rem 0 1rem">
        <div style="text-align:center;margin-bottom:.75rem"><div style="font-size:2.5rem">ü§ñ</div><div class="fw7" style="margin-top:.3rem">En Android (Chrome)</div></div>
        <div style="display:flex;flex-direction:column;gap:.45rem">
          <div style="display:flex;align-items:center;gap:.75rem;background:var(--card);border-radius:.75rem;padding:.7rem">
            <div style="width:2rem;height:2rem;border-radius:50%;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0">1</div>
            <div style="flex:1"><div class="fw7 text-sm">Toca el men√∫ ‚ãÆ de Chrome</div><div class="text-xs text-muted">Los tres puntos arriba a la derecha</div></div>
            <div style="font-size:1.4rem;opacity:.8">‚ãÆ</div>
          </div>
          <div style="display:flex;align-items:center;gap:.75rem;background:var(--card);border-radius:.75rem;padding:.7rem">
            <div style="width:2rem;height:2rem;border-radius:50%;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0">2</div>
            <div style="flex:1"><div class="fw7 text-sm">Toca "A√±adir a pantalla de inicio"</div><div class="text-xs text-muted">O "Instalar app" si aparece esa opci√≥n</div></div>
            <div style="font-size:1.4rem;opacity:.8">Ôºã</div>
          </div>
          <div style="display:flex;align-items:center;gap:.75rem;background:var(--card);border-radius:.75rem;padding:.7rem">
            <div style="width:2rem;height:2rem;border-radius:50%;background:var(--green);color:#000;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0">3</div>
            <div style="flex:1"><div class="fw7 text-sm">Confirma la instalaci√≥n</div><div class="text-xs text-muted">La app quedar√° en tu pantalla de inicio</div></div>
            <div style="font-size:1.4rem;opacity:.8">‚úì</div>
          </div>
        </div>
      </div>`;
    }
    el.innerHTML=`
    <div class="card" style="border-color:rgba(0,212,255,.35);margin-bottom:.6rem">
      <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.75rem">
        <div style="width:3rem;height:3rem;border-radius:.875rem;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;box-shadow:0 4px 12px rgba(0,212,255,.3)">üì¶</div>
        <div><div class="fw7" style="font-size:1rem">PedidosPro</div><div class="text-xs text-muted">Ventas y rutas ¬∑ Funciona sin internet</div></div>
      </div>
      ${installSection}
    </div>
    <div class="card" style="border-color:rgba(124,77,255,.25)">
      <div class="card-title" style="margin-bottom:.4rem">üîó Compartir con el equipo</div>
      <div class="text-xs text-muted" style="margin-bottom:.6rem">Env√≠a este enlace a tus vendedores para que instalen la app</div>
      <div style="background:var(--bg);border-radius:.6rem;padding:.55rem .75rem;font-size:.75rem;word-break:break-all;color:var(--muted);margin-bottom:.55rem;border:1px solid var(--border)">${location.href.split('?')[0]}</div>
      <div class="btn-row">
        <button class="btn btn-primary" style="flex:2" onclick="compartirApp()">üì§ Compartir</button>
        <button class="btn btn-secondary" style="flex:1" onclick="copiarUrlApp()">üìã Copiar</button>
      </div>
    </div>`;
  } else {
    el.innerHTML=`<button class="btn btn-primary btn-full" onclick="abrirModalUsuario()" style="margin-bottom:.6rem">+ Agregar usuario</button>
    ${usuarios.map(u=>`<div class="card2" style="margin-bottom:.55rem">
      <div class="row-between">
        <div class="row">
          <div class="u-avatar ${u.rol==='admin'?'u-av-admin':u.rol==='super'?'u-av-super':'u-av-vendor'}" style="width:34px;height:34px;font-size:.85rem">${u.nombre.charAt(0)}</div>
          <div><div class="fw7 text-sm">${u.nombre}</div>
          <div class="text-xs text-muted">${u.rol==='admin'?'üîë Admin':u.rol==='super'?'‚≠ê Super':'üíº Vendedor'} ¬∑ ${sucursales.find(s=>s.id===u.sucursalId)?.nombre||'Todas'}</div>
          <div class="text-xs" style="color:var(--accent);font-family:'JetBrains Mono',monospace">@${u.username||u.nombre.toLowerCase().split(' ')[0]}</div></div>
        </div>
        <button class="btn btn-sm ${u.activo?'btn-secondary':'btn-danger'}" onclick="toggleUser(${u.id})">${u.activo?'‚úì Activo':'‚úó Inact.'}</button>
      </div>
    </div>`).join('')}`;
  }
}
function guardarConfig(){
  config.negocio=document.getElementById('cfg-neg').value;
  config.whatsapp=document.getElementById('cfg-wa').value;
  config.ciudad=document.getElementById('cfg-ciu').value;
  config.nit=document.getElementById('cfg-nit').value;
  config.dir_empresa=document.getElementById('cfg-dir').value;
  config.tel_empresa=document.getElementById('cfg-tel').value;
  config.email_empresa=document.getElementById('cfg-email').value;
  config.stockMinGlobal=Number(document.getElementById('cfg-stk').value)||5;
  sp();
  document.getElementById('app-title').textContent=config.negocio;
  const ok=document.getElementById('cfg-ok');ok.style.display='block';setTimeout(()=>ok.style.display='none',2000);
}
function guardarConfigFact(){
  config.prefijo_fact=document.getElementById('cfg-pref').value;
  config.regimen=document.getElementById('cfg-reg').value;
  config.iva=Number(document.getElementById('cfg-iva').value);
  config.pie_factura=document.getElementById('cfg-pie').value;
  sp();const ok=document.getElementById('cfg-ok2');ok.style.display='block';setTimeout(()=>ok.style.display='none',2000);
}
function toggleTrial(v){trialData.activo=v;save(K.tr,trialData);}
function resetTrial(){
  const dias=Number(document.getElementById('trial-dias').value)||30;
  trialData={activo:true,inicio:Date.now(),dias};
  save(K.tr,trialData);
  alert(`‚úÖ Per√≠odo reiniciado: ${dias} d√≠as`);
  renderAjustes();
}
function resetRutasDesdeExcel(){
  if(!confirm('‚ö†Ô∏è Esto borrar√° TODAS las rutas guardadas y recargar√° las del Excel original.\n\nLos pedidos y visitas registradas NO se perder√°n.\n\n¬øContinuar?')) return;
  // Borrar rutas y clientes del localStorage
  if(_hasLS){
    localStorage.removeItem(K.rt);
    localStorage.removeItem(K.cl);
    localStorage.setItem('pp3_data_version','reset-'+Date.now()); // forzar reload en pr√≥xima apertura
  }
  delete _mem[K.rt];
  delete _mem[K.cl];
  alert('‚úÖ Rutas reseteadas. Recargando la app...');
  setTimeout(()=>location.reload(),500);
}
function toggleUser(id){const i=usuarios.findIndex(u=>u.id===id);if(i>=0)usuarios[i].activo=!usuarios[i].activo;sp();renderAjustes();}
function abrirModalUsuario(){
  document.getElementById('modal-user-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">üë§ Nuevo usuario</div>
  <div class="form-stack">
    <div class="field"><label class="label">Nombre completo</label><input class="input" id="nu-nombre" placeholder="Ej: Diana Rodr√≠guez"/></div>
    <div class="form-grid">
      <div class="field"><label class="label">Usuario (login)</label><input class="input" id="nu-username" placeholder="Ej: diana" autocapitalize="none"/></div>
      <div class="field"><label class="label">Contrase√±a</label><input class="input" type="text" id="nu-pass" placeholder="M√≠n 4 caracteres"/></div>
    </div>
    <div class="form-grid">
      <div class="field"><label class="label">Rol</label>
        <select class="input" id="nu-rol"><option value="vendedor">üíº Vendedor</option><option value="admin">üîë Admin</option></select>
      </div>
      <div class="field"><label class="label">Sucursal</label>
        <select class="input" id="nu-suc"><option value="">Todas</option>${sucursales.map(s=>`<option value="${s.id}">${s.nombre}</option>`).join('')}</select>
      </div>
    </div>
  </div>
  <div class="btn-row" style="margin-top:.875rem">
    <button class="btn btn-secondary" style="flex:1" onclick="closeUserModal()">Cancelar</button>
    <button class="btn btn-primary" style="flex:2" onclick="crearUsuario()">Crear</button>
  </div>`;
  document.getElementById('modal-user').classList.add('open');
}
function crearUsuario(){
  const nombre=document.getElementById('nu-nombre').value.trim();
  const username=(document.getElementById('nu-username').value||'').trim().toLowerCase();
  const pass=document.getElementById('nu-pass').value.trim();
  const rol=document.getElementById('nu-rol').value;
  const sucursalId=Number(document.getElementById('nu-suc').value)||null;
  if(!nombre)return alert('Nombre requerido');
  if(!username)return alert('Usuario de ingreso requerido');
  if(pass.length<4)return alert('Contrase√±a m√≠nimo 4 caracteres');
  if(usuarios.find(u=>u.username===username))return alert('Ese usuario ya existe');
  usuarios.push({id:genId(),nombre,username,rol,pin:pass,pass,activo:true,sucursalId});
  sp();closeUserModal();renderAjustes();
}
function closeUserModal(e){if(!e||e.target===document.getElementById('modal-user'))document.getElementById('modal-user').classList.remove('open');}

function abrirModalSucursal(id){
  const s=id?sucursales.find(x=>x.id===id):null;
  const f=s||{nombre:'',ciudad:'',color:'00d4ff'};
  document.getElementById('modal-user-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">${s?'‚úèÔ∏è Editar':'‚ûï Nueva'} sucursal</div>
  <div class="form-stack">
    <div class="field"><label class="label">Nombre *</label><input class="input" id="su-nombre" value="${f.nombre}"/></div>
    <div class="form-grid">
      <div class="field"><label class="label">Ciudad</label><input class="input" id="su-ciudad" value="${f.ciudad||''}"/></div>
      <div class="field"><label class="label">Color (hex)</label><input class="input" id="su-color" value="${f.color||'00d4ff'}" maxlength="6"/></div>
    </div>
  </div>
  <div class="btn-row" style="margin-top:.875rem">
    <button class="btn btn-secondary" style="flex:1" onclick="closeUserModal()">Cancelar</button>
    <button class="btn btn-primary" style="flex:2" onclick="guardarSucursal(${id||'null'})">Guardar</button>
  </div>`;
  document.getElementById('modal-user').classList.add('open');
}
function guardarSucursal(id){
  const nombre=document.getElementById('su-nombre').value.trim();
  if(!nombre)return alert('Nombre requerido');
  const data={nombre,ciudad:document.getElementById('su-ciudad').value,color:document.getElementById('su-color').value||'00d4ff',activo:true};
  if(id){const i=sucursales.findIndex(s=>s.id===id);if(i>=0)sucursales[i]={...sucursales[i],...data};}
  else sucursales.push({id:genId(),...data});
  sp();closeUserModal();renderAjustes();
}
function eliminarSucursal(id){if(!confirm('¬øEliminar sucursal?'))return;const i=sucursales.findIndex(s=>s.id===id);if(i>=0)sucursales.splice(i,1);sp();renderAjustes();}


// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EVIDENCIAS (fotos en paradas)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirEvidencia(rutaId, idx){
  const ruta=rutas.find(r=>String(r.id)===String(rutaId));
  if(!ruta)return;
  const p=ruta.paradas[idx];
  const fotos=p.fotos||[];
  document.getElementById('modal-alerta-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">üì∏ Evidencia ‚Äì ${p.clienteNombre}</div>
  <div style="font-size:.7rem;color:var(--muted);margin-bottom:.6rem">üìç Con hora y direcci√≥n ¬∑ üíæ Guardada en registros de la app</div>
  <div class="ev-grid">
    ${fotos.map((f,fi)=>{
      const src=f.img||f;
      const hora=f.hora||'';
      return `<div>
        <div style="position:relative">
          <img src="${src}" class="ev-thumb" style="border-radius:.5rem;width:100%;display:block"/>
          ${hora?`<div style="position:absolute;bottom:3px;left:3px;background:rgba(0,0,0,.8);color:#fff;font-size:.4rem;padding:2px 3px;border-radius:2px;line-height:1.5">${hora}${f.gps?'<br>üìç'+f.gps:''}</div>`:''}
        </div>
        <div style="display:flex;gap:3px;margin-top:4px">
          <button onclick="guardarFotoMovil('ev_${rutaId}_${idx}_${fi}','${p.clienteNombre.replace(/[^a-zA-Z0-9]/g,'_')}_${fi+1}')" id="ev_${rutaId}_${idx}_${fi}" data-src="${src}"
             style="flex:1;background:rgba(0,230,118,.15);border:1px solid rgba(0,230,118,.3);border-radius:.4rem;padding:.3rem;text-align:center;font-size:.68rem;color:var(--green);cursor:pointer;font-weight:600">
            üíæ Guardar
          </button>
          <button onclick="borrarFoto('${rutaId}',${idx},${fi})" 
            style="background:rgba(255,61,87,.12);border:1px solid rgba(255,61,87,.25);border-radius:.4rem;padding:.3rem .5rem;color:var(--red);cursor:pointer;font-size:.68rem">
            üóëÔ∏è
          </button>
        </div>
      </div>`;
    }).join('')}
    ${fotos.length<6?`<div class="ev-upload" onclick="abrirCamara('${rutaId}',${idx})" style="cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:90px">
      <div style="font-size:1.8rem">üì∑</div>
      <div style="font-size:.65rem;color:var(--muted);margin-top:.3rem">Tomar foto</div>
    </div>`:``}
  </div>
  <button class="btn btn-secondary btn-full" style="margin-top:.875rem" onclick="closeAlertaModal()">Cerrar</button>`;
  document.getElementById('modal-alerta').classList.add('open');
}

function guardarFotoMovil(btnId, nombre){
  const btn=document.getElementById(btnId);
  if(!btn)return;
  const src=btn.getAttribute('data-src');
  if(!src)return;
  try{
    // M√©todo 1: link con download (funciona en Chrome escritorio)
    const a=document.createElement('a');
    a.href=src;
    a.download=`evidencia_${nombre}.jpg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    // Feedback visual
    const orig=btn.innerHTML;
    btn.innerHTML='‚úÖ Guardado';
    btn.style.background='rgba(0,230,118,.3)';
    setTimeout(()=>{btn.innerHTML=orig;btn.style.background='rgba(0,230,118,.15)';},2000);
  }catch(e){
    // M√©todo 2: abrir imagen en nueva pesta√±a para guardar manualmente
    const w=window.open();
    if(w){
      w.document.write(`<html><body style="margin:0;background:#000"><img src="${src}" style="max-width:100%;height:auto"/><br><p style="color:#fff;text-align:center;font-family:sans-serif">Mant√©n presionada la imagen ‚Üí Guardar imagen</p></body></html>`);
    } else {
      mostrarSyncToast('Mant√©n presionada la foto ‚Üí Guardar imagen');
    }
  }
}

// ‚îÄ‚îÄ C√ÅMARA DIRECTA (sin guardar en galer√≠a) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _camaraRutaId=null, _camaraIdx=null, _camaraStream=null;

async function abrirCamara(rutaId, idx){
  _camaraRutaId=rutaId; _camaraIdx=idx;
  // Crear modal de c√°mara si no existe
  let modal=document.getElementById('modal-camara');
  if(!modal){
    modal=document.createElement('div');
    modal.id='modal-camara';
    modal.style.cssText='display:none;position:fixed;inset:0;background:#000;z-index:999;flex-direction:column;align-items:center;justify-content:center';
    modal.innerHTML=`
      <video id="cam-video" autoplay playsinline style="width:100%;max-height:70vh;object-fit:cover"></video>
      <div style="display:flex;gap:1rem;padding:1.2rem;background:#000;width:100%;justify-content:center;align-items:center">
        <button onclick="cerrarCamara()" style="background:rgba(255,61,87,.2);border:1px solid rgba(255,61,87,.4);border-radius:50%;width:48px;height:48px;color:#ff3d57;font-size:1.2rem;cursor:pointer">‚úï</button>
        <button onclick="capturarFoto()" style="background:var(--accent);border:none;border-radius:50%;width:68px;height:68px;color:#000;font-size:1.8rem;cursor:pointer;font-weight:900">üì∏</button>
        <button onclick="girarCamara()" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:50%;width:48px;height:48px;color:#fff;font-size:1.2rem;cursor:pointer">üîÑ</button>
      </div>`;
    document.body.appendChild(modal);
  }
  modal.style.display='flex';
  await _iniciarStream('environment');
}

let _facingMode='environment';
async function _iniciarStream(facing){
  _facingMode=facing;
  if(_camaraStream){_camaraStream.getTracks().forEach(t=>t.stop());}
  try{
    _camaraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing,width:{ideal:1920},height:{ideal:1080}},audio:false});
    document.getElementById('cam-video').srcObject=_camaraStream;
  }catch(e){
    mostrarSyncToast('‚ö†Ô∏è No se pudo acceder a la c√°mara');
    cerrarCamara();
  }
}

function girarCamara(){_iniciarStream(_facingMode==='environment'?'user':'environment');}

function cerrarCamara(){
  if(_camaraStream){_camaraStream.getTracks().forEach(t=>t.stop());_camaraStream=null;}
  const m=document.getElementById('modal-camara');
  if(m)m.style.display='none';
}

async function capturarFoto(){
  const video=document.getElementById('cam-video');
  if(!video||!_camaraStream)return;
  // Capturar frame en canvas
  const canvas=document.createElement('canvas');
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0);
  cerrarCamara();
  // Hora
  const ahora=new Date();
  const horaStr=ahora.toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric'})+' '+ahora.toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  // GPS + geocodificaci√≥n inversa
  let gpsStr='üìç GPS no disponible';
  let gpsRaw=null;
  try{
    const pos=await getGPS();
    gpsRaw={lat:pos.lat,lng:pos.lng};
    // Intentar obtener direcci√≥n legible (Nominatim - gratuito)
    try{
      const resp=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.lat}&lon=${pos.lng}&accept-language=es`,{headers:{'User-Agent':'PedidosPro/1.0'}});
      if(resp.ok){
        const geo=await resp.json();
        const a=geo.address||{};
        const calle=a.road||a.pedestrian||a.street||'';
        const numero=a.house_number||'';
        const barrio=a.suburb||a.neighbourhood||a.quarter||'';
        const ciudad=a.city||a.town||a.municipality||a.county||'';
        const partes=[calle+(numero?' '+numero:''), barrio, ciudad].filter(Boolean);
        gpsStr='üìç '+(partes.join(', ')||`${pos.lat.toFixed(4)},${pos.lng.toFixed(4)}`);
      }
    }catch(ge){
      gpsStr=`üìç ${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
    }
  }catch(e){}
  // Dibujar marca de agua
  const fontSize=Math.max(canvas.width*0.025,18);
  ctx.font=`bold ${fontSize}px Arial`;
  // Medir texto (puede ser largo, ajustar)
  const linea1=horaStr;
  const linea2=gpsStr;
  const linea3=session?.nombre||'';
  const maxChars=60;
  const l2=linea2.length>maxChars?linea2.substring(0,maxChars)+'‚Ä¶':linea2;
  const w1=ctx.measureText(linea1).width;
  const w2=ctx.measureText(l2).width;
  const w3=ctx.measureText(linea3).width;
  const maxW=Math.min(Math.max(w1,w2,w3)+20, canvas.width-20);
  const boxH=fontSize*3.8+10;
  const x=10, y=canvas.height-boxH-10;
  ctx.fillStyle='rgba(0,0,0,0.70)';
  ctx.beginPath();
  ctx.roundRect(x,y,maxW,boxH,6);
  ctx.fill();
  ctx.fillStyle='#fff';
  ctx.fillText(linea1,x+10,y+fontSize+4);
  ctx.fillStyle='#00e676';
  ctx.fillText(l2,x+10,y+fontSize*2.4+4);
  ctx.fillStyle='#00d4ff';
  ctx.fillText(linea3,x+10,y+fontSize*3.5+4);
  const dataUrl=canvas.toDataURL('image/jpeg',0.82);
  const ri=rutas.findIndex(r=>String(r.id)===String(_camaraRutaId)); if(ri<0)return;
  if(!rutas[ri].paradas[_camaraIdx].fotos)rutas[ri].paradas[_camaraIdx].fotos=[];
  rutas[ri].paradas[_camaraIdx].fotos.push({img:dataUrl,hora:horaStr,gps:gpsStr,gpsRaw,vendedor:session?.nombre});
  sp(); abrirEvidencia(_camaraRutaId,_camaraIdx);
  mostrarSyncToast('‚úÖ Foto guardada en los registros');
}
function borrarFoto(rutaId,idx,fi){
  const ri=rutas.findIndex(r=>String(r.id)===String(rutaId));if(ri<0)return;
  rutas[ri].paradas[idx].fotos.splice(fi,1);sp();abrirEvidencia(rutaId,idx);
}
function closeAlertaModal(e){if(!e||e.target===document.getElementById('modal-alerta'))document.getElementById('modal-alerta').classList.remove('open');}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ALERTAS PUSH ‚Äî tiempo real v√≠a BroadcastChannel + window.storage compartido
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const K_ALERTS='pp3_alerts';
let alertas=load(K_ALERTS,[]);
function saveAlertas(){save(K_ALERTS,alertas);bcAlertas.postMessage({tipo:'alerta_nueva'});}

// BroadcastChannel para comunicaci√≥n entre pesta√±as/dispositivos en la misma sesi√≥n
const bcAlertas=(()=>{try{return new BroadcastChannel('pp3_channel');}catch{return {postMessage:()=>{},addEventListener:()=>{},onmessage:null};}})();
bcAlertas.onmessage=(e)=>{
  if(e.data.tipo==='alerta_nueva'||e.data.tipo==='datos_actualizados'){
    // Recargar alertas y datos desde storage
    alertas=load(K_ALERTS,[]);
    updateAlertaBadge();
    // Si hay datos nuevos, refrescar pantalla actual
    if(e.data.tipo==='datos_actualizados'){
      pedidos=load(K.o,[]);rutas=load(K.rt,[]);clientes=load(K.cl,[]);
      if(currentTab==='inicio')renderInicio();
      else if(currentTab==='rutas')renderRutas();
      else if(currentTab==='pedidos')renderPedidos();
    }
  }
};

// Polling cada 8s para sincronizar entre dispositivos distintos (simula tiempo real)
// _syncInterval ya declarado arriba
let _lastSyncTs=0;

// Firebase reemplaza syncFromCloud ‚Äî el listener onSnapshot maneja todo en tiempo real
async function syncFromCloud(){
  // Compatibilidad: ahora usamos Firebase listener, pero mantenemos esta funci√≥n
  // para no romper referencias existentes
  return false;
}

function startSync(){
  // Iniciar listener de Firebase en tiempo real
  iniciarListenerFirebase();
  // Tambi√©n sincronizar cuando la app vuelve a estar activa
  document.removeEventListener('visibilitychange',_onVisChange);
  document.addEventListener('visibilitychange',_onVisChange);
}
function _onVisChange(){
  if(!document.hidden&&session){
    updateAlertaBadge();
  }
}
function stopSync(){
  // Detener listeners de Firebase
  _firestoreListeners.forEach(u=>u());
  _firestoreListeners=[];
}

function enviarAlerta(destinatario, mensaje, tipo='info'){
  const alerta={id:genId(),para:destinatario,de:session.nombre,mensaje,tipo,ts:Date.now(),leida:false};
  alertas.push(alerta);saveAlertas();
  updateAlertaBadge();
  // Intentar notificaci√≥n del sistema si est√° disponible
  if(Notification&&Notification.permission==='granted'&&destinatario!==session.nombre){
    try{new Notification(`üì£ PedidosPro ‚Äì Mensaje de ${session.nombre}`,{body:mensaje,icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="10" fill="%23080b10"/><text y="48" x="8" font-size="48">üöÄ</text></svg>'});}catch(e){}
  }
}

function updateAlertaBadge(){
  // Recargar alertas desde storage para ver las de otros dispositivos
  try{alertas=load(K_ALERTS,[]);}catch(e){}
  const misAlertas=alertas.filter(a=>(a.para===session?.nombre||a.para==='todos')&&!a.leida);
  const n=misAlertas.length;
  const badge=document.getElementById('ia-badge');
  if(badge){badge.style.display=n?'flex':'none';badge.textContent=n||'';}
  const badge2=document.getElementById('ia-badge-hdr');
  if(badge2){badge2.style.display=n?'block':'none';}
}

function abrirModalAlertaAdmin(){
  const vendedores=['todos',...usuarios.filter(u=>u.rol==='vendedor'&&u.activo).map(u=>u.nombre)];
  const plantillas=[
    {label:'üéØ Cumple meta',msg:'¬°Excelente trabajo! Est√°s cumpliendo la meta del d√≠a. Sigue as√≠ üí™'},
    {label:'üìã Llenar pedidos',msg:'Recuerda registrar todos los pedidos en la app antes de las 6pm.'},
    {label:'‚ö†Ô∏è Precio especial',msg:'Hoy hay precio especial en algunos productos. Consulta la lista antes de salir.'},
    {label:'üöÄ Motivaci√≥n',msg:'¬°Vamos equipo! Hoy es un gran d√≠a para cerrar ventas. Conf√≠o en ustedes.'},
    {label:'‚õî Urgente',msg:''},
  ];
  document.getElementById('modal-alerta-content').innerHTML=`<div class="modal-handle"></div>
  <div class="modal-title">üì£ Enviar mensaje al equipo</div>
  <div class="form-stack">
    <div class="field"><label class="label">Destinatario</label>
      <select class="input" id="al-dest">
        ${vendedores.map(v=>`<option value="${v}">${v==='todos'?'üì¢ Todos los vendedores':v}</option>`).join('')}
      </select>
    </div>
    <div class="field"><label class="label">Tipo de mensaje</label>
      <select class="input" id="al-tipo">
        <option value="info">‚ÑπÔ∏è Informaci√≥n</option>
        <option value="warn">‚ö†Ô∏è Alerta</option>
        <option value="success">‚úÖ Motivaci√≥n / √âxito</option>
        <option value="error">üö® Urgente</option>
      </select>
    </div>
    <div class="field"><label class="label">Plantillas r√°pidas</label>
      <div class="chips" style="flex-wrap:wrap;gap:.3rem">
        ${plantillas.map(p=>`<button class="chip" onclick="document.getElementById('al-msg').value='${p.msg.replace(/'/g,"\\'")}'">${p.label}</button>`).join('')}
      </div>
    </div>
    <div class="field"><label class="label">Mensaje *</label>
      <textarea class="input" id="al-msg" placeholder="Escribe el mensaje para el equipo..." style="min-height:80px"></textarea>
    </div>
    <div class="alert a-info" style="font-size:.73rem">üí° El vendedor ver√° el mensaje cuando abra la app o el asistente IA. Tambi√©n aparecer√° en su pantalla de inicio.</div>
  </div>
  <div class="btn-row" style="margin-top:.875rem">
    <button class="btn btn-secondary" style="flex:1" onclick="closeAlertaModal()">Cancelar</button>
    <button class="btn btn-primary" style="flex:2" onclick="confirmarEnvioAlerta()">üì£ Enviar ahora</button>
  </div>
  <div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--border)">
    <div class="text-xs text-muted fw7" style="margin-bottom:.4rem">MENSAJES ENVIADOS</div>
    ${alertas.filter(a=>a.de===session.nombre).slice(-5).reverse().map(a=>`
      <div style="display:flex;align-items:flex-start;gap:.4rem;margin-bottom:.35rem;font-size:.72rem">
        <span>${a.tipo==='error'?'üö®':a.tipo==='warn'?'‚ö†Ô∏è':a.tipo==='success'?'‚úÖ':'‚ÑπÔ∏è'}</span>
        <div style="flex:1"><div style="color:var(--muted2)">${a.para==='todos'?'Todos':a.para} ¬∑ ${new Date(a.ts).toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'})}</div>
        <div>${a.mensaje}</div></div>
        <span style="color:${a.leida?'var(--green)':'var(--muted)'};font-size:.6rem">${a.leida?'‚úì Le√≠do':'Pendiente'}</span>
      </div>`).join('')||'<div class="text-xs text-muted">Sin mensajes enviados</div>'}
  </div>`;
  document.getElementById('modal-alerta').classList.add('open');
}
function confirmarEnvioAlerta(){
  const dest=document.getElementById('al-dest').value;
  const tipo=document.getElementById('al-tipo').value;
  const msg=document.getElementById('al-msg').value.trim();
  if(!msg)return alert('Escribe un mensaje');
  enviarAlerta(dest,msg,tipo);
  closeAlertaModal();
  // Show in IA chat too
  iaAddMsg(`üì£ Alerta enviada a <strong>${dest==='todos'?'todos los vendedores':dest}</strong>: "${msg}"`, 'bot alert-ok');
}

function verMisAlertas(){
  const misAlertas=alertas.filter(a=>(a.para===session?.nombre||a.para==='todos'));
  if(!misAlertas.length){iaAddMsg('No tienes alertas por ahora üëç','bot');return;}
  misAlertas.forEach(a=>{
    const cls=a.tipo==='error'?'alert-msg':a.tipo==='warn'?'alert-msg':a.tipo==='success'?'alert-ok':'bot';
    iaAddMsg(`<strong>${a.de}</strong> ¬∑ ${new Date(a.ts).toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'})}<br>${a.tipo==='error'?'üö®':a.tipo==='warn'?'‚ö†Ô∏è':a.tipo==='success'?'‚úÖ':'‚ÑπÔ∏è'} ${a.mensaje}`, cls);
    a.leida=true;
  });
  saveAlertas();updateAlertaBadge();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ASISTENTE IA (Claude API)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let iaOpen=false, iaHistory=[];

function renderIaQuickBtns(){
  const isAdmin=session?.rol==='admin'||session?.rol==='super';
  if(isAdmin){
    document.getElementById('ia-quick').innerHTML=`
      <button class="ia-quick-btn" onclick="iaQuery('¬øC√≥mo van las ventas de hoy?')">üìä Ventas hoy</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øQu√© vendedor lleva m√°s visitas hoy?')">üèÜ Ranking</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øQu√© productos tienen stock bajo o sin stock?')">üì¶ Stock</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øQu√© rutas est√°n en curso ahora mismo?')">üó∫Ô∏è Rutas activas</button>
      <button class="ia-quick-btn" onclick="iaQuery('Dame un resumen completo del negocio hoy')">üìã Resumen</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øQu√© mejoras le har√≠as a la app?')">‚ú® Mejoras</button>
    `;
  } else {
    document.getElementById('ia-quick').innerHTML=`
      <button class="ia-quick-btn" onclick="iaQuery('¬øCu√°ntas visitas me faltan hoy?')">üìç Mis visitas</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øCu√°ntos pedidos he tomado hoy?')">üõí Mis pedidos</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øQu√© productos puedo ofrecer hoy?')">üì¶ Productos</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øC√≥mo registro un pedido?')">‚ùì Ayuda pedido</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øC√≥mo marco una visita como realizada?')">‚úÖ Marcar visita</button>
      <button class="ia-quick-btn" onclick="iaQuery('¬øHay alguna alerta o novedad para m√≠ hoy?')">üîî Alertas</button>
    `;
  }
}

function toggleIA(){
  iaOpen=!iaOpen;
  document.getElementById('ia-panel').classList.toggle('open',iaOpen);
  const isAdmin=session?.rol==='admin'||session?.rol==='super';
  const sub=document.getElementById('ia-panel-sub');
  if(sub)sub.textContent=isAdmin?'Admin ¬∑ Datos, alertas y desarrollo':'Vendedor ¬∑ Tu asistente de ventas';
  if(iaOpen&&iaHistory.length===0){
    renderIaQuickBtns();
    iaWelcome();
  }
}

function iaWelcome(){
  const isAdmin=session?.rol==='admin'||session?.rol==='super';
  const hoy=new Date().toDateString();
  const pedHoy=pedidos.filter(p=>new Date(p.timestamp).toDateString()===hoy);
  const misPed=isAdmin?pedHoy:pedHoy.filter(p=>p.vendedor===session?.nombre);
  const rutaActiva=rutas.find(r=>r.estado==='en_curso'&&(isAdmin||r.vendedor===session?.nombre));
  const pendientes=rutaActiva?rutaActiva.paradas.filter(p=>!p.visitado&&!p.omitido).length:0;
  const stockCrit=productos.filter(p=>p.stock===0);
  if(isAdmin){
    const ventasHoy=pedHoy.filter(p=>['completado','facturado'].includes(p.estado)).reduce((s,p)=>s+p.total,0);
    iaAddMsg(`ü§ñ <strong>Hola ${session?.nombre}!</strong> Soy tu asistente IA.<br><br>
üìä <strong>Hoy:</strong> ${pedHoy.length} pedidos ¬∑ $${Math.round(ventasHoy).toLocaleString('es-CO')} en ventas<br>
üë• <strong>Clientes activos:</strong> ${clientes.filter(c=>c.activo).length} ¬∑ <strong>Rutas activas:</strong> ${rutas.filter(r=>r.estado==='en_curso').length}<br>
${stockCrit.length?`‚ö†Ô∏è <strong>Sin stock:</strong> ${stockCrit.map(p=>p.nombre).join(', ')}<br>`:''}
<br>Puedo darte <strong>informes, alertas, an√°lisis de vendedores</strong> y ayudarte a mejorar la app. ¬øQu√© necesitas?`,'dev-msg');
  } else {
    iaAddMsg(`ü§ñ <strong>Hola ${session?.nombre}!</strong> Soy tu asistente de ventas.<br><br>
${rutaActiva?`üó∫Ô∏è <strong>Ruta activa:</strong> "${rutaActiva.nombre}" ¬∑ ${pendientes} paradas pendientes<br>`:'üìç No tienes ruta activa hoy<br>'}
üõí <strong>Mis pedidos hoy:</strong> ${misPed.length}<br>
üì¶ <strong>Productos disponibles:</strong> ${productos.filter(p=>p.stock>0).length}<br><br>
Puedo ayudarte con <strong>rutas, pedidos, clientes y cualquier duda</strong>. ¬øEn qu√© te ayudo?`,'bot');
  }
}

function iaAddMsg(html, cls='bot'){
  const el=document.getElementById('ia-messages');
  const div=document.createElement('div');
  div.className='ia-msg '+cls;
  div.innerHTML=html;
  el.appendChild(div);
  el.scrollTop=el.scrollHeight;
}

function iaSend(){
  const inp=document.getElementById('ia-input');
  const txt=inp.value.trim();if(!txt)return;
  inp.value='';inp.style.height='auto';
  iaQuery(txt);
}

function iaGetContexto(){
  const hoy=new Date().toDateString();
  const pedHoy=pedidos.filter(p=>new Date(p.timestamp).toDateString()===hoy);
  const ventasHoy=pedHoy.filter(p=>['completado','facturado'].includes(p.estado)).reduce((s,p)=>s+p.total,0);
  const isAdmin=session?.rol==='admin'||session?.rol==='super';
  const misRutas=rutas.filter(r=>isAdmin||r.vendedor===session?.nombre);
  const rutaActiva=rutas.find(r=>r.estado==='en_curso'&&r.vendedor===session?.nombre);
  const totalVisitas=misRutas.reduce((s,r)=>s+r.paradas.length,0);
  const visitasDone=misRutas.reduce((s,r)=>s+r.paradas.filter(p=>p.visitado).length,0);
  const visitasPend=misRutas.reduce((s,r)=>s+r.paradas.filter(p=>!p.visitado&&!p.omitido).length,0);
  const stockCrit=productos.filter(p=>p.stock===0).map(p=>p.nombre);
  const stockBajo2=productos.filter(p=>p.stock>0&&p.stock<=(p.stockMin||5)).map(p=>p.nombre);
  const vendStats=usuarios.filter(u=>u.rol==='vendedor').map(u=>{
    const vPeds=pedidos.filter(p=>p.vendedor===u.nombre&&['completado','facturado'].includes(p.estado));
    const rutasV=rutas.filter(r=>r.vendedor===u.nombre);
    const visitV=rutasV.reduce((s,r)=>s+r.paradas.filter(p=>p.visitado).length,0);
    const pendV=rutasV.reduce((s,r)=>s+r.paradas.filter(p=>!p.visitado&&!p.omitido).length,0);
    return {nombre:u.nombre,pedidos:vPeds.length,ventas:vPeds.reduce((s,p)=>s+p.total,0),visitadas:visitV,pendientes:pendV};
  });

  return `Eres Claude, asistente integrado en PedidosPro. Usuario: ${session?.nombre} (${session?.rol}). Empresa: ${config?.negocio||'PedidosPro'}.
Fecha: ${new Date().toLocaleString('es-CO')}. Responde en espa√±ol, conciso, con emojis.

DATOS EN TIEMPO REAL:
- Pedidos hoy: ${pedHoy.length} ¬∑ Ventas hoy: $${Math.round(ventasHoy).toLocaleString('es-CO')}
- Total pedidos: ${pedidos.length} ¬∑ Clientes activos: ${clientes.filter(c=>c.activo).length}
- Productos: ${productos.length} (sin stock: ${stockCrit.length}, stock bajo: ${stockBajo2.length})
${stockCrit.length?'- SIN STOCK: '+stockCrit.join(', '):''}
${stockBajo2.length?'- STOCK BAJO: '+stockBajo2.join(', '):''}
- Total paradas rutas: ${totalVisitas} ¬∑ Visitadas: ${visitasDone} ¬∑ Pendientes: ${visitasPend}
${rutaActiva?`- RUTA ACTIVA "${rutaActiva.nombre}": ${rutaActiva.paradas.filter(p=>p.visitado).length}/${rutaActiva.paradas.length} visitas`:''}
- Vendedores: ${vendStats.map(v=>`${v.nombre}(${v.pedidos} ped, $${Math.round(v.ventas/1000)}k, ${v.visitadas} vis)`).join(' | ')}
${isAdmin?'- ROL: ADMIN (acceso total)':'- ROL: VENDEDOR (solo sus datos)'}`;
}

function iaGetContextoVendedor(){
  const hoy=new Date().toDateString();
  const pedHoy=pedidos.filter(p=>new Date(p.timestamp).toDateString()===hoy&&p.vendedor===session?.nombre);
  const ventasHoy=pedHoy.filter(p=>['completado','facturado'].includes(p.estado)).reduce((s,p)=>s+p.total,0);
  const misRutas=rutas.filter(r=>r.vendedor===session?.nombre);
  const rutaActiva=misRutas.find(r=>r.estado==='en_curso');
  const visitadas=misRutas.reduce((s,r)=>s+r.paradas.filter(p=>p.visitado).length,0);
  const pendientes=misRutas.reduce((s,r)=>s+r.paradas.filter(p=>!p.visitado&&!p.omitido).length,0);
  const misClientes=clientes.filter(c=>c.vendedor===session?.nombre&&c.activo);
  const prodsDisp=productos.filter(p=>p.stock>0);
  const prodsAgot=productos.filter(p=>p.stock===0);
  return `Eres un asistente amable y √∫til integrado en PedidosPro para el vendedor ${session?.nombre}.
Fecha: ${new Date().toLocaleString('es-CO')}. Responde en espa√±ol, con emojis, de forma breve y pr√°ctica.
Tu objetivo: ayudar al vendedor en su d√≠a de trabajo, resolver dudas y darle informaci√≥n de sus datos.

DATOS DEL VENDEDOR HOY:
- Pedidos hoy: ${pedHoy.length} ¬∑ Ventas hoy: $${Math.round(ventasHoy).toLocaleString('es-CO')}
- Visitas realizadas: ${visitadas} ¬∑ Pendientes: ${pendientes}
${rutaActiva?`- Ruta activa: "${rutaActiva.nombre}" con ${rutaActiva.paradas.length} paradas`:'- Sin ruta activa hoy'}
- Mis clientes: ${misClientes.length}
- Productos disponibles: ${prodsDisp.length}
${prodsAgot.length?`- Productos sin stock (no ofrecer): ${prodsAgot.map(p=>p.nombre).join(', ')}`:''}

C√ìMO USAR LA APP (para explicarle al vendedor si pregunta):
- Tomar pedido: tab "Pedido" ‚Üí seleccionar cliente ‚Üí agregar productos ‚Üí confirmar
- Ver ruta: tab "Rutas" ‚Üí abrir ruta ‚Üí tocar parada ‚Üí Navegar/Marcar visitado
- Marcar visita: en el mapa de ruta ‚Üí bot√≥n "Marcar visitado"
- Ver clientes: tab "Clientes"
- Tomar evidencia: en el mapa de ruta ‚Üí bot√≥n "Evidencia"

Si el vendedor pregunta algo que no sabes o est√° fuera de tus datos, dile que consulte con el administrador.`;
}

function iaGetContextoDev(){
  return `Eres Claude, asistente desarrollador integrado en PedidosPro, una PWA de ventas y rutas en un √∫nico archivo HTML (~3.100 l√≠neas).

STACK T√âCNICO:
- HTML/CSS/JS vanilla, sin frameworks
- localStorage para persistencia
- Leaflet + OpenStreetMap para mapas
- SheetJS para importar Excel
- Claude API (anthropic) para este chat
- BroadcastChannel + polling 8s para sync entre tabs
- Dise√±o dark theme con variables CSS

ESTRUCTURA DE DATOS (localStorage):
- clientes: [{id, nombre, telefono, email, direccion, vendedor, activo}]
- rutas: [{id, nombre, vendedor, dia, paradas:[{clienteNombre, direccion, visitado, omitido}], estado, timestamp}]
- pedidos: [{id, numero, cliente, vendedor, items, total, estado, timestamp}]
- productos: [{id, nombre, precio, stock, categoria}]
- alertas: [{id, para, de, mensaje, tipo, ts, leida}]
- usuarios: [{id, nombre, username, rol, pass}]

USUARIOS ACTUALES: Admin (admin/admin1234), Diana (diana/diana111), Cindy (cindy/cindy222), Wilson (wilson/wilson333)

FUNCIONES CLAVE: sp() guarda y broadcastea, load(key,def) carga, genId() genera ID, fmt(n) formatea moneda, goTab(id) navega, renderInicio/renderRutas/renderPedidos/renderClientes renderizan tabs.

CUANDO PROPONGAS C√ìDIGO:
1. S√© espec√≠fico: indica qu√© funci√≥n modificar o qu√© c√≥digo agregar
2. Usa el formato exacto del c√≥digo existente
3. Prop√≥n un cambio a la vez, pr√°ctico e implementable
4. Si el cambio es grande, div√≠delo en pasos

Responde en espa√±ol, con emojis. M√°ximo 6 l√≠neas salvo que pidan c√≥digo completo.
Usuario actual: ${session?.nombre} (${session?.rol}).`;
}

async function iaQuery(pregunta){
  iaAddMsg(pregunta,'user');
  iaHistory.push({role:'user',content:pregunta});

  // Show animated thinking indicator
  const loadDiv=document.createElement('div');
  loadDiv.className='ia-msg dev-msg';
  loadDiv.innerHTML='<div class="ia-thinking"><span></span><span></span><span></span></div>';
  document.getElementById('ia-messages').appendChild(loadDiv);
  document.getElementById('ia-messages').scrollTop=999999;

  const sysPrompt = (session?.rol==='admin'||session?.rol==='super') ? iaGetContextoDev() : iaGetContextoVendedor();

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1500,
        system:sysPrompt,
        messages:iaHistory.slice(-10)
      })
    });
    const data=await resp.json();
    loadDiv.remove();
    const txt=data.content?.[0]?.text||'No pude obtener respuesta.';
    // Format code blocks
    const formatted=txt
      .replace(/```[\w]*\n?([\s\S]*?)```/g,'<div class="ia-code-block">$1</div>')
      .replace(/\n/g,'<br>');
    iaAddMsg(formatted,'dev-msg');
    iaHistory.push({role:'assistant',content:txt});
  }catch(e){
    loadDiv.remove();
    iaAddMsg(iaRespuestaLocal(pregunta),'bot');
  }
}

// Fallback local cuando no hay red/API
function iaRespuestaLocal(q){
  const ql=q.toLowerCase();
  const hoy=new Date().toDateString();
  const pedHoy=pedidos.filter(p=>new Date(p.timestamp).toDateString()===hoy);
  const isAdmin=session?.rol==='admin'||session?.rol==='super';
  const misRutas=rutas.filter(r=>isAdmin||r.vendedor===session?.nombre);
  const pendientes=misRutas.reduce((s,r)=>s+r.paradas.filter(p=>!p.visitado&&!p.omitido).length,0);
  const visitadas=misRutas.reduce((s,r)=>s+r.paradas.filter(p=>p.visitado).length,0);
  if(ql.includes('visit')&&(ql.includes('hoy')||ql.includes('falt')||ql.includes('cuant'))){
    const rutaH=rutas.find(r=>r.estado==='en_curso'&&r.vendedor===session?.nombre);
    if(rutaH){const pend=rutaH.paradas.filter(p=>!p.visitado&&!p.omitido).length;return `üó∫Ô∏è Ruta "<strong>${rutaH.nombre}</strong>": <strong>${pend}</strong> visitas pendientes de ${rutaH.paradas.length}.`;}
    return `üìã <strong>${pendientes}</strong> visitas pendientes ¬∑ <strong>${visitadas}</strong> completadas.`;
  }
  if(ql.includes('stock')||ql.includes('inventar')){
    const crit=productos.filter(p=>p.stock===0);
    const bajo=productos.filter(p=>p.stock>0&&p.stock<=(p.stockMin||5));
    return `üì¶ Sin stock: <strong>${crit.length}</strong>${crit.length?': '+crit.map(p=>p.nombre).join(', '):'.'}<br>‚ö†Ô∏è Bajo: <strong>${bajo.length}</strong>${bajo.length?': '+bajo.map(p=>p.nombre).join(', '):'.'}`;
  }
  if(ql.includes('venta')||ql.includes('pedido')||ql.includes('resumen')){
    const vHoy=pedHoy.filter(p=>['completado','facturado'].includes(p.estado)).reduce((s,p)=>s+p.total,0);
    return `üìä Hoy: <strong>${pedHoy.length}</strong> pedidos ¬∑ <strong>${fmt(vHoy)}</strong>`;
  }
  if(ql.includes('ranking')||ql.includes('mejor')||ql.includes('vendedor')){
    const stats=usuarios.filter(u=>u.rol==='vendedor').map(u=>({n:u.nombre,v:pedidos.filter(p=>p.vendedor===u.nombre&&['completado','facturado'].includes(p.estado)).reduce((s,p)=>s+p.total,0)})).sort((a,b)=>b.v-a.v);
    return 'üèÜ Ranking:<br>'+stats.map((s,i)=>`${['ü•á','ü•à','ü•â'][i]||'¬∑'} ${s.n}: <strong>${fmt(s.v)}</strong>`).join('<br>');
  }
  return `‚ö†Ô∏è Sin conexi√≥n al API. Puedo responder sobre: visitas, ventas, stock, ranking. ¬øQu√© necesitas?`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MAPA DE RUTAS (Leaflet + OpenStreetMap)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _mapa = null, _mapaRutaId = null, _mapaParadaIdx = 0;
let _marcadores = [], _lineaRuta = null, _userMarker = null;
let _geocodeCache = {};

// Geocodificar direcci√≥n ‚Üí coords (Nominatim, gratis)
async function geocodificar(direccion, ciudad='Bogot√°') {
  const key = direccion + ciudad;
  if (_geocodeCache[key]) return _geocodeCache[key];
  try {
    const q = encodeURIComponent(direccion + ', ' + ciudad + ', Colombia');
    const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`, {
      headers: {'Accept-Language': 'es', 'User-Agent': 'PedidosPro/4'}
    });
    const d = await r.json();
    if (d && d[0]) {
      const coords = {lat: parseFloat(d[0].lat), lng: parseFloat(d[0].lon)};
      _geocodeCache[key] = coords;
      return coords;
    }
  } catch(e) {}
  return null;
}

// Abrir mapa de una ruta
async function abrirMapaRuta(rutaId) {
  const ruta = rutas.find(r => String(r.id) === String(rutaId));
  if (!ruta) return;
  
  _mapaRutaId = String(rutaId);
  _mapaParadaIdx = ruta.paradas.findIndex(p => !p.visitado && !p.omitido);
  if (_mapaParadaIdx < 0) _mapaParadaIdx = 0;

  document.getElementById('mapa-titulo').textContent = ruta.nombre;
  document.getElementById('mapa-modal').classList.add('open');
  // Leaflet necesita que el contenedor sea visible antes de invalidar
  setTimeout(() => { if(_mapa) _mapa.invalidateSize(); }, 100);

  // Init mapa centrado en Bogot√°
  if (!_mapa) {
    _mapa = L.map('mapa-container', {zoomControl: true}).setView([4.6097, -74.0817], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 19
    }).addTo(_mapa);
  }

  // Limpiar marcadores y l√≠nea anteriores
  _marcadores.forEach(m => _mapa.removeLayer(m));
  _marcadores = [];
  if (_lineaRuta) { _mapa.removeLayer(_lineaRuta); _lineaRuta = null; }

  // Renderizar lista de paradas
  renderMapaParadasList(ruta);

  // Geocodificar y colocar marcadores
  const coords = [];
  for (let i = 0; i < ruta.paradas.length; i++) {
    const p = ruta.paradas[i];
    let pos = null;
    
    // Usar GPS guardado del cliente si existe
    const cl = clientes.find(c => c.id === p.clienteId);
    if (cl && cl.lat) {
      pos = {lat: cl.lat, lng: cl.lng};
    } else if (p.direccion) {
      // Mostrar spinner en parada
      actualizarEstadoGeocoding(i, 'buscando');
      pos = await geocodificar(p.direccion, 'Bogot√°');
      if (pos && cl) { cl.lat = pos.lat; cl.lng = pos.lng; } // guardar en cliente
    }

    if (pos) {
      coords.push([pos.lat, pos.lng]);
      const isActiva = i === _mapaParadaIdx;
      const icon = L.divIcon({
        html: `<div style="
          width:${isActiva?34:26}px;height:${isActiva?34:26}px;
          background:${p.visitado?'#00e676':p.omitido?'#666':isActiva?'#00d4ff':'#fff'};
          border:3px solid ${p.visitado?'#00e676':p.omitido?'#555':isActiva?'#00d4ff':'#999'};
          border-radius:50%;
          color:${p.visitado||isActiva?'#000':'#333'};
          font-weight:800;font-size:${isActiva?'.8rem':'.65rem'};
          display:flex;align-items:center;justify-content:center;
          box-shadow:0 2px 8px rgba(0,0,0,.4);
          font-family:Space Grotesk,sans-serif;
        ">${p.visitado?'‚úì':p.omitido?'‚úó':(i+1)}</div>`,
        iconSize: [isActiva?34:26, isActiva?34:26],
        iconAnchor: [isActiva?17:13, isActiva?17:13],
        className: ''
      });
      const marker = L.marker([pos.lat, pos.lng], {icon})
        .addTo(_mapa)
        .bindPopup(`<b>${p.clienteNombre}</b><br><span style="font-size:.8rem;color:#666">${p.direccion}</span>${p.visitado?'<br><span style="color:green">‚úì Visitado</span>':''}`)
        .on('click', () => { _mapaParadaIdx = i; actualizarMapaParadaActiva(ruta); });
      _marcadores.push(marker);
      actualizarEstadoGeocoding(i, pos ? 'ok' : 'error');
    } else {
      _marcadores.push(null);
      actualizarEstadoGeocoding(i, 'error');
    }
  }

  // Dibujar l√≠nea de ruta
  if (coords.length > 1) {
    _lineaRuta = L.polyline(coords, {color: '#00d4ff', weight: 2.5, opacity: 0.6, dashArray: '6,6'}).addTo(_mapa);
    _mapa.fitBounds(_lineaRuta.getBounds(), {padding: [40, 40]});
  } else if (coords.length === 1) {
    _mapa.setView(coords[0], 15);
  }

  // Mostrar posici√≥n del usuario
  actualizarUserMarkerMapa();
  actualizarMapaParadaActiva(ruta);
  sp(); // guardar coords geocodificadas en clientes
}

function actualizarEstadoGeocoding(idx, estado) {
  const items = document.querySelectorAll('.mapa-parada-item');
  if (items[idx]) {
    const sub = items[idx].querySelector('.mapa-parada-dir');
    if (sub) {
      if (estado === 'buscando') sub.style.opacity = '0.4';
      else if (estado === 'error') sub.textContent += ' ‚ö†Ô∏è sin coords';
      else sub.style.opacity = '1';
    }
  }
}

function renderMapaParadasList(ruta) {
  const el = document.getElementById('mapa-paradas-list');
  el.innerHTML = ruta.paradas.map((p, i) => `
    <div class="mapa-parada-item ${p.visitado?'visitada':i===_mapaParadaIdx?'activa':''}" 
         id="mpi-${i}" onclick="abrirDetalleParada(${i})">
      <div class="mapa-parada-num ${p.visitado?'v':p.omitido?'o':''}">${p.visitado?'‚úì':p.omitido?'‚úó':(i+1)}</div>
      <div class="mapa-parada-info">
        <div class="mapa-parada-nombre">${p.clienteNombre}</div>
        <div class="mapa-parada-dir">${p.direccion||'Sin direcci√≥n'}${!p.visitado&&!p.omitido?` <span style="color:var(--orange);font-size:.6rem">‚ö† sin coords</span>`:''}` +
        `</div>
      </div>
      <span style="font-size:.8rem">${p.visitado?'‚úÖ':p.omitido?'‚è≠Ô∏è':'‚Üí'}</span>
    </div>`).join('');
}

function abrirDetalleParada(idx){
  _mapaParadaIdx = idx;
  const ruta = rutas.find(r => String(r.id) === _mapaRutaId);
  if(!ruta) return;
  const p = ruta.paradas[idx];
  if(!p) return;
  actualizarMapaParadaActiva(ruta);

  // Actualizar items activos en lista
  document.querySelectorAll('.mapa-parada-item').forEach((el,i)=>{
    el.classList.toggle('activa', i===idx && !ruta.paradas[i].visitado);
  });

  // Mostrar panel de detalle
  const visitadoHtml = p.visitado
    ? `<div style="background:rgba(0,230,118,.1);border:1px solid rgba(0,230,118,.3);border-radius:.65rem;padding:.6rem;text-align:center;color:var(--green);font-weight:700">‚úÖ Visita ya registrada</div>`
    : `<button class="btn btn-success btn-full" onclick="marcarVisitaDesdeMapaActual()" style="font-size:.95rem;padding:.75rem">‚úì Registrar visita</button>`;

  document.getElementById('mapa-detalle-content').innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem">
      <div>
        <div style="font-weight:700;font-size:.95rem">${p.clienteNombre}</div>
        <div style="font-size:.72rem;color:var(--muted);margin-top:.1rem">üìç ${p.direccion||'Sin direcci√≥n'}</div>
      </div>
      <button onclick="cerrarDetalleParada()" style="background:var(--card);border:1px solid var(--border);border-radius:.4rem;padding:.25rem .55rem;color:var(--muted);cursor:pointer">‚úï</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:.5rem">
      ${visitadoHtml}
      <button class="btn btn-primary btn-full" onclick="tomarPedidoDesdeMapaActual()" style="font-size:.95rem;padding:.75rem">üõí Tomar pedido</button>
      <div style="display:flex;gap:.5rem">
        <button class="btn btn-secondary" style="flex:1" onclick="navegarActual()">üß≠ Navegar</button>
        <button class="btn btn-secondary" style="flex:1" onclick="toggleEvidenciaMapa()">üì∏ Evidencia</button>
        ${!p.omitido&&!p.visitado?`<button class="btn btn-danger" style="flex:1" onclick="omitirParadaActual()">‚è≠ Omitir</button>`:''}
      </div>
    </div>
  `;
  document.getElementById('mapa-detalle-panel').style.display='block';
  document.getElementById('mapa-detalle-overlay').style.display='block';
}

function cerrarDetalleParada(){
  document.getElementById('mapa-detalle-panel').style.display='none';
  document.getElementById('mapa-detalle-overlay').style.display='none';
}

function omitirParadaActual(){
  const ruta=rutas.find(r=>String(r.id)===_mapaRutaId);
  if(!ruta)return;
  ruta.paradas[_mapaParadaIdx].omitido=true;
  sp();
  cerrarDetalleParada();
  renderMapaParadasList(ruta);
  paradaSiguiente();
}

function seleccionarParadaMapa(idx) {
  const ruta = rutas.find(r => String(r.id) === _mapaRutaId);
  if (!ruta) return;
  _mapaParadaIdx = idx;
  actualizarMapaParadaActiva(ruta);
  // Scroll a parada en lista
  const item = document.getElementById('mpi-' + idx);
  if (item) item.scrollIntoView({behavior:'smooth', block:'nearest'});
}

function actualizarMapaParadaActiva(ruta) {
  const p = ruta.paradas[_mapaParadaIdx];
  if (!p) return;
  
  document.getElementById('mapa-subtitulo').textContent = 
    `Parada ${_mapaParadaIdx+1}/${ruta.paradas.length} ¬∑ ${p.clienteNombre}`;
  
  const btnMarcar = document.getElementById('btn-marcar-visita');
  if (btnMarcar) {
    if (p.visitado) {
      btnMarcar.textContent = '‚úì Ya visitado';
      btnMarcar.style.background = 'var(--green)';
      btnMarcar.disabled = true;
    } else {
      btnMarcar.textContent = '‚úì Marcar visitado';
      btnMarcar.style.background = '';
      btnMarcar.disabled = false;
    }
  }

  // Actualizar items activos en lista
  document.querySelectorAll('.mapa-parada-item').forEach((el, i) => {
    el.classList.toggle('activa', i === _mapaParadaIdx && !ruta.paradas[i].visitado);
  });

  // Centrar mapa en parada activa
  const marker = _marcadores[_mapaParadaIdx];
  if (marker) {
    _mapa.setView(marker.getLatLng(), 16, {animate: true});
    marker.openPopup();
  }
}

function actualizarUserMarkerMapa() {
  if (!userPos || !_mapa) return;
  const latlng = [userPos.lat, userPos.lng];
  if (_userMarker) {
    _userMarker.setLatLng(latlng);
  } else {
    const icon = L.divIcon({
      html: `<div style="width:16px;height:16px;background:#00d4ff;border:3px solid #fff;border-radius:50%;box-shadow:0 0 12px rgba(0,212,255,.8)"></div>`,
      iconSize: [16,16], iconAnchor: [8,8], className:''
    });
    _userMarker = L.marker(latlng, {icon, zIndexOffset:1000}).addTo(_mapa);
  }
}

function paradaSiguiente() {
  const ruta = rutas.find(r => String(r.id) === _mapaRutaId);
  if (!ruta) return;
  // Buscar pr√≥xima no visitada
  let next = _mapaParadaIdx + 1;
  while (next < ruta.paradas.length && ruta.paradas[next].omitido) next++;
  if (next < ruta.paradas.length) { _mapaParadaIdx = next; actualizarMapaParadaActiva(ruta); }
  const item = document.getElementById('mpi-' + _mapaParadaIdx);
  if (item) item.scrollIntoView({behavior:'smooth', block:'nearest'});
}

function paradaAnterior() {
  const ruta = rutas.find(r => String(r.id) === _mapaRutaId);
  if (!ruta) return;
  let prev = _mapaParadaIdx - 1;
  while (prev >= 0 && ruta.paradas[prev].omitido) prev--;
  if (prev >= 0) { _mapaParadaIdx = prev; actualizarMapaParadaActiva(ruta); }
  const item = document.getElementById('mpi-' + _mapaParadaIdx);
  if (item) item.scrollIntoView({behavior:'smooth', block:'nearest'});
}

async function marcarVisitaDesdeMapaActual() {
  const ruta = rutas.find(r => String(r.id) === _mapaRutaId);
  if (!ruta) return;
  const p = ruta.paradas[_mapaParadaIdx];
  if (!p || p.visitado) return;

  // Mostrar estado de captura en el panel de detalle
  const btnDetalle = document.querySelector('#mapa-detalle-content .btn-success');
  if(btnDetalle){btnDetalle.textContent='‚è≥ Capturando GPS...';btnDetalle.disabled=true;}
  const btn = document.getElementById('btn-marcar-visita');
  if (btn) { btn.textContent = '‚è≥ Capturando GPS...'; btn.disabled = true; }

  let pos = userPos;
  try { pos = await getGPS(); } catch(e) {}

  const ri = rutas.findIndex(r => String(r.id) === _mapaRutaId);
  rutas[ri].paradas[_mapaParadaIdx].visitado = true;
  rutas[ri].paradas[_mapaParadaIdx].visitadoTs = Date.now();
  rutas[ri].paradas[_mapaParadaIdx].visitadoHora = new Date().toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'});
  rutas[ri].paradas[_mapaParadaIdx].gps = pos;
  rutas[ri].paradas[_mapaParadaIdx].gpsStr = pos ? `${pos.lat.toFixed(5)},${pos.lng.toFixed(5)}` : null;
  sp();

  mostrarSyncToast(`‚úÖ Visita registrada${pos?' con GPS üìç':''}`, 2500);
  cerrarDetalleParada();

  // Refrescar mapa
  renderMapaParadasList(ruta);
  actualizarMapaParadaActiva(ruta);
  if (_marcadores[_mapaParadaIdx]) {
    const icon = L.divIcon({
      html: `<div style="width:26px;height:26px;background:#00e676;border:3px solid #00e676;border-radius:50%;color:#000;font-weight:800;font-size:.65rem;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.4);font-family:Space Grotesk,sans-serif;">‚úì</div>`,
      iconSize:[26,26], iconAnchor:[13,13], className:''
    });
    _marcadores[_mapaParadaIdx].setIcon(icon);
  }
  setTimeout(() => paradaSiguiente(), 600);
}

function navegarActual() {
  const ruta = rutas.find(r => String(r.id) === _mapaRutaId);
  if (!ruta) return;
  const p = ruta.paradas[_mapaParadaIdx];
  if (!p) return;
  const cl = clientes.find(c => c.id === p.clienteId);
  let url = '';
  if (cl && cl.lat) {
    url = `https://www.google.com/maps/dir/?api=1&destination=${cl.lat},${cl.lng}&travelmode=driving`;
  } else if (p.direccion) {
    url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.direccion+', Bogot√°, Colombia')}&travelmode=driving`;
  } else {
    alert('Sin direcci√≥n disponible para navegar'); return;
  }
  window.open(url, '_blank');
}

function cerrarMapa() {
  document.getElementById('mapa-modal').classList.remove('open');
  cerrarDetalleParada();
  if (document.getElementById('page-rutas').classList.contains('active')) renderRutas();
}

function enrutarZonaCompleta() {
  const ruta = rutas.find(r => String(r.id) === _mapaRutaId);
  if (!ruta || !ruta.paradas || ruta.paradas.length === 0) {
    alert('No hay paradas en esta ruta'); return;
  }
  // Obtener paradas pendientes con direcci√≥n o coords
  const pendientes = ruta.paradas.filter(p => !p.visitado);
  const todas = pendientes.length > 0 ? pendientes : ruta.paradas;
  
  // Construir waypoints para Google Maps
  const puntos = todas.map(p => {
    const cl = clientes.find(c => c.id === p.clienteId);
    if (cl && cl.lat) return `${cl.lat},${cl.lng}`;
    const dir = p.direccion || (cl && cl.direccion) || '';
    if (dir) return encodeURIComponent(dir + ', Bogot√°, Colombia');
    return null;
  }).filter(Boolean);

  if (puntos.length === 0) { alert('No hay direcciones disponibles para enrutar'); return; }

  let url = '';
  if (puntos.length === 1) {
    url = `https://www.google.com/maps/dir/?api=1&destination=${puntos[0]}&travelmode=driving`;
  } else {
    const destino = puntos[puntos.length - 1];
    const waypoints = puntos.slice(0, -1).join('|');
    url = `https://www.google.com/maps/dir/?api=1&destination=${destino}&waypoints=${waypoints}&travelmode=driving`;
  }
  window.open(url, '_blank');
}

function tomarPedidoDesdeMapaActual(){
  const ruta=rutas.find(r=>String(r.id)===_mapaRutaId);
  if(!ruta)return;
  const p=ruta.paradas[_mapaParadaIdx];
  if(!p)return;
  window._pedidoRutaCtx={rutaId:_mapaRutaId,idx:_mapaParadaIdx};
  const cl=clientes.find(c=>c.id===p.clienteId);
  if(cl){
    pedidoCliente={id:cl.id,nombre:cl.nombre,telefono:cl.telefono||'',direccion:p.direccion||cl.direccion||'',nota:p.nota||'',ciudad:cl.ciudad||''};
  } else {
    pedidoCliente={id:null,nombre:p.clienteNombre,telefono:p.telefono||'',direccion:p.direccion||'',nota:p.nota||'',ciudad:''};
  }
  carrito={};
  pedidoStepNum=2; // Directo a productos, saltando selecci√≥n de cliente
  cerrarDetalleParada();
  cerrarMapa();
  goTab('nuevo');
  // Forzar ir al step 2 (productos) despu√©s de render
  setTimeout(()=>pedidoStep(2),100);
}

function toggleEvidenciaMapa(){
  const ruta=rutas.find(r=>String(r.id)===_mapaRutaId);
  if(!ruta)return;
  abrirEvidencia(_mapaRutaId,_mapaParadaIdx);
}


// Abrir mapa para un cliente individual (desde ficha)
function abrirMapaClienteIndividual(clienteId) {
  const cl = clientes.find(c => c.id === clienteId);
  if (!cl) return;
  
  // Buscar si el cliente est√° en alguna ruta activa del vendedor
  const rutaActiva = rutas.find(r =>
    r.estado === 'en_curso' &&
    (session.rol==='admin'||session.rol==='super'||r.vendedor===session.nombre) &&
    r.paradas.some(p => p.clienteId === clienteId)
  );
  
  if (rutaActiva) {
    closeClienteModal();
    const idx = rutaActiva.paradas.findIndex(p => p.clienteId === clienteId);
    setTimeout(() => {
      abrirMapaRuta(rutaActiva.id);
      setTimeout(() => seleccionarParadaMapa(idx), 800);
    }, 200);
    return;
  }
  
  // Sin ruta activa: abrir Google Maps directamente
  let url = '';
  if (cl.lat) {
    url = `https://www.google.com/maps/dir/?api=1&destination=${cl.lat},${cl.lng}&travelmode=driving`;
  } else if (cl.direccion) {
    url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(cl.direccion+', Bogot√°, Colombia')}&travelmode=driving`;
  } else {
    alert('Sin direcci√≥n ni GPS registrado para este cliente');
    return;
  }
  window.open(url, '_blank');
}

// Actualizar GPS del usuario en el mapa si est√° abierto
// Extender startGPS para actualizar el marcador del mapa en tiempo real
const _watchMapaGPS = () => {
  if (!navigator.geolocation) return;
  navigator.geolocation.watchPosition(pos => {
    userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy, ts: Date.now()};
    if (_mapa) actualizarUserMarkerMapa();
  }, null, {enableHighAccuracy: true, maximumAge: 10000});
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderLogin();

// Service Worker registration for PWA
if('serviceWorker' in navigator){
  const swCode=`
self.addEventListener('install',e=>self.skipWaiting());
self.addEventListener('activate',e=>clients.claim());
self.addEventListener('fetch',e=>{
  if(e.request.mode==='navigate'){e.respondWith(fetch(e.request).catch(()=>caches.match('/')));}
});`;
  const blob2=new Blob([swCode],{type:'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob2)).catch(()=>{});
}
</script>
</body>
</html>
